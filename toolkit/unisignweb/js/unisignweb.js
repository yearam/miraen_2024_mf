var UnisignWebEngine=function(x,Ga){function ab(){eval(J({eval:!1,intergrity:!0,name:"browsersign",url:"unisignweb/js/browsersign.js"}));return eval("__crosscertlocalstorage")(a)}function xb(){eval(J({eval:!1,intergrity:!0,name:"cloudsign",url:"unisignweb/js/cloudsign.js"}));return eval("__crosscertcloudsign")(a)}function yb(){eval(J({eval:!1,intergrity:!0,name:"whale",url:"unisignweb/js/whale.js"}));return eval("__crosscertwhale")(a)}function zb(){Ab.forEach(function(a){J(a)})}function J(a){var b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",u.SRCPath+a.url+"?version=1.0.4.29",!1);b.send(null);if(200==b.status){if(!0===a.intergrity){var d={};d.name=a.name+".js";d.data=b.responseText;Y[bb++]=d}return null==a.eval||1==a.eval?eval(b.responseText):b.responseText}404!=b.status&&(N=!1);return null}function Bb(b,c){var d=a.loadUI("cloudconnect")({type:"connect",onConfirm:function(a){d.dispose();b(a.name,a.hp,a.birth,a.autoConn)},onCancel:function(){d.dispose();c("cancel")}});d.show()}function Cb(b,c){b.setAttribute("src",c+"?moduleType=web");b.setAttribute("width","600px");b.setAttribute("height","650px");b.style.position="fixed";b.style.top=0;b.style.left=0;try{b.style.zIndex=a.ESVS.zIndex+a.uiLayerLevel}catch(d){cb.log("UI_JOIN error"+d)}b.style.margin="10% 10%";b.style.border="1px solid";return b}function Db(b,c,d,e,g){var f=a.loadUI("cloudconnect")({type:"mo",args:{authCode:b,authCodeTime:c,authStatus:d},onConfirm:function(a){f.dispose();a.err?g(a.err.errMsg):e()},onCancel:function(){f.dispose()}});f.show()}function n(b,c){var d={};d.resultCode=b?b:0;d.resultMessage=c?c:"";d.jsonSignedData="";d.certAttrs="";d.certIndex="";d.b64RValue="";d.hashValue="";d.encryptedData="";d.decryptedData="";d.signedData="";d.theCert="";d.theDN="";d.thePri="";d.kmCert="";d.kmPri="";d.pfx="";d.curDrive="";d.curDevice="";d.tokenLabel="";d.password="";d.pin="";d.mac="";a.ERROR.Code=b;a.ERROR.Message=c;return d}function C(b,c){var d={};d.resultCode=b?b:0;0!=d.resultCode&&a.uiUtil().getErrorMessageLang().IDS_CLOUD_ERROR[b]?d.resultMessage=a.uiUtil().getErrorMessageLang().IDS_CLOUD_ERROR[b]:d.resultMessage=c?c:"";d.jsonSignedData="";d.certAttrs="";d.certIndex="";d.b64RValue="";d.hashValue="";d.encryptedData="";d.decryptedData="";d.signedData="";d.theCert="";d.theDN="";d.thePri="";d.kmCert="";d.kmPri="";d.pfx="";d.curDrive="";d.curDevice="";d.tokenLabel="";d.password="";d.pin="";d.mac="";a.ERROR.Code=b;a.ERROR.Message=c;return d}function ra(b){return"1.2.840.113549.1.1.5"==b.signatureOid||"1.2.410.200004.1.9"==b.signatureOid?a.usWebToolkit.md.sha1.create():"1.2.840.113549.1.1.4"==b.signatureOid?a.usWebToolkit.md.md5.create():"1.2.840.113549.1.1.11"==b.signatureOid||"1.2.840.113549.1.1.10"==b.signatureOid?a.usWebToolkit.md.sha256.create():null}function O(b,c,d,e,g,f,h,k,m,l,t){if(b)db(0,b,c,d,e,g,f,h,k,m,l,t);else{var q=a.loadUI("ssn")({type:null,onConfirm:function(a){db(1,a,c,d,e,g,f,h,k,m,l,t);q.dispose()},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();m(n(a.ERROR.Code,a.ERROR.Message));q.dispose();ClearAllUserCertList()}});q.show()}}function db(b,c,d,e,g,f,h,k,m,l,t,q){a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_VID_VERIFY_MESSAGE);var r=n();r.certAttrs=f;r.curDevice=h;r.tokenLabel=k;null!=m&&h==a.CONST.__USFB_M_HSMKEY.device&&(r.tokenName=m.name,r.tokenDriver=m.driver);if("undefined"!==typeof d&&"undefined"!==typeof e)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(h))if(h!=a.CONST.__USFB_M_DISK.device&&h!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(h==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");b=a.usWebToolkit.pki.certificateFromBase64(q);t=a.usWebToolkit.util.decode64(t);var p=a.usWebToolkit.pkcs8.verifyVIDForHSM(t,c,b);p?(r.signedData=g,l(r)):(a.ERROR.Code=14208,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID,l(n(14208,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)))}else a.nimservice()?a.nimservice().VerifyVID(d,e,b,c,function(b,d){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?(r.signedData=g,l(r)):(4305E4==b&&(b=14208),a.ERROR.Code=b,a.ERROR.Message=d,l(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)))}):(a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_MSGBOX_NIM_ERROR_UNLOAD,a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"),l(n(a.ERROR.Code,a.ERROR.Message)),ClearAllUserCertList());else a.Whale().verifyVID(d,e,c,function(b,d){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?(r.signedData=g,l(r)):(3061==b&&(b=14208),a.ERROR.Code=b,a.ERROR.Message=d,l(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)))});else{a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");try{var v=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[d].signcert),w=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[d].signpri);p=a.usWebToolkit.pkcs8.verifyVID(w,e,c,v);e=c="";p?(r.signedData=g,l(r)):(a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_MSGBOX_VID_ERROR_VERIFICATION,l(n(a.ERROR.Code,a.ERROR.Message)))}catch(z){e=c="",a.ERROR.Code=z.code,a.ERROR.Message=z.message,l(n(z.code,z.message))}e=c=""}}function ma(b,c,d,e,g,f,h){function k(d){var c="",e;for(e in b)""!=b[e]&&(c+=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b[e])),c+="|");a.Whale().normalizeXML(c,function(c,e,g){if(0!=c)a.ERROR.Code=c,a.ERROR.Message=e,a.uiUtil().loadingBox(!1,"us-div-list-load"),d(n(c,e));else{c=g.split("|");e={};g=0;for(var f in b)e[f]=""==b[f]?"":c[g++];d(e)}})}var m=n();if("undefined"!==typeof d&&"undefined"!==typeof e){var l={},t=0;"sha256WithRSAEncryption"!=c.signAlgo&&(t=1);var q=J({eval:!0,intergrity:!1,name:"xml_template_"+u.Language,url:"unisignweb/rsrc/lang/"+u.Language+"/xml_template_"+u.Language+".js"}),r="sha1";1!=t&&(r="sha256");k(function(k){for(var p in k)if(!(null==k[p]||0>=k[p].length||"undefined"==k[p]||"undefined"==b[p])){var w=k[p].split(";"),z={};z.key=p;z.plainText=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(w[0]));var B=a.usWebToolkit.md.algorithms[r].create();B.start();B.update(a.usWebToolkit.util.decode64(w[1]));w=a.usWebToolkit.util.encode64(B.digest().getBytes());z.Signature=q.XMLSignatureTemplate[t].replace("$$DV$$",w);z.SignedInfo=q.XMLSignedInfoTemplate[t].replace("$$DV$$",w);z.Signature=z.Signature.replace("$$Cert$$",g);b[p]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(z.SignedInfo));l[p]=z}a.Whale().getSignDataP1(b,d,e,function(b,g,k){m.resultCode=b;m.resultMessage=g;if(0!=b)a.ERROR.Code=b,a.ERROR.Message=g,h(m);else{"string"==typeof k&&(k=[k]);for(var r in k)""!=k[r]&&(l[r].Signature=l[r].Signature.replace("$$Sign$$",k[r]),b=l[r].plainText.substr(0,l[r].plainText.indexOf(q.KEY_START)),b+=l[r].Signature,b+=l[r].plainText.substr(l[r].plainText.indexOf(q.KEY_START),l[r].plainText.length),k[r]=b);m.signedData=k;m.certAttrs=c;m.tokenLabel="";f?a.Whale().getCertR(d,e,function(b,d,c){a.uiUtil().loadingBox(!1,"us-div-list-load",1);if(0==b)try{var e=a.usWebToolkit.util.hexToBytes(c),g=a.usWebToolkit.pki.certificateFromBase64(f),k=a.usWebToolkit.pkcs7.createEnvelopedData();k.addRecipient(g);k.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];k.content=e;k.encrypt();m.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(k);h(m)}catch(Eb){h(m)}else h(m)}):h(m)}})})}else h(null);return!0}function eb(b){try{var c=a.PFSH.GetP12ForBuToPc(1,b,"binary"),d=c.p12,e=a.certUtil().getCN(c.dn);e+=".p12";a.fileUtil().save(e,d)}catch(g){alert("failure\nerr code : "+g.code+"\nerr msg : "+g.message)}}function fb(){var b=null,c=null,d=null;try{b=a.PFSH.GetP12ForBuToMo(1,"hex"),c=b.key,d=b.p12}catch(f){alert("failure\nerr code : "+f.code+"\nerr msg : "+f.message);return}try{b="default";"android"===a.osName?"android samsung"===a.browserName||"android lg"===a.browserName||"android browser"===a.browserName?b="default":"android chrome"===a.browserName&&(b="chrome"):"ios"==a.osName&&("ios safari"===a.browserName?b="default":"ios chrome"===a.browserName&&(b="googlechrome"));var e=window.location.href.split(/[?#]/)[0],g=e.lastIndexOf("/");e=e.substr(0,g+1)+a.ESVS.SRCPath+"unisignweb/rsrc/layout/mobile/w2a/m_exportcertresult.html";UniSignW2A.backupStore(e,b,d,c,"0","recall")}catch(f){alert("failure\ne : "+f)}}function gb(b){try{a.CCPFSH().GetP12ForBuToPc(1,b,"base64",function(b,d,e,g){b=a.usWebToolkit.util.decode64(g);d=Array(b.length);for(g=0;g<b.length;g++)d[g]=b.charCodeAt(g);b=new Uint8Array(d);e=a.certUtil().getCN(e);e+=".p12";a.fileUtil().save(e,b)})}catch(c){alert("failure\nerr code : "+c.code+"\nerr msg : "+c.message)}}function hb(){var b=null,c=null;a.CCPFSH().GetP12ForBuToMo(1,"base64",function(d,e,g,f){if(0==d){b=g;d=a.usWebToolkit.util.decode64(f);c=crosscert.util.bytesToHex(d);try{d="default";"android"===a.osName?"android samsung"===a.browserName||"android lg"===a.browserName||"android browser"===a.browserName?d="default":"android chrome"===a.browserName&&(d="chrome"):"ios"==a.osName&&("ios safari"===a.browserName?d="default":"ios chrome"===a.browserName&&(d="googlechrome"));var h=window.location.href.split(/[?#]/)[0],k=h.lastIndexOf("/");h=h.substr(0,k+1)+a.ESVS.SRCPath+"unisignweb/rsrc/layout/mobile/w2a/m_exportcertresult.html";UniSignW2A.backupStore(h,d,c,b,"0","recall")}catch(m){alert("failure\ne : "+m)}}else alert("failure\nerr code : "+d+"\nerr msg : "+e)})}function D(b,c,d,e,g){a.SELECTINFO={index:b,pw:c,curdevice:d,cert:e,certattrs:g}}function ib(a,c){var b={errCode:0,errMsg:""};a&&"object"==typeof a&&c||(b.errCode=-1,b.errMsg="No Data");var e=null;try{e=crosscert.pki.certificateFromBase64(a.signcert)}catch(k){b.errCode=k.code,b.errMsg=k.message}var g=null;try{g=crosscert.pkcs8.encryptedPrivateKeyFromBase64(a.signpri)}catch(k){b.errCode=k.code,b.errMsg=k.message}var f=null,h=null;if(a.kmcert){try{f=crosscert.pki.certificateFromBase64(a.kmcert)}catch(k){b.errCode=k.code,b.errMsg=k.message}try{h=crosscert.pkcs8.encryptedPrivateKeyFromBase64(a.kmpri)}catch(k){b.errCode=k.code,b.errMsg=k.message}}try{p12=crosscert.pkcs12.makePKCS12FromCertNEncPKCS8(e,g,f,h,c,{useMac:!0,generateLocalKeyId:!0,count:1024})}catch(k){b.errCode=k.code,b.errMsg=k.message}try{strP12=crosscert.util.encode64(crosscert.asn1.toDer(p12).getBytes()),b.pfx=strP12}catch(k){b.errCode=k.code,b.errMsg=k.message}return b}function jb(b,c,d,e,g,f){if(!b)return null;var h=n();if(-1==b){var k=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_EXT_DISABLE_SECTOKEN",args:{dn:null,possibleWhale:!1},onConfirm:function(b,c,d,g,r){g==a.CONST.__PF_M_SS.device?(b=ib(a.PFUC[c],a.usWebToolkit.util.decode64(e)),h.resultCode=b.errCode,h.resultMessage=b.errMsg,h.pfx=b.pfx,f(h)):a.nimservice()&&a.nimservice().ExportCertEx(g,r,c,e,d,function(a,b,c){h.resultCode=a;h.resultMessage=b;h.pfx=c;f(h)});setTimeout(function(){k.dispose()},10)},onCancel:function(b){k.dispose(!0);b?h.resultCode=-2:a.uiUtil().getUserCancelErrCodeNMsg(h);f(h)}});k.show()}else c==a.CONST.__PF_M_SS.device?(b=ib(a.PFUC[b],a.usWebToolkit.util.decode64(e)),h.resultCode=b.errCode,h.resultMessage=b.errMsg,h.pfx=b.pfx,f(h)):a.nimservice().ExportCertEx(c,d,b,e,g,function(a,b,c){h.resultCode=a;h.resultMessage=b;h.pfx=c;f(h)})}function Fb(b,c,d){try{var e=a.usWebToolkit.asn1.fromDer(a.usWebToolkit.util.decode64(b)),g=a.usWebToolkit.pkcs12.getCertNKeyFromPKCS12WithEncPKCS8(e,a.usWebToolkit.util.decode64(c)).getCertAndKeyFromPKCS12(a.usWebToolkit.util.decode64(c)),f={};f.signcert=a.usWebToolkit.pki.certificateToBase64(g.sign.cert);f.signpri=a.usWebToolkit.pkcs8.encryptedPrivateKeyToBase64(g.sign.prikey);g.km&&(f.kmcert=a.usWebToolkit.pki.certificateToBase64(g.km.cert),f.kmpri=a.usWebToolkit.pkcs8.encryptedPrivateKeyToBase64(g.km.prikey));a.usWebToolkit.x509Certificate.parser(f.signcert,"Base64");var h=a.usWebToolkit.x509Certificate.getCertificatePoliciesOid(),k=a.certUtil().getIssuerEnName(h);a.CCPFSH().GetCCStorageHandler(a.ESVS.EncAlgo,a.ESVS.HashAlgo,a.ESVS.BSPKI,function(b,c){0==b?a.CCPFSH().SaveUserCert(k,f,!0,function(b){0==b?d(n(b,"")):d(n(b,a.transferLang().IDS_ERR_SAVING))}):d(n(b,a.transferLang().IDS_ERR_SAVING))})}catch(m){d(n(m.code,m.message))}}function kb(b,c,d,e,g,f,h){if(1>d||0>e)return-1;d==a.CONST.__PF_M_SS.device?Fb(b,c,function(a){h(a)}):a.nimservice().ImportCertEx(d,e,g,f,b,c,function(a,b){h(n(a,b))});return-1}function lb(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b)return!1;var d=n();a.reInitialize();Dialog=a.loadUI("storageselect")({type:"CERT_STORAGE",args:{possibleWhale:!1},onConfirm:function(e,g){Dialog.dispose();2===e||3===e?(PWDialog=a.loadUI("password")({type:null,args:null,onConfirm:function(f){PWDialog.dispose();var h=null;h=2===e?"PIN_SECURITY_TOKEN":"PIN_SAVE_TOKEN";PINDialog=a.loadUI("pin")({type:h,args:null,onConfirm:function(a){PINDialog.dispose();d.curDevice=e;d.curDrive=g;d.password=f;d.pin=a;b(d);f=null},onCancel:function(){PINDialog.dispose();f=null;a.uiUtil().getUserCancelErrCodeNMsg();c&&c()}});PINDialog.show()},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();c&&c()}}),PWDialog.show()):(d.curDevice=e,d.curDrive=g,d.password=null,d.pin=null,b(d))},onCancel:function(){Dialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();c&&c()}});Dialog.show()}}function Gb(b,c,d,e,g,f){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!c&&!d||document.getElementById("us-div-cert-select")||!g)return!1;var h=n();b||(b="DIGITAL_SIGNATURE_P7_EXT");a.reInitialize();var k=a.loadUI("certselect")({type:b,args:{dn:e,possibleWhale:!1},onConfirm:function(b,c,e,f,r){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(r))a.nimservice()?a.nimservice().GetSignDataP7(c,e,d,T,!0,null,!0,!1,function(b,d,p,l,m,v){0!=b?(a.ERROR.Code=h.resultCode=b,a.ERROR.Message=h.resultMessage=d,a.uiUtil().errMsgBox(d,a.ERROR.Code)):(h.signedData=p,h.certIndex=c,h.password=e,h.curDevice=f,h.curDrive=r,h.tokenLabel=v);g(h);a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k.dispose()},10)}):(setTimeout(function(){k.dispose(!0)},10),g(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)));else try{var p=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[c].signcert),l=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[c].signpri),m=a.usWebToolkit.pkcs7.createSignedData(),q=a.usWebToolkit.util.decode64(d);m.signForTransfer(q,p,l,e);h.signedData=a.usWebToolkit.pkcs7.messageToBase64(m);h.certIndex=c;h.password=e;h.curDevice=f;h.curDrive=r;h.tokenLabel="";setTimeout(function(){k.dispose(!0)},10);g(h)}catch(B){a.ERROR.Code=B.code,a.ERROR.Message=B.message,112047==B.code&&(a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD),setTimeout(function(){k.dispose(!0)},10),g(n(B.code,B.message))}},onCancel:function(b){k.dispose(!0);b?h.resultCode=-2:a.uiUtil().getUserCancelErrCodeNMsg(h);g(h)}});k.show();return!0}}function Q(b,c,d){!Ia||c==a.CONST.__USFB_M_MOBILE.device||c==a.CONST.__USFB_M_MOBILETOKEN.device||a.uiUtil().isItPFDevice(c)?d({rv:0,rvMsg:""}):a.nimservice().VerifyCertificate(b,1,function(b,c){if(0!=b)if("MPKI"!=a.ESVS.PKI)switch(b){case 3001:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_INVALID_TYPE;break;case 3002:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_DECODING_FAIL;break;case 3003:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_LOADING_FAIL;break;case 3005:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_EXPIRED;break;case 3009:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_NO_DP;break;case 3010:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_WRONG_DP;break;case 3013:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_WRONG_CRL+" Code [ "+b+" ]";break;case 3014:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_EXPIRED_CRL;break;case 3015:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_WRONG_CRL+" Code [ "+b+" ]";break;case 3016:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_HOLDED+" Code [ "+b+" ]";break;case 3017:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED+" Code [ "+b+" ]";break;case 3059:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_GETTING_CRL_FROM_LDAP_FAIL;break;case 3060:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_CHECKING_ISSUER_FAIL;break;case 3062:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_CA_CERT_PATH;break;case 3063:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_ROOTCA_CERT_PATH;break;case 3900:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED_UNSUPERSEDED;break;case 3901:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED_KEYCOMPROMISE;break;case 3902:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED_CACOMPROMISE;break;case 3903:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED_AFFILIATIONCHANGED;break;case 3904:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED_SUPERSEDED;break;case 3905:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED_CESSATIONOFOPERATION;break;case 3906:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED_HOLD;break;case 3907:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED_REMOVEFROMCRL;break;case 3908:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED+" Code [ "+b+" ]";break;case 3909:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED+" Code [ "+b+" ]";break;case 3999:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED+" Code [ "+b+" ]";break;default:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_UNKNOWN+" Code [ "+b+" ]"}else switch(b){case 3001:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_INVALID_TYPE;break;case 3002:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_DECODING_FAIL;break;case 3003:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_LOADING_FAIL;break;case 3005:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_EXPIRED;break;case 3009:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_NO_DP;break;case 3010:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_WRONG_DP;break;case 3013:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_WRONG_CRL+" Code [ "+b+" ]";break;case 3014:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_EXPIRED_CRL;break;case 3015:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_WRONG_CRL+" Code [ "+b+" ]";break;case 3059:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_GETTING_CRL_FROM_LDAP_FAIL;break;case 3060:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_CHECKING_ISSUER_FAIL;break;case 3062:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_CA_CERT_PATH;break;case 3063:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_ROOTCA_CERT_PATH;break;case 3016:case 3017:case 3900:case 3901:case 3902:case 3903:case 3904:case 3905:case 3906:case 3907:case 3908:case 3909:case 3999:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_REVOKED+" Code [ "+b+" ]";break;case 4212E4:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_EXPIRED+" Code [ "+b+" ]";break;default:c=a.certVerifylang().IDS_VERIFY_CERT_ERROR_UNKNOWN+" Code [ "+b+" ]"}else c="";d({rv:b,rvMsg:c})})}function sa(b,c,d,e,g,f,h,k,m,l,t){var q={},r=n();if("undefined"!==typeof e&&"undefined"!==typeof g)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(f))if(f!=a.CONST.__USFB_M_DISK.device&&f!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(f==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){var p={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(d){d=JSON.parse(d);if(0!=d.returnObj.returnCode&&"E1000"!=d.returnObj.returnCode)r.resultMessage=a.ERROR.Message=d.returnObj.returnMsg,r.resultCode=a.ERROR.Code=d.returnObj.returnCode,setTimeout(function(){k.dispose(!0)},10),t(r);else if("E1000"==d.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(r),setTimeout(function(){k.dispose(!0)},10),t(r);else{var p=d.signResult.b64Signer;_certAttrs=a.certUtil().getTheCertAttributes(p,"Base64");D(e,g,f,p,_certAttrs);r.certAttrs=_certAttrs;var l=d.signResult.b64SignedData;p=a.usWebToolkit.pki.certificateFromBase64(p);if(1==l.length){var m=d.signResult.b64SignedData[0];m=a.usWebToolkit.util.decode64(m);var v=a.usWebToolkit.pkcs7.createSignedData();v.signWithHashDataNP1(m,a.usWebToolkit.util.decode64(b),c.toLowerCase(),p);r.jsonSignedData=a.usWebToolkit.pkcs7.messageToBase64(v)}else{l=0;r.jsonSignedData={};for(var q in b)""==b[q]?r.jsonSignedData[q]="":(m=d.signResult.b64SignedData[l++],m=a.usWebToolkit.util.decode64(m),v=a.usWebToolkit.pkcs7.createSignedData(),v.signWithHashDataNP1(m,a.usWebToolkit.util.decode64(b[q]),c.toLowerCase(),p),r.jsonSignedData[q]=a.usWebToolkit.pkcs7.messageToBase64(v))}if(h)try{var w=a.usWebToolkit.util.decode64(d.signResult.R[0]),B=a.usWebToolkit.pki.certificateFromBase64(h),n=a.usWebToolkit.pkcs7.createEnvelopedData();n.addRecipient(B);n.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];n.content=w;n.encrypt();r.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(n)}catch(Hb){}r.curDevice=f;r.tokenLabel="";t(r);setTimeout(function(){k.dispose()},10)}},multisignYn:"Y",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]};if("object"==typeof b){p.multisignYn="Y";for(var v in b)if(""!=b[v]){var w=a.usWebToolkit.util.bytesToHex(a.usWebToolkit.util.decode64(b[v]));p.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+w))}}else p.multisignYn="N",w=a.usWebToolkit.util.bytesToHex(a.usWebToolkit.util.decode64(b)),p.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+w));jSmartCertNP.SignByJSON(p).Open()}else a.nimservice()?Q(e,f,function(p){if(0!=p.rv)a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=p.rv,a.ERROR.Message=p.rvMsg,setTimeout(function(){k&&k.dispose()},10),t(n(a.ERROR.Code,a.ERROR.Message));else{p=0;var v=[];if(b)for(var w in b)v[p]=b[w],p++;m=1==m?1:0;a.nimservice().GetSignDataP7WithHash(e,g,c,v,T,!1,h,a.ESVS.multiuse,m,function(c,h,p,m,v,w){if(0!=c)a.ERROR.Code=c,a.ERROR.Message=h,a.uiUtil().errMsgBox(h,a.ERROR.Code),t(n(a.ERROR.Code,a.ERROR.Message));else{c=0;if("object"==typeof p)for(var A in b)q[A]=p[c++];else q=p;p=null;p=a.CONST.__USFB_M_MOBILETOKEN.device==f?a.certUtil().getTheCertAttributes(v,"Base64"):a.certUtil().getTheCertAttributes(d,"Base64");r.jsonSignedData=q;r.b64RValue=m;r.tokenLabel=w;r.certAttrs=p;null!=l&&f==a.CONST.__USFB_M_HSMKEY.device&&(r.tokenName=l.name,r.tokenDriver=l.driver);t(r)}e=g=z=B=null;a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k&&k.dispose()},10)})}}):(t(null),setTimeout(function(){k&&k.dispose(!0)},10));else-1==e||""==g?(t(null),setTimeout(function(){k&&k.dispose(!0)},10)):a.Whale().getSignDataP7_noConWithHash(b,e,g,c,m,function(b,c,f){0!=b?(a.ERROR.Code=b,a.ERROR.Message=c,a.uiUtil().errMsgBox(c,a.ERROR.Code),t(n(b,c))):(r.jsonSignedData=f,r.tokenLabel="",r.certAttrs=a.certUtil().getTheCertAttributes(d,"Base64"),h?a.Whale().getCertR(e,g,function(b,c,d){a.uiUtil().loadingBox(!1,"us-div-list-load",1);if(0==b)try{var e=a.usWebToolkit.util.hexToBytes(d),f=a.usWebToolkit.pki.certificateFromBase64(h),g=a.usWebToolkit.pkcs7.createEnvelopedData();g.addRecipient(f);g.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];g.content=e;g.encrypt();r.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(g)}catch(Hb){}t(r);setTimeout(function(){k.dispose()},10)}):(t(r),setTimeout(function(){k.dispose()},10)));e=g=z=B=null;a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k&&k.dispose()},10)});else{a.uiUtil().loadingBox(!0,"us-div-list-load");try{var z=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[e].signcert),B=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[e].signpri);p=a.usWebToolkit.pkcs8.decryptPrivateKeyInfo(B,g);w=a.usWebToolkit.pkcs8.getPrivateKeyAttributesRandom(p)}catch(y){a.ERROR.Code=y.code;a.ERROR.Message=y.message;a.uiUtil().errMsgBox(a.ERROR.Message,a.ERROR.Code);t(n(y.code,y.message));a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k&&k.dispose(!0)},10);return}try{if(b)for(v in b){var A=a.usWebToolkit.pkcs7.createSignedData();A.signWithHashData(a.usWebToolkit.util.decode64(b[v]),c.toLowerCase(),z,B,g,null,null,m);q[v]=a.usWebToolkit.pkcs7.messageToBase64(A)}}catch(y){a.ERROR.Code=y.code;a.ERROR.Message=y.message;a.uiUtil().errMsgBox(a.ERROR.Message,a.ERROR.Code);t(n(y.code,y.message));a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k&&k.dispose(!0)},10);return}r.jsonSignedData=q;if(h)try{var E=a.usWebToolkit.pki.certificateFromBase64(h),F=a.usWebToolkit.pkcs7.createEnvelopedData();F.addRecipient(E);F.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];F.content=w;F.encrypt();r.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(F)}catch(y){}r.curDevice=f;r.certAttrs=a.certUtil().getTheCertAttributes(a.PFUC[e].signcert,"Base64");t(r);e=g=z=B=null;a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k&&k.dispose(!0)},10)}else t(null),setTimeout(function(){k&&k.dispose(!0)},10)}function ca(){4&a.ESVS.Mode&&a.nimservice()&&a.nimservice().ClearAllUserCertList(function(a,c){})}function Ib(){a.nimservice().checkInstall(function(b){u.chkEXESetup=a.ESVS.chkEXESetup;1==b?a.changeDefaultMedia():null==a.Whale()||"harddisk"!=ia&&"removable"!=ia||a.changeDefaultMedia()})}if(x&&Ga){var P=x.Mode,ta=x.EncAlgo,ua=x.HashAlgo,aa=x.SecureKeyboardType,Ja=x.PKI,Ka=x.SRCPath,da=x.Language,ea=x.TargetObj,na=x.TabIndex,oa=x.Embedded,ja=x.LimitNumOfTimesToTryToInputPW,La=x.CMPIP,va=x.CMPPort,wa=x.CMPURL,pa=x.SHARESTORAGE,xa=x.NimCheckURL,K=x.Media,Ma=x.Organization,ya=x.Policy,za=x.ShowExpiredCerts,V=x.LimitMinNewPWLen,W=x.LimitMaxNewPWLen,fa=x.LimitNewPWPattern,Na=x.ChangePWByNPKINewPattern,Aa=x.CertRequestPageEnable,Oa=x.CertFindBtnEnable,Pa=x.SDInstallURL,Qa=x.IssueCertInBIOToken,Jb=x.License,Ba=!1,mb=!1,Ca=1E4,ia=x.afterSetupDefaultDevice,Kb=x.iraq,Lb=x.installPageOpenOption,T="utf8",nb="0.5";x.loadingOpacity&&(nb=x.loadingOpacity);var Mb=["1.2.410.200004.5.2.1.1","1.2.410.200004.5.1.1.7","1.2.410.200005.1.1.5","1.2.410.200004.5.4.1.2","1.2.410.200012.1.1.3"];x.dataEncoding&&"EUCKR"==x.dataEncoding.toUpperCase().replace("-","")&&(T="euckr");var Ra=x.TransServerIP,Da=x.TransServerPort,Sa=x.TransCfmWindowFlag,ka=!0;x.ShowGuide&&(mb=!0);1E4<x.zIndex&&(Ca=x.zIndex);var N=null,Ta=null,u={};u.zIndex=Ca;u.afterSetupDefaultDevice=ia;u.installPageOpenOption=Lb;u.CertforKeyboard="MIIDZzCCAk+gAwIBAgIBATANBgkqhkiG9w0BAQsFADBKMQswCQYDVQQGEwJLUjESMBAGA1UEChMJQ3Jvc3NDZXJ0MQ4wDAYDVQQLEwVTVExhYjEXMBUGA1UEAxMOQ3Jvc3NDZXJ0V2ViVjMwHhcNMTQwNjI1MDAwMDAwWhcNMjkxMjMxMjM1OTAwWjBKMQswCQYDVQQGEwJLUjESMBAGA1UEChMJQ3Jvc3NDZXJ0MQ4wDAYDVQQLEwVTVExhYjEXMBUGA1UEAxMOQ3Jvc3NDZXJ0V2ViVjMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDIm9p0HiCrpFVSfRVdnC3V4kEC75F8bUWV/Ewa7TmuirbVOYsdtSpz+Yceh+Tindducrf6zGNlhhNpyhFQ6+4/f0qLdwALapojECOUQg/lISRD2FO88hEhBj/rOjZiVzHYyHm8K2bTtBJXNauBBCb1yUKNdHuAvw4xub/jcgZ2PRtWORrQwuStcGBSSnqCIHZcGb5KKdHtY15ppcZoZBXB75kKKdK8qJm/6A/bBW0S+o3ooN+oaGrFFEVH61AHi45sBHGO4e1oyRT8dfIgKUzUQOKSZ1r3Wln4CSqQR8tZOd/T+LzzSB7r4N/rzNo3T4oO5O6lkQBw3NZg25nMXBj7AgMBAAGjWDBWMAwGA1UdEwEB/wQCMAAwHQYDVR0OBBYEFJ7NboZBgBMwRmav8MSGpsMab+NjMA4GA1UdDwEB/wQEAwIGwDAXBgNVHSAEEDAOMAwGCiqDGoyaRAUEAQEwDQYJKoZIhvcNAQELBQADggEBAIU2d1CH6vsZaTAeSCdBM1tKcl/8YpnUSqt3w6DB45E9akGCODgEI1K/KPtRIhrjBBYopQJN9Z3F411xiw2Te0LJQKA9snAtRZCEbL/1FzjyUXKEv5QB9Zgch4KvbqhOdVb1bJsztJH1kV/lbeNbil2TI1NntWbKyPWDKlzdPsGbSAgaFkUtbt7fxcGJBoXAEsaohtNiDM3chfJWv4d0dlDito5isOMIMDN+bfLcBp745T+wEpig6bfbVZnDjzGbXhJJjVvFKydQrZfrLBnVLCpElD1xN1Ipw+6UGJXEuxqXS51drnG9jVU1FL9JDtDE7BNByXV2V9y9b1/6PSeSYMw=";var M={config:{serverHost:"https://twas.signkorea.com",serverPort:"8500",moPollingTime:1E3,moRepeatDelayInterval:3E4,clauseURL:"https://www.crosscert.com/cloud/ConditionOfUse.html"},customID:"",siteCode:"",APIKey:"",domain:document.location.host,cloudWeb:null,secureData:null};x.cloudInfo&&(x.cloudInfo.config&&(M.config.serverHost=x.cloudInfo.config.serverHost?x.cloudInfo.config.serverHost:M.config.serverHost,M.config.serverPort=x.cloudInfo.config.serverPort?x.cloudInfo.config.serverPort:M.config.serverPort,M.config.clauseURL=x.cloudInfo.config.clauseURL?x.cloudInfo.config.clauseURL:M.config.clauseURL),M.customID=x.cloudInfo.customID?x.cloudInfo.customID:"",M.siteCode=x.cloudInfo.siteCode?x.cloudInfo.siteCode:"",M.APIKey=x.cloudInfo.APIKey?x.cloudInfo.APIKey:"",M.domain=x.cloudInfo.domain?x.cloudInfo.domain:M.domain);var X=null;try{X={loading:TK_Loading,scan:TK_Rescan,encFunc:TK_GetEncCommWithSha2,flag:loadflag}}catch(b){X=null,"touchen"==aa&&(aa="")}x.touchEnFunc&&(X=x.touchEnFunc);u.touchEnFunc=X;var Ia=!1;x.verifyCertBeforeSign&&(Ia=x.verifyCertBeforeSign);if(!P||"undefined"===typeof P||1>P||6<P)P=6;u.Mode=P;u.useQRCode="boolean"!=typeof x.useQRCode||x.useQRCode?x.useQRCode=!0:x.useQRCode=!1;u.g2b="boolean"==typeof x.g2b&&x.g2b?x.g2b=!0:x.g2b=!1;u.toss="boolean"==typeof x.toss&&x.toss?x.toss=!0:x.toss=!1;ta&&"undefined"!==typeof ta||(ta="3des");u.EncAlgo=ta;ua&&"undefined"!==typeof ua||(ua="sha256");u.HashAlgo=ua;Ka||(Ka="");var Nb=function(a,c){return c?function(){return eval(eval(a)())}():function(){return eval(a)}()};u.SRCPath=Ka;u.ShowGuide=mb;aa?"ahnlab"==aa?(eval(J({eval:!1,intergrity:!1,name:"astx2.min.js",url:"unisignweb/framework/keyboard/astx2.min.js"})),eval(J({eval:!1,intergrity:!1,name:"astx2_custom.js",url:"unisignweb/framework/keyboard/astx2_custom.js"}))):"touchen"==aa&&("function"!=typeof X.loading||loadflag||X.loading()):aa="";u.SecureKeyboardType=aa;Ra||(Ra="211.192.169.44");u.TransServerIP=Ra;if(0>Da||!Da)Da=443;u.TransServerPort=Da;Sa||(Sa=!1);u.TransCfmWindowFlag=Sa;Ja||(Ja="NPKI");u.PKI=Ja;u.BSPKI="NPKI";if(da){var ob=da.split("-");if(2<ob.length)for(var pb=1;pb<ob.length;pb++)da=da.replace("-","_");else da=da.replace("-","_");da=da.toLowerCase()}else da=!navigator.browserLanguage||"ko"!=navigator.browserLanguage.toLowerCase()&&"kr"!=navigator.browserLanguage.toLowerCase()&&"ko-kr"!=navigator.browserLanguage.toLowerCase()?!document.documentElement.lang||"ko"!=document.documentElement.lang.toLowerCase()&&"kr"!=document.documentElement.lang.toLowerCase()&&"ko-kr"!=document.documentElement.lang.toLowerCase()?!navigator.language||"ko"!=navigator.language.toLowerCase()&&"kr"!=navigator.language.toLowerCase()&&"ko-kr"!=navigator.language.toLowerCase()?"en_us":"ko_kr":"ko_kr":"ko_kr";u.Language=da;xa||(xa="../install/Obj_check.html");u._NimCheckURL=xa;if(0==oa||!oa){var qb=function(){!ea&&document.body&&(ea=document.createElement("div"),ea.style.width="0px",ea.style.height="0px",document.body.insertBefore(ea,document.body.firstChild));ea?u.TargetObj=ea:setTimeout(qb,500)};setTimeout(qb,300)}u.TargetObj=ea;if(0>na||!na)na=0;u.TabIndex=na;oa||(oa=!1);u.Embedded=oa;if(0>=ja||10<ja||!ja)ja=3;u.LimitNumOfTimesToTryToInputPW=ja;La||(La="211.192.169.70");u.CMPIP=La;if(0>va||!va)va=4502;u.CMPPort=va;wa||(wa="http://ca.crosscert.com:9992/webcmp/");u.CMPURL=wa;K?(K.list=K.list?K.list.toLowerCase():null,K.defaultdevice?(K.defaultdevice=K.defaultdevice.toLowerCase(),null!=K.list&&(K.defaultdevice=0>K.list.indexOf(K.defaultdevice)?K.list.split("|")[0]:K.defaultdevice)):K.defaultdevice=null):(ka=!1,K=2==P?{defaultdevice:"browsersign",list:"cloudsign|browsersign"}:6==P?{defaultdevice:"harddisk",list:"harddisk|removable|sectoken|savetoken|mobilephone|cloudsign|browsersign"}:{defaultdevice:"harddisk",list:"harddisk|removable|sectoken|savetoken|mobilephone"});if(void 0==K.defaultdevice||null==K.defaultdevice)K.defaultdevice=2==P?"browsersign":"harddisk";-1!=K.list.indexOf("browsersign")?(pa=x.SHARESTORAGE?x.SHARESTORAGE:"https://browsersign.crosscert.com",document.writeln("<iframe src='"+pa+"/index.html' name='shareframe' id='shareframe' style='visibility:hidden;position:absolute'></iframe>")):pa="";u.SHARESTORAGE=pa;0<=u.PKI.indexOf("MilPKI")&&(K.defaultdevice="harddisk",K.list="harddisk");u.Media=K;Ma||(Ma=null);u.Organization=Ma;ya||(ya=null);u.Policy=ya;"boolean"!==typeof za&&(za=!0);u.ShowExpiredCerts=za;if("NPKI"===u.PKI){if(10>V||64<V||!V)V=10;u.LimitMinNewPWLen=V;if(10>W||64<W||!W||V>W)W=64;u.LimitMaxNewPWLen=W;fa=2}else{if(8>V||64<V||!V)V=8;u.LimitMinNewPWLen=V;if(8>W||64<W||!W||V>W)W=64;u.LimitMaxNewPWLen=W;if(0>fa||2<fa||!fa)fa=0}u.LimitNewPWPattern=fa;Na||(Na=!1);u.ChangePWByNPKINewPattern=Na;"undefined"===typeof Aa&&(Aa=1);u.CertRequestPageEnable=Aa;"undefined"===typeof Oa&&(Oa=1);u.CertFindBtnEnable=Oa;"undefined"===typeof Pa&&(Pa="");u.SDInstallURL=Pa;"undefined"===typeof Qa&&(Qa=!1);u.IssueCertInBIOToken=Qa;u.License=Jb;Ba&&"undefined"!==typeof Ba||(Ba=!1);u.multiuse=Ba;u.memberURL=x.memberURL;u.smsURL=x.smsURL;u.siteName=x.siteName;u.joinCode=x.joinCode;window.ESVS=u;var Ea=null,Y=[],bb=0,Ua={};Ua.name=Ga.NAME;Ua.data=Ga.DATA;Y[bb++]=Ua;var ha=[{eval:!0,intergrity:!0,name:"json2",url:"unisignweb/framework/json2.js"},{eval:!0,intergrity:!0,name:"Blob",url:"unisignweb/framework/Blob.js"},{eval:!1,intergrity:!0,name:"FileSaver",url:"unisignweb/framework/FileSaver.js"},{eval:!1,intergrity:!0,name:"UniSignW2AUtil",url:"unisignweb/framework/UniSignW2AUtil.js"},{eval:!1,intergrity:!0,name:"UniSignW2AExtension",url:"unisignweb/framework/UniSignW2AExtension.js"},{eval:!0,intergrity:!0,name:"draggable",url:"unisignweb/framework/draggable.js"},{eval:!0,intergrity:!0,name:"jsustoolkitErrCode",url:"jsustoolkit/jsustoolkitErrCode.js"},{eval:!0,intergrity:!0,name:"asn1",url:"jsustoolkit/toolkit/asn1.js"},{eval:!0,intergrity:!0,name:"jsbn",url:"jsustoolkit/toolkit/jsbn.js"},{eval:!0,intergrity:!0,name:"oids",url:"jsustoolkit/toolkit/oids.js"},{eval:!0,intergrity:!0,name:"util",url:"jsustoolkit/toolkit/util.js"},{eval:!0,intergrity:!0,name:"unicode",url:"jsustoolkit/toolkit/unicode.js"},{eval:!0,intergrity:!0,name:"aes",url:"jsustoolkit/crypto/aes.js"},{eval:!0,intergrity:!0,name:"des",url:"jsustoolkit/crypto/des.js"},{eval:!0,intergrity:!0,name:"desofb",url:"jsustoolkit/crypto/desofb.js"},{eval:!0,intergrity:!0,name:"seed",url:"jsustoolkit/crypto/seed.js"},{eval:!0,intergrity:!0,name:"rc2",url:"jsustoolkit/crypto/rc2.js"},{eval:!0,intergrity:!0,name:"hmac",url:"jsustoolkit/crypto/hmac.js"},{eval:!0,intergrity:!0,name:"md5",url:"jsustoolkit/crypto/md5.js"},{eval:!0,intergrity:!0,name:"sha1",url:"jsustoolkit/crypto/sha1.js"},{eval:!0,intergrity:!0,name:"sha256",url:"jsustoolkit/crypto/sha256.js"},{eval:!0,intergrity:!0,name:"rsa",url:"jsustoolkit/crypto/rsa.js"},{eval:!0,intergrity:!0,name:"prng",url:"jsustoolkit/crypto/prng.js"},{eval:!0,intergrity:!0,name:"random",url:"jsustoolkit/crypto/random.js"},{eval:!0,intergrity:!0,name:"pki",url:"jsustoolkit/toolkit/pki.js"},{eval:!0,intergrity:!0,name:"pkcs5",url:"jsustoolkit/toolkit/pkcs5.js"},{eval:!0,intergrity:!0,name:"pkcs8",url:"jsustoolkit/toolkit/pkcs8.js"},{eval:!0,intergrity:!0,name:"pkcs7",url:"jsustoolkit/toolkit/pkcs7.js"},{eval:!0,intergrity:!0,name:"pkcs7asn1",url:"jsustoolkit/toolkit/pkcs7asn1.js"},{eval:!0,intergrity:!0,name:"pkcs12",url:"jsustoolkit/toolkit/pkcs12.js"},{eval:!0,intergrity:!0,name:"x509Certificate",url:"jsustoolkit/toolkit/x509Certificate.js"},{eval:!0,intergrity:!0,name:"cmpasn1",url:"jsustoolkit/toolkit/cmpasn1.js"},{eval:!0,intergrity:!0,name:"cmp",url:"jsustoolkit/toolkit/cmp.js"},{eval:!0,intergrity:!0,name:"usWebCMPXMLHttp",url:"jsustoolkit/webcmp/usWebCMPXMLHttp.js"},{eval:!0,intergrity:!0,name:"usWebCMP",url:"jsustoolkit/webcmp/usWebCMP.js"}],rb=[{eval:!1,intergrity:!0,name:"npkicacerts",url:"unisignweb/js/storage/ins/npkicacerts.js"},{eval:!1,intergrity:!0,name:"encryptstorage",url:"unisignweb/js/storage/enc/encryptstorage.js"},{eval:!1,intergrity:!0,name:"localstorage",url:"unisignweb/js/storage/ls/localstorage.js"},{eval:!1,intergrity:!0,name:"localstoragehandler",url:"unisignweb/js/storage/ls/localstoragehandler.js"},{eval:!1,intergrity:!0,name:"storagehandler",url:"unisignweb/js/storage/storagehandler.js"},{eval:!1,intergrity:!0,name:"storageerrcode",url:"unisignweb/js/storage/err/storageerrcode.js"}],Ab=[{eval:!0,intergrity:!1,name:"jsrose_crypto",url:"unisignweb/cloud/jsrose_crypto.js"},{eval:!0,intergrity:!1,name:"jsrose",url:"unisignweb/cloud/jsrose.js"},{eval:!0,intergrity:!1,name:"cloudWeb",url:"unisignweb/cloud/cloudWeb.js"}];new function(){for(var a=0;a<ha.length;a++)0==a?"object"!==typeof JSON&&J(ha[a]):1==a||2==a?document.createElementNS&&(2==a?(eval(J(ha[a])),Ea=eval("saveAs")):J(ha[a])):3==a?(J(ha[3]),J(ha[4]),a=4):J(ha[a]);var c=null;for(a=0;a<rb.length;a++)c=eval(J(rb[a]));try{Ta=new StorageHandler(1,{enc_algo:u.EncAlgo,hash_algo:u.HashAlgo,pki:u.BSPKI,domain:document.domain,error_code:c})}catch(d){a=window.console||{log:function(){}},a.log("*** StorageHandler initializing error ***"),a.log("e.code : ",d.code,"e.message : ",d.message,"e.detail : ",d.detail),Ta=null}};var sb=function(){};sb.prototype={isKeyProtected:function(){return"touchen"==a.ESVS.SecureKeyboardType&&a.bsUtil().isTouchEnKeyUsable()||"ahnlab"==a.ESVS.SecureKeyboardType&&a.bsUtil().isAhnlabProtectorUsable()&&!a.uiUtil().isItPFDevice(a.SELECTINFO.curdevice)?!0:!1},GetKeyboardType:function(){if("touchen"==a.ESVS.SecureKeyboardType){if("undefined"!=typeof X.loading&&loadflag)return a.ESVS.SecureKeyboardType}else if("ahnlab"==a.ESVS.SecureKeyboardType&&1==a.isSKModule)return a.ESVS.SecureKeyboardType;return""},isTouchEnKeyUsable:function(){return 2==a.ESVS.Mode||null!=a.Whale()?!1:X&&"function"==typeof X.loading&&loadflag?!0:!1},ahnlabInit:function(b){0<=aa.indexOf("ahnlab")&&"undefined"!=typeof $ASTX2&&"undefined"!=typeof $ASTX2.init&&"undefined"!=typeof $ASTX2.initNonE2E&&0!=a.isSKModule&&$ASTX2.init(function(){$ASTX2.initNonE2E(2522);b&&b()},function(){$ASTX2.getLastError();b&&b()})},isAhnlabProtectorUsable:function(){return 2&a.ESVS.Mode||"undefined"==typeof $ASTX2||"undefined"==typeof $ASTX2.init||"undefined"==typeof $ASTX2.initNonE2E?!1:a.isSKModule},GetAhnlabEncInputInfo:function(a){return{type:3,value:{pageID:$ASTX2.getE2EPageID()+"",inputID:$ASTX2.getE2EInputID(document.getElementById(a))}}},AhnlabClearText:function(b){"ahnlab"==a.ESVS.SecureKeyboardType&&this.isAhnlabProtectorUsable()&&$ASTX2.clearE2EText(document.getElementById(b))},SetSecurityStatus:function(b,c){b=document.getElementById(b);"on"==c&&"touchen"==a.ESVS.SecureKeyboardType&&(this.isTouchEnKeyUsable()||this.isAhnlabProtectorUsable())?b.setAttribute("data-enc","on"):b.setAttribute("data-enc","off")},SetReScan:function(){"touchen"==a.ESVS.SecureKeyboardType&&this.isTouchEnKeyUsable()&&X.scan()},GetEncryptPwd:function(b,c,d){null==a.pubkey||0>=a.pubkey.length?d(""):X.encFunc(b,c,a.pubkey,function(a){d(a)})},GetEnvelopedPwd:function(b){if(null==b||0>=b.length)return"";var c=a.usWebToolkit.pki.certificateFromBase64(a.ESVS.CertforKeyboard),d=a.usWebToolkit.pkcs7.createEnvelopedData();d.addRecipient(c);d.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];d.content=a.usWebToolkit.util.createBuffer(b);d.encrypt();return a.usWebToolkit.pkcs7.messageToBase64(d)}};var Va=function(){this._errormsglang=eval(eval(function(){return J({eval:!1,intergrity:!1,name:"errormsg_"+u.Language,url:"unisignweb/rsrc/lang/"+u.Language+"/errormsg_"+u.Language+".js"})})())};Va.prototype={isValidDevice:function(b){for(var c in a.CONST.medias)if(a.CONST.medias[c].device===b)return!0;return!1},getMediaName:function(b){var c="",d;for(d in a.CONST.medias)if(a.CONST.medias[d].device===b){c=a.CONST.medias[d].name;break}return c},getMediaDevice:function(b){var c=-1,d;for(d in a.CONST.medias)if(a.CONST.medias[d].name===b){c=a.CONST.medias[d].device;break}return c},isItPortableDevice:function(){return"android"===a.osName||"ios"===a.osName?!0:!1},isItLGAndroidBrowser:function(){return"android lg"===a.browserName?!0:!1},isItSamsungAndroidBrowser:function(){return"android samsung"===a.browserName?!0:!1},isItSupportingPFCertBackUp:function(){if(!(2&a.ESVS.Mode))return!1;if(this.isItPortableDevice())return"android samsung"===a.browserName||"android lg"===a.browserName||"android browser"===a.browserName||"android chrome"===a.browserName||"ios safari"===a.browserName||"ios chrome"===a.browserName?!0:!1;if("chrome"===a.browserName)return!0;if("msie"===a.browserName){if(10<=parseInt(a.browserVersion))return!0}else{if("firefox"===a.browserName)return parseInt(a.browserVersion),!0;if("safari"===a.browserName){if(6.1<=parseFloat(a.browserVersion))return!0}else if("opera"===a.browserName)return parseInt(a.browserVersion),!0}return!1},isItPFDevice:function(b){switch(b){case a.CONST.__PF_M_SS.device:case a.CONST.__PF_M_LS.device:case a.CONST.__PF_M_TOUCHSIGN.device:case a.CONST.__PF_M_SMARTSIGN.device:case a.CONST.__PF_M_WEBSECTOKEN.device:case a.CONST.__PF_M_WEBSOFTTOKEN.device:case a.CONST.__PF_M_CLOUDSIGN.device:case a.CONST.__PF_M_CLOUD.device:return!0}return!1},isItSupportingThisStorage:function(b){if(!b)return!1;var c=!1;if(1===(255&a.ESVS.Mode)||4===a.ESVS.Mode)switch(b.device){case a.CONST.__USFB_M_DISK.device:case a.CONST.__USFB_M_HSMKEY.device:case a.CONST.__USFB_M_SMARTCARD.device:case a.CONST.__USFB_M_MOBILE.device:case a.CONST.__USFB_M_HDD.device:case a.CONST.__USFB_M_MOBILETOKEN.device:case a.CONST.__USFB_M_SECUREDISK.device:c=this.isItPortableDevice()?!1:!0;break;default:c=!1}else if(2===(255&a.ESVS.Mode))switch(b.device){case a.CONST.__PF_M_LS.device:case a.CONST.__PF_M_SS.device:case a.CONST.__PF_M_CLOUDSIGN.device:case a.CONST.__PF_M_CLOUD.device:c=!0;break;case a.CONST.__PF_M_TOUCHSIGN.device:case a.CONST.__PF_M_SMARTSIGN.device:case a.CONST.__PF_M_WEBSECTOKEN.device:case a.CONST.__PF_M_WEBSOFTTOKEN.device:c=this.isItPortableDevice()?!1:!0;break;default:c=!1}else if(3===(255&a.ESVS.Mode)||6===(255&a.ESVS.Mode))switch(b.device){case a.CONST.__USFB_M_DISK.device:case a.CONST.__USFB_M_HSMKEY.device:case a.CONST.__USFB_M_SMARTCARD.device:case a.CONST.__USFB_M_MOBILE.device:case a.CONST.__USFB_M_HDD.device:case a.CONST.__USFB_M_MOBILETOKEN.device:case a.CONST.__USFB_M_SECUREDISK.device:c=this.isItPortableDevice()?!1:!0;break;case a.CONST.__PF_M_SS.device:case a.CONST.__PF_M_LS.device:case a.CONST.__PF_M_CLOUDSIGN.device:case a.CONST.__PF_M_CLOUD.device:c=!0;break;case a.CONST.__PF_M_TOUCHSIGN.device:case a.CONST.__PF_M_SMARTSIGN.device:case a.CONST.__PF_M_WEBSECTOKEN.device:case a.CONST.__PF_M_WEBSOFTTOKEN.device:c=this.isItPortableDevice()?!1:!0;break;default:c=!1}return c},getScrollTop:function(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop},getScrollLeft:function(){return self.pageXOffset?self.pageXOffset:document.documentElement&&document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft},getViewportHeight:function(){return window.undefined!=window.innerHeight?window.innerHeight:"CSS1Compat"==document.compatMode?document.documentElement.clientHeight:document.body?document.body.clientHeight:window.undefined},getViewportWidth:function(){return window.undefined!=window.innerWidth?window.innerWidth:"CSS1Compat"==document.compatMode?document.documentElement.clientWidth:document.body?document.body.clientWidth:window.undefined},getStyle:function(a,c,d){return a&&c&&d?a.currentStyle?a.currentStyle[c]:window.getComputedStyle?window.getComputedStyle(a,"").getPropertyValue(d):null:null},getNumSize:function(a){if(!a)return-1;a=a.toLowerCase();if(-1<a.indexOf("px"))a=a.substring(0,a.indexOf("px"));else return-1;return parseInt(a)},getOverlay:function(a){if(0>a||!a)return null;var b=document.createElement("div");b.style.zIndex=a;b.style.backgroundImage="none";b.style.margin="0px";b.style.cursor="auto";b.style.display="none";b.onclick=null;b.style.position="fixed";b.style.width="100%";b.style.height="100%";b.style.top="0";b.style.left="0";b.style.filter="alpha(opacity=50)";b.style.backgroundColor="#000";b.style.opacity=nb;return b},loadingBox:function(b,c,d){if(null==c||""==c)c="us-div-list-load";c=document.getElementById(c);if(null!=c){var e=document.getElementById("us-cert-processing-img");null!=e&&e.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/processing-img.gif",0);null==d&&(d=0);e=document.getElementById("us-cert-processing-text");null!=e&&(e.innerHTML="","string"==typeof d?e.appendChild(document.createTextNode(d)):e.appendChild(document.createTextNode(this._errormsglang.IDS_CERT_LOADING_MSG[d])));c.style.display=b?"":"none"}},createLoadingBox:function(b,c,d){if(null==c||""==c)c="us-div-loading-dialog";null==document.getElementById(c)?"hide"!=b&&(b=Ca+1,a.ESVS.TargetObj.innerHTML='<div id="us-div-loading-dialog" style="z-index:'+b+'" class="us-layout-loading-o"></div><div style="z-index:'+b+'" class="us-layout-loading"><span class="us-layout-cert-processing-img"><img id="us-div-loading-dialog-img" class="us-layout-cert-processing-img"></span><span id="us-div-loading-dialog-text" class="us-layout-cert-processing-text"></span></div>',b=document.getElementById("us-div-loading-dialog-img"),null!=b&&b.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/processing-img.gif",0),b=document.getElementById("us-div-loading-dialog-text"),null!=b&&(b.innerHTML="",b.appendChild(document.createTextNode(d)))):"change"==b?(b=document.getElementById("us-div-loading-dialog-text"),null!=b&&(b.innerHTML="",b.appendChild(d))):a.ESVS.TargetObj.innerHTML=""},addCapsLockEvent:function(a,c,d,e){a=document.getElementById(a);var b=document.getElementById(c);if(!b||!a)return null;c=document.getElementById(c+"-text");""!=d&&c.appendChild(document.createTextNode(d));var f=function(){b&&(b.style.display="block")},h=!1,k=!1;a.onkeyup=function(a){a=a||event;a.which&&16==a.which&&(h=!1)};a.onkeydown=function(a){a=a||event;var c=0;a.which&&16==a.which&&(h=!0);window.event?c=a.keyCode:a.which&&(c=a.which);c&&20==c?k?(k=!1,b&&(b.style.display="none")):(k=!0,f()):c&&13==c&&e&&e(a?a:event)};a.onkeypress=function(a){a=a||event;var c=0,d=!1;window.event?(c=a.keyCode,d=a.shiftKey):a.which&&(c=a.which,d=h);65<=c&&90>=c&&!d?(k=!0,f()):97<=c&&122>=c&&d?(k=!0,f()):48<=c&&57>=c||(k=!1,b&&(b.style.display="none"))};try{-1!=navigator.appVersion.toLowerCase().indexOf("win")&&(document.msCapsLockWarningOff=!0)}catch(m){}},offsetResize:function(a,c){if(a){var b=this.getViewportHeight()/2-a.offsetHeight/2,e=this.getViewportWidth()/2-a.offsetWidth/2;0>b&&(b=0);0>e&&(e=0);a.style.position="fixed";!c||"center"!=c&&"center"!=c.split(",")[0]?c&&"center"!=c?(a.style.top=c.split(",")[0]+"px",a.style.left=c.split(",")[1]+"px"):(a.style.top="30px",a.style.left=e+"px"):(a.style.top=b+"px",a.style.left=e+"px")}},setCookie:function(a){localStorage.setItem("cookie",JSON.stringify(a))},getCookie:function(){var a=localStorage.getItem("cookie");return a?JSON.parse(a):null},msgBox:function(a){a&&alert(a)},setFirstFocus:function(a){a&&("string"==typeof a&&(a=document.getElementById(a)),a&&(a.focus(),setTimeout(function(){a.focus()},10)))},setRotationTabFocus:function(a,c,d){function b(a){return"string"==typeof a?document.getElementById(a):a}a&&c&&d&&(a=b(a),c=b(c),d=b(d),a.onkeydown=function(b){var e=b||window.event;9==(e.which||e.keyCode)&&(a.onblur=function(){setTimeout(function(){(e.shiftKey?c:d).focus()},10)})})},flagAlert:function(a){a&&0!=N&&alert(a)},errMsgBox:function(a,c){a&&alert(a+"\n\nError Code [ "+c+" ]")},getErrorMessageLang:function(){return this._errormsglang},getUserCancelErrCodeNMsg:function(b){11003!=a.ERROR.Code&&21002!=a.ERROR.Code&&31001!=a.ERROR.Code&&(a.ERROR.Code=999,a.ERROR.Message=this._errormsglang.IDS_ERROR_USER_CANCEL);b&&(b.resultCode=a.ERROR.Code,b.resultMessage=a.ERROR.Message)},CheckPwdPattern:function(b,c){var d=!0;if(4&a.ESVS.Mode&&a.bsUtil().isKeyProtected())a.nimservice().CheckPasswdCombination(b,a.ESVS.LimitMinNewPWLen,a.ESVS.LimitMaxNewPWLen,a.ESVS.LimitNewPWPattern,function(a,b){0!=a?c(!1):c(!0)});else{a.ESVS.LimitMinNewPWLen>b.length&&(d=!1);a.bsUtil().isKeyProtected()&&c(d);if("NPKI"===a.ESVS.PKI||2===a.ESVS.LimitNewPWPattern){var e=/^(?=.*[a-zA-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9])/g;e.exec(b)||(d=!1)}else 1===a.ESVS.LimitNewPWPattern&&(e=/^(?=.*[a-zA-Z])(?=.*[0-9])/g,e.exec(b)||(d=!1));if("NPKI"===a.ESVS.PKI&&(e=/['"\\|]/g,e.exec(b)&&(d=!1),2<b.length)){for(e=0;e<b.length-2;e++)if(b.charAt(e)===b.charAt(e+1)&&b.charAt(e)===b.charAt(e+2)){d=!1;break}for(e=0;e<b.length-2;e++)if(b.charCodeAt(e)===b.charCodeAt(e+1)-1&&b.charCodeAt(e)===b.charCodeAt(e+2)-2){d=!1;break}}c(d)}},isIraq:function(){return!0===Kb?!0:!1}};var Wa=function(){var a=eval(eval(function(){return J({intergrity:!1,name:"errormsg_"+u.Language,url:"unisignweb/rsrc/lang/"+u.Language+"/certlist_"+u.Language+".js"})})());this._certOidNameTable={};this._certOidNameTable["1.2.410.200004.5.1.1.5"]=a.IDS_PERSON_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.1.1.7"]=a.IDS_CORPORATION_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.2.1.1"]=a.IDS_CORPORATION_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.2.1.2"]=a.IDS_PERSON_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.3.1.1"]=a.IDS_AGENCY_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.3.1.2"]=a.IDS_CORPORATION_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.3.1.9"]=a.IDS_PERSON_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.4.1.1"]=a.IDS_PERSON_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.4.1.2"]=a.IDS_CORPORATION_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.4.1.3"]=a.IDS_SERVER_CERTIFICATE;this._certOidNameTable["1.2.410.200004.5.5.1.1"]=a.IDS_PERSON_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.5.1.2"]=a.IDS_CORPORATION_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200005.1.1.1"]=a.IDS_PERSON_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200005.1.1.5"]=a.IDS_CORPORATION_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200012.1.1.1"]=a.IDS_PERSON_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200012.1.1.3"]=a.IDS_CORPORATION_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.2.1.7.1"]=a.IDS_PERSON_BANKING_N_INSURANCE;this._certOidNameTable["1.2.410.200004.5.2.1.7.2"]=a.IDS_PERSON_STOCKTRADING_N_INSURANCE;this._certOidNameTable["1.2.410.200004.5.2.1.7.3"]=a.IDS_PERSON_CREDITCARD;this._certOidNameTable["1.2.410.200004.5.1.1.9"]=a.IDS_PERSON_STOCKTRADING_N_INSURANCE;this._certOidNameTable["1.2.410.200004.5.1.1.9.2"]=a.IDS_PERSON_CREDITCARD;this._certOidNameTable["1.2.410.200005.1.1.4"]=a.IDS_PERSON_BANKING_N_INSURANCE;this._certOidNameTable["1.2.410.200005.1.1.6.2"]=a.IDS_PERSON_CREDITCARD;this._certOidNameTable["1.2.410.200004.5.4.1.101"]=a.IDS_PERSON_BANKING_N_INSURANCE;this._certOidNameTable["1.2.410.200004.5.4.1.102"]=a.IDS_PERSON_STOCKTRADING_N_INSURANCE;this._certOidNameTable["1.2.410.200004.5.4.1.103"]=a.IDS_PERSON_CREDITCARD;this._certOidNameTable["1.2.410.200004.5.4.1.104"]=a.IDS_PERSON_ELECTRONIC_CIVIL_APPEAL;this._certOidNameTable["1.2.410.200012.1.1.101"]=a.IDS_PERSON_BANKING_N_INSURANCE;this._certOidNameTable["1.2.410.200012.1.1.103"]=a.IDS_PERSON_STOCKTRADING_N_INSURANCE;this._certOidNameTable["1.2.410.200012.1.1.105"]=a.IDS_PERSON_CREDITCARD;this._certOidNameTable["1.2.410.200004.5.5.1.1"]=a.IDS_PERSON_GENERAL_PURPOSE;this._certOidNameTable["1.2.410.200004.5.5.1.2"]=a.IDS_CORPORATION_GENERAL_PURPOSE;this._certOidNameTable["1.1.1.1.1.1.1.1.1.1"]=a.IDS_VERISIGN;this._certOidNameTable.restriction=a.IDS_RESTRICTION;this._certCAOidTable={};this._certCAOidTable.crosscert="1.2.410.200004.5.4";this._certCAOidTable.yessign="1.2.410.200005.1.1";this._certCAOidTable.koscom="1.2.410.200004.5.1";this._certCAOidTable.ktnet="1.2.410.200012.1.1";this._certCAOidTable.kica="1.2.410.200004.5.2";this._certCAOidTable.inipass="1.2.410.200004.5.5";this._certCAOidTable.verisign="1.1.1.1.1.1";this._certCANameTable={};this._certCANameTable.crosscert=a.IDS_CA_CROSSCERT;this._certCANameTable.yessign=a.IDS_CA_YESSIGN;this._certCANameTable.koscom=a.IDS_CA_KOSCOM;this._certCANameTable.ktnet=a.IDS_CA_KTNET;this._certCANameTable.kica=a.IDS_CA_KICA;this._certCANameTable.inipass=a.IDS_CA_INIPASS;this._certValidState={};this._certValidState.valid=a.IDS_CERT_STATE_VALID;this._certValidState.invalid=a.IDS_CERT_STATE_INVALID;this._certValidState.notice1=a.IDS_CERT_STATE_NOTICE_1;this._certValidState.notice2=a.IDS_CERT_STATE_NOTICE_2;this.certDNAttribute=[];this.certDNAttribute[0]="cn";this.certDNAttribute[1]="c";this.certDNAttribute[2]="l";this.certDNAttribute[3]="s";this.certDNAttribute[4]="st";this.certDNAttribute[5]="street";this.certDNAttribute[6]="o";this.certDNAttribute[7]="ou";this.certDNAttribute[8]="dnqualifier";this.certDNAttribute[9]="dc";this.certDNAttribute[10]="serialnumber";this.certDNAttribute[11]="e"};Wa.prototype={getCN:function(a){if(!a)return"undefined";var b=null,d=a.replace(/(^\s*)|(\s*$)/gi,"").split("="),e=d.length,g=[],f=0;if(1<e){for(var h=0;h<e;h++)if(-1!=d[h].indexOf(","))for(var k=d[h].split(","),m=k.length,l=0;l<m;l++)g[f++]=k[l];else g[f++]=d[h];for(d=0;d<f;d++)if(this.certDNAttribute[0]==g[d].toLowerCase()){b=g[++d];break}if(f<=d+1)return null===b?this.getOU(a):b;a=this.certDNAttribute.length;do{++d;for(l=1;l<a;l++)if(this.certDNAttribute[l]==g[d].toLowerCase())return b;b=b+", "+g[d]}while(d<f)}return"undefined"},getO:function(a){if(!a)return"undefined";var b=null,d=a.replace(/\s/g,"").replace(/(^\s*)|(\s*$)/gi,"").split("="),e=d.length;a=[];var g=0;if(1<e){for(var f=0;f<e;f++)if(-1!=d[f].indexOf(","))for(var h=d[f].split(","),k=h.length,m=0;m<k;m++)a[g++]=h[m];else a[g++]=d[f];for(d=0;d<g;d++)if(this.certDNAttribute[6]==a[d].toLowerCase()){b=a[++d];break}if(g<=d+1)return null===b?"undefined":b;e=this.certDNAttribute.length;do{++d;for(m=0;m<e;m++)if(this.certDNAttribute[m]==a[d].toLowerCase())return b;b=b+", "+a[d]}while(d<g)}return"undefined"},getOU:function(a){if(!a)return"undefined";var b=null,d=a.replace(/(^\s*)|(\s*$)/gi,"").split("="),e=d.length;a=[];var g=0;if(1<e){for(var f=0;f<e;f++)if(-1!=d[f].indexOf(","))for(var h=d[f].split(","),k=h.length,m=0;m<k;m++)a[g++]=h[m];else a[g++]=d[f];for(d=0;d<g;d++)if(this.certDNAttribute[7]==a[d].toLowerCase()){b=a[++d];break}if(g<=d+1)return null===b?"undefined":b;e=this.certDNAttribute.length;do{++d;for(m=0;m<e;m++)if(this.certDNAttribute[m]==a[d].toLowerCase())return b;b=b+", "+a[d]}while(d<g)}return"undefined"},getLocalDate:function(a){if(!a)return"undefined";var b=new Date(a);a=b.getFullYear();var d=b.getMonth()+1;b=b.getDate();10>d&&(d="0"+d);10>b&&(b="0"+b);return a+"-"+d+"-"+b},getLocalDateNTime:function(a){if(!a)return"undefined";var b=new Date(a);a=b.getFullYear();var d=b.getMonth()+1,e=b.getDate(),g=b.getHours(),f=b.getMinutes();b=b.getSeconds();10>d&&(d="0"+d);10>e&&(e="0"+e);10>g&&(g="0"+g);10>f&&(f="0"+f);10>b&&(b="0"+b);return a+"-"+d+"-"+e+" "+g+":"+f+":"+b},getCertType:function(b){if("MPKI"==a.ESVS.PKI)return"Symantec";if(!b)return"undefined";b=this._certOidNameTable[b];return null==b||""==b?this._certOidNameTable.restriction:b},getIssuerName:function(a){return a?-1!=a.indexOf(this._certCAOidTable.crosscert)?this._certCANameTable.crosscert:-1!=a.indexOf(this._certCAOidTable.yessign)?this._certCANameTable.yessign:-1!=a.indexOf(this._certCAOidTable.koscom)?this._certCANameTable.koscom:-1!=a.indexOf(this._certCAOidTable.ktnet)?this._certCANameTable.ktnet:-1!=a.indexOf(this._certCAOidTable.kica)?this._certCANameTable.kica:-1!=a.indexOf(this._certCAOidTable.inipass)?this._certCANameTable.inipass:-1!=a.indexOf(this._certCAOidTable.verisign)?this._certCANameTable.verisign:"undefined":"undefined"},getIssuerEnName:function(a){return a?-1!=a.indexOf(this._certCAOidTable.crosscert)?"crosscert":-1!=a.indexOf(this._certCAOidTable.yessign)?"yessign":-1!=a.indexOf(this._certCAOidTable.koscom)?"SignKorea":-1!=a.indexOf(this._certCAOidTable.ktnet)?"tradesign":-1!=a.indexOf(this._certCAOidTable.kica)?"kica":-1!=a.indexOf(this._certCAOidTable.inipass)?"inipass":-1!=a.indexOf(this._certCAOidTable.verisign)?"verisign":"other":"undefined"},getExpirationState:function(a){if(!a)return"undefined";a=new Date(a);var b=(new Date).getTime();a=a.getTime()-b;return 0<a?2592E6<=a?this._certValidState.valid:this._certValidState.notice1+parseInt(a/1E3/60/60/24)+this._certValidState.notice2:this._certValidState.invalid},getExpirationStateValue:function(a){if(!a)return-1;a=new Date(a);var b=(new Date).getTime();a=a.getTime()-b;return 0<a?2592E6<=a?0:1:2},getTheCertAttributes:function(b,c){if(!b||!c)return{};a.usWebToolkit.x509Certificate.parser(b,c);b=null;try{b=a.usWebToolkit.x509Certificate.getVersion()}catch(A){}c=null;try{c=a.usWebToolkit.x509Certificate.getSerialNumber()}catch(A){}var d=null;try{d=a.usWebToolkit.x509Certificate.getSignAlgo()}catch(A){}var e=null;try{e=a.usWebToolkit.x509Certificate.getIssuerName()}catch(A){}var g=null;try{g=a.usWebToolkit.x509Certificate.getNotBefore()}catch(A){}var f=null;try{f=a.usWebToolkit.x509Certificate.getNotAfter()}catch(A){}var h=null;try{h=a.usWebToolkit.x509Certificate.getSubjectName()}catch(A){}var k=null;try{k=a.usWebToolkit.x509Certificate.getPublickey()}catch(A){}var m=null;try{m=a.usWebToolkit.x509Certificate.getAuthorityKeyIdentifier()}catch(A){}var l=null;try{l=a.usWebToolkit.x509Certificate.getSubjectKeyIdentifier()}catch(A){}var t=null;try{t=a.usWebToolkit.x509Certificate.getKeyUsage()}catch(A){}var q=null;try{q=a.usWebToolkit.x509Certificate.getCertificatePoliciesOid()}catch(A){}var r=null;try{r=a.usWebToolkit.x509Certificate.getSubjectAltName()}catch(A){}var p=null;try{p=a.usWebToolkit.x509Certificate.getAuthorityInfoAccess()}catch(A){}var v=null;try{v=a.usWebToolkit.x509Certificate.getcRLDistributionPoints()}catch(A){}var w=null;try{w=a.usWebToolkit.x509Certificate.getCertificatePoliciesCPS()}catch(A){}var n=null;try{n=a.usWebToolkit.x509Certificate.getCertificatePoliciesUserNotice()}catch(A){}var B=null;try{B=a.usWebToolkit.x509Certificate.getSignature()}catch(A){}return{version:b,serialNumber:c,signAlgo:d,issuerName:e,validateFrom:g,validateTo:f,subjectName:h,publicKey:k,authorityKeyIdentifier:m,subjectKeyIdentifier:l,keyUsage:t,policiesOid:q,subjectAltName:r,authorityInfoAccess:p,crlDistributionPoints:v,policiesCps:w,policiesUserNotice:n,signature:B}}};var Fa=function(){this._lang=eval(eval(function(){return J({eval:!1,intergrity:!1,name:"forgery_"+u.Language,url:"unisignweb/rsrc/lang/"+u.Language+"/forgery_"+u.Language+".js"})})());this._md=a.usWebToolkit.md.algorithms.sha256.create();this._integrityList=[];var b=J({eval:!1,intergrity:!1,name:"unisign",url:"unisignweb/integrity/unisign.js"}),c=null;if(!(1&a.ESVS.Mode)){null!=b||11<b.length?a.logger(" >>>> SignData : ["+b.length+"] "+b.substring(0,10)+"..."+b.substring(b.length-10,b.length)):a.logger(" >>>> SignData ERROR : "+b);var d=null;try{var e=b;d=a.usWebToolkit.pkcs7.messageFromBase64(b);var g=b;d.verify()}catch(f){a.uiUtil().flagAlert(this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE+"\nErrCode : "+f.code);N=!1;a.logger(N+" >> signdata :: ("+(e==g)+") "+this._lang.IDS_MSGBOX_ERROR_VERIFY_SIGNED_DATA_OF_MD_TABLE+"\nerror code : "+f.code+"\nerror msg : "+f.message+"\na:"+e+"\nb:"+g);return}if(1==d.verifyResult)a.intergrity.data=d.content;else if(-1<navigator.userAgent.indexOf("compatible"))a.nimservice()?a.nimservice().VerifySignedData(null,b,function(b,c,d){0!=b?(a.ERROR.Code=a.nimservice().GetLastErrorCode(),a.ERROR.Message=a.nimservice().GetLastErrorMessage(),a.uiUtil().flagAlert(this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE+"\nErrCode : 1368"),N=!1):a.intergrity.data=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(d))}):(a.uiUtil().flagAlert(this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE+"\nErrCode : 1509"),N=!1);else{a.uiUtil().flagAlert(this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE+"\nErrCode : 1513");N=!1;a.logger(">> verifyResult :: "+this._lang.IDS_MSGBOX_ERROR_VERIFY_SIGNED_DATA_OF_MD_TABLE);return}try{c=a.usWebToolkit.pki.certificateToBase64(d.certificates[0])}catch(f){a.uiUtil().flagAlert(this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE+"\nErrCode : "+f.code);N=!1;a.logger(">> certificate error :: "+this._lang.IDS_MSGBOX_ERROR_GET_THE_CERT_FROM_SIGNED_DATA);return}}a.usWebToolkit.x509Certificate.parser(c,"Base64");Xa();b=a.usWebToolkit.x509Certificate.getSubjectName();if(!b||0>=b.length||"cn=crosscertwebv3,ou=stlab,o=crosscert,c=kr"!==b.toLowerCase())a.uiUtil().flagAlert(this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE+"\nErrCode : 1401"),N=!1,a.logger(">> get dn : "+this._lang.IDS_MSGBOX_ERROR_VERIFY_THE_CERT);else if(b=a.usWebToolkit.x509Certificate.getSubjectKeyIdentifier(),!b||0>=b.length||"9ecd6e86418013304666aff0c486a6c31a6fe363"!==b)a.uiUtil().flagAlert(this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE+"\nErrCode : 1411"),N=!1,a.logger(">> get ski : "+this._lang.IDS_MSGBOX_ERROR_VERIFY_THE_CERT)};Fa.prototype={verify:function(b,c){Xa();var d=a.intergrity.getList();if(!d||0>=d.length)return null;if(!b||!c)return this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE;this._md.start();this._md.update(c);c=this._md.digest().toHex();for(var e=0;e<d.length;e++)if(d[e].name==b){if(d[e].data==c)return"success";a.logger("*** Suspicion Forgery ***\nintergrity file name : "+d[e].name+"\nintergrity file md data : "+d[e].data+"\ndownloaded file name : "+b+"\ndownloaded file md data : "+c+"\n"+this._lang.IDS_MSGBOX_WARNING_SUSPICION_FORGERY);break}return this._lang.IDS_MSGBOX_ERROR_NEW_MESSAGE}};CheckIntergrity=function(){Xa();for(var b,c,d=0;d<Y.length;d++)if(b=Y[d].name,c=Y[d].data,rstr=a.forgeryUtil().verify(b,c),"success"===rstr)Y[d].name=null,Y[d].data=null,Y[d]=null;else if(rstr){Y[d].name=null;Y[d].data=null;Y[d]=null;a.uiUtil().flagAlert(rstr);N=!1;break}else return!1;return!0};String.prototype.endsWith=function(a){return this.length<a.length?!1:this.lastIndexOf(a)+a.length==this.length};String.prototype.startsWith=function(a){return this.length<a.length?!1:0==this.indexOf(a)};"undefined"!=typeof window.FileReader&&(ArrayBuffer.prototype.toBase64=function(){var a=new Uint8Array(this),c,d=a.length,e="";for(c=0;c<d;c+=3)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[a[c]>>2],e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(a[c]&3)<<4|a[c+1]>>4],e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(a[c+1]&15)<<2|a[c+2]>>6],e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[a[c+2]&63];2===d%3?e=e.substring(0,e.length-1)+"=":1===d%3&&(e=e.substring(0,e.length-2)+"==");return e},String.prototype.toArrayBuffer=function(){var a=.75*this.length,c=this.length,d=0;"="===this[this.length-1]&&(a--,"="===this[this.length-2]&&a--);var e=new ArrayBuffer(a),g=new Uint8Array(e);for(a=0;a<c;a+=4){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(this[a]);var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(this[a+1]);var k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(this[a+2]);var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(this[a+3]);g[d++]=f<<2|h>>4;g[d++]=(h&15)<<4|k>>2;g[d++]=(k&3)<<6|m&63}return e});var Ya=function(){};Ya.prototype={save:function(a,c){!a||0>=a.length||!c||(c=new Blob([c],{type:"application/octet-stream"}),Ea(c,a))}};var qa=null,H=null,R=0,L=null,la=navigator.platform,I=navigator.userAgent;qa=0<=la.indexOf("Win")?"win":0<=la.indexOf("Mac")?"mac":0<=la.indexOf("Linux")?"linux":0<=la.indexOf("iPhone")||0<=la.indexOf("iPad")||0<=la.indexOf("iPod")?"ios":"unknown";0<=I.indexOf("Android")&&(qa="android");"android"===qa?0<=I.indexOf("SAMSUNG")?(H="android samsung",L=/Version\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("OPR")?(H="android opera",L=/OPR\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Opera")?(H="android opera classic",L=/Version\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Firefox")?(H="android firefox",L=/Firefox\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("NAVER")?H="android naver":0<=I.indexOf("DaumApps")?(H="android daum",L=/DaumApps\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("nate_app")?H="android nate":0<=I.indexOf("UCBrowser")?(H="android uc",L=/UCBrowser\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Chrome")?0<=I.indexOf("Version")?(H=0<=I.indexOf("LG")?"android lg":"android browser",L=/Version\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("LG")?((L=/Chrome\/([0-9]{1,}[.0-9]{0,})/,L.exec(I))&&(R=parseFloat(RegExp.$1)),H=39>R?"android lg":"android chrome"):(H="android chrome",L=/Chrome\/([0-9]{1,}[.0-9]{0,})/):(H="unknown",R=0):"ios"===qa?0<=I.indexOf("CriOS")?(H="ios chrome",L=/CriOS\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("NAVER")?H="ios naver":0<=I.indexOf("DaumApps")?(H="ios daum",L=/DaumApps\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Coast")?(H="ios opera coast",L=/Coast\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Safari")?(H="ios safari",L=/Version\/([0-9]{1,}[.0-9]{0,})/):(H="unknown",R=0):0<=I.indexOf("MSIE")?(H="msie","BackCompat"==document.compatMode?R=5:document.documentMode?R=document.documentMode:L=/MSIE ([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Edge")||0<=I.indexOf("Edg")?(H="edge",L=/Edge\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("OPR")?(H="opera",L=/OPR\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Whale")?(H="whale",L=/whale\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Chrome")?(H="chrome",L=/Chrome\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Safari")?(H="safari",L=/Version\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Firefox")?(H="firefox",L=/Firefox\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("Opera")?(H="opera",L=/Version\/([0-9]{1,}[.0-9]{0,})/):0<=I.indexOf("rv:11.")?(H="msie",L=/rv:([0-9]{1,}[.0-9]{0,})/):(H="unknown",R=0);L&&L.exec(I)&&(R=parseFloat(RegExp.$1));var Xa=function(){return"msie"==H?10>R:"chrome"==H?10>R:"firefox"==H?10>R:"safari"==H?6.1>R:"opera"==H?15>R:!0},cb=window.console||{log:function(){}},Ob=J({intergrity:!1,name:"transfer_"+u.Language,url:"unisignweb/rsrc/lang/"+u.Language+"/transfer_"+u.Language+".js"}),Pb=J({intergrity:!1,name:"certverify_"+u.Language,url:"unisignweb/rsrc/lang/"+u.Language+"/certverify_"+u.Language+".js"}),a={ver:"1.0.4.29",nimVersion:"2.0.17.0",osName:qa,browserName:H,browserVersion:R,usWebToolkit:window.crosscert,isAvailable:function(){return null==N?!1:N},isSKModule:null,pubkey:null,intergrity:{data:null,list:null,getList:function(){null==this.list&&(this.list=this.parser(this.data));return this.list},parser:function(a){"string"!==typeof a&&(a=new String(a));var b=[];a=a.split(/\r\n|\r|\n/g);for(var d=0;d<a.length;d++){var e=a[d].split("|"),g={};g.name=e[0];g.data=e[1];b[d]=g}return b}},logger:function(a){},trace:function(a){},nimCheckUrl:xa,plugin:function(){return document.getElementById("unisignwebplugin")},nimservice:function(){return Qb},options:{img_src:null},ubiKeyEnv:{version:"1,3,0,7",siteInfo:"CROSSCERT|http://www.ubikey.co.kr/infovine/download.html",securityInfo:"CROSSCERT|NULL",downloadURL:"http://www.ubikey.co.kr/infovine/download.html"},usimEnv:{sitecode:"303010001",modecode:"0003",siteURL:document.location.hostname,serviceIP:"service.smartcert.kr",servicePort:"443",downloadURL:"http://download.smartcert.kr"},uiUtil:function(){return __UIUtil},certUtil:function(){return __CertUtil},forgeryUtil:function(){return __ForgeryUtil},fileUtil:function(){return __FileUtil},bsUtil:function(){return __BSUtil},uiLayerLevel:Ca,certsList:null,reInitialize:function(){VerifyPFLicense()&&(__ForgeryUtil=new Fa)},loadUI:function(b){if(!b||0>=b.length)return null;var c=b+".js";var d=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");a.uiUtil().isItPortableDevice()?"gridlist"!=b?(c="m_"+c,d.open("GET",u.SRCPath+"unisignweb/js/mobile/m_"+b+".js?version=1.0.4.29",!1)):d.open("GET",u.SRCPath+"unisignweb/js/"+b+".js?version=1.0.4.29",!1):d.open("GET",u.SRCPath+"unisignweb/js/"+b+".js?version=1.0.4.29",!1);d.send(null);var e=d.responseText;"certprocessing.js"!=c&&(c=a.forgeryUtil().verify(c,e),"success"!=c&&null!=c&&(a.uiUtil().flagAlert(c),N=!1));eval(d.responseText);return eval("__"+b)(a)},CCPFSH:function(){return Za},ActiveUI:null,ESVS:u,STATUS:{HadCheckedLicense:!1},PFSH:Ta,PFUC:null,PFCS:function(){return tb},Whale:function(){return ub},ERROR:{Code:0,Message:null},errPopup:function(b,c){var d=a.transferLang();switch(b){case 0:break;case -1:a.uiUtil().errMsgBox(d.IDS_CANCEL_PROCESS,b);break;case -2:a.uiUtil().errMsgBox(d.IDS_WRONG_PROCESS,b);break;case 2011:a.uiUtil().errMsgBox(d.IDS_ERR_WRONG_LICENSE,b);break;case 2012:a.uiUtil().errMsgBox(d.IDS_ERR_LICENSE_AUTHORITY,b);break;case 2013:a.uiUtil().errMsgBox(d.IDS_ERR_EXPIRED_LICENSE,b);break;case 2014:a.uiUtil().errMsgBox(d.IDS_ERR_DOMAIN_PARSING,b);break;case 2015:a.uiUtil().errMsgBox(d.IDS_ERR_LICENSE_PARSING,b);break;case 2016:a.uiUtil().errMsgBox(d.IDS_ERR_SIGN_VERIFYING,b);break;case -1001:case -1002:case -1003:case -1004:case -1005:case -1006:case -1007:case -1009:case -1010:case -1011:case -1012:case -1013:case -1015:case -1017:case -1018:case -1019:case -1021:case -1022:case -1023:case -1024:case -1054:case -1055:case -1056:a.uiUtil().errMsgBox(d.IDS_ERR_NETWORK,b);break;case -1008:a.uiUtil().errMsgBox(d.IDS_ERR_TIME_OUT,b);break;case -1020:a.uiUtil().errMsgBox(d.IDS_ERR_CANCEL,b);break;case -1033:a.uiUtil().errMsgBox(d.IDS_ERR_CREATE_NUM,b);break;case -1034:case -1035:case -1041:case -1042:case -1043:case -1044:case -1061:a.uiUtil().errMsgBox(d.IDS_ERR_MEMORY,b);break;case -1050:a.uiUtil().errMsgBox(d.IDS_ERR_INTERNET,b);break;case -1052:a.uiUtil().errMsgBox(d.IDS_ERR_CHECK_NUM,b);break;case -1110:a.uiUtil().errMsgBox(d.IDS_ERR_AUTH_NUM,b);break;case -1114:a.uiUtil().errMsgBox(d.IDS_ERR_PC_TO_PC,b);break;case -1200:case -1201:case -1202:case -1203:case -1204:case -1205:case -1206:a.uiUtil().errMsgBox(d.IDS_ERR_SIGN_VERIFYING,b);break;case -1207:case -1208:a.uiUtil().errMsgBox(d.IDS_INVALID_CONTEXT,b);break;default:c?a.uiUtil().errMsgBox(c,b):a.uiUtil().errMsgBox(d.IDS_ERR_TRANSFER,b)}},CONST:{__USFB_M_DISK:{device:1,name:"removable"},__USFB_M_HSMKEY:{device:2,name:"sectoken"},__USFB_M_SMARTCARD:{device:3,name:"savetoken"},__USFB_M_MOBILE:{device:4,name:"mobilephone"},__USFB_M_HDD:{device:5,name:"harddisk"},__USFB_M_MOBILETOKEN:{device:6,name:"mobiletoken"},__USFB_M_SECUREDISK:{device:7,name:"securedisk"},__USFB_M_ETC:{device:9,name:"USFB_M_ETC"},__PF_M_LS:{device:11,name:"webstorage"},__PF_M_TOUCHSIGN:{device:12,name:"touchsign"},__PF_M_SMARTSIGN:{device:13,name:"smartsign"},__PF_M_WEBSECTOKEN:{device:14,name:"websectoken"},__PF_M_WEBSOFTTOKEN:{device:15,name:"websofttoken"},__PF_M_CLOUDSIGN:{device:16,name:"cloudsign"},__PF_M_ETC:{device:19,name:"PF_M_ETC"},__PF_M_SS:{device:21,name:"browsersign"},__PF_M_CLOUD:{device:22,name:"cloud"},medias:{}},SELECTINFO:{index:0,pw:null,curdevice:5,cert:null,certattrs:null},transferLang:function(){return Ob},certVerifylang:function(){return Pb},changeDefaultMedia:function(){6==a.ESVS.Mode&&ia&&(K.defaultdevice=a.ESVS.Media.defaultdevice=u.Media.defaultdevice=ia)},CustomEval:function(a,c){return Nb(a,c)}};a.usWebToolkit.usWebCMP.info.CMPUrl=wa;__UIUtil=new Va;__CertUtil=new Wa;__ForgeryUtil=new Fa;__FileUtil=new Ya;__BSUtil=new sb;var Qb=function(){if(!(u.Mode&4))return null;eval(J({eval:!1,intergrity:!0,name:"nimservice",url:"unisignweb/js/nimservice.js"}));return eval("__nimservice")(a)}(a),Za=null,ub=null;-1!=K.list.indexOf("browsersign")&&(Za=ab(a));var tb=null;-1!=K.list.indexOf("cloudsign")&&(tb=xb(a));navigator.whaleCertManager&&"NPKI"==a.ESVS.PKI&&(ub=yb(a));-1!=K.list.split("|").indexOf("cloud")&&zb();var $a=function(){this.key="0123456789012345"};$a.prototype.setData=function(a){return crosscert.aes.CTREncrypt(a,this.key,256)};$a.prototype.getData=function(a){return crosscert.aes.CTRDecrypt(a,this.key,256)};if("undefined"!=typeof CloudNPKI&&CloudNPKI&&CloudNPKI.web){try{var vb=new $a;M.cloudWeb=new CloudNPKI.web(M.config,vb)}catch(b){window.console.log(b),a.cloudInfo=M.cloudWeb=null}a.cloudInfo=M;a.cloudInfo.secureFunc=vb;window.config=M.config}else a.cloudInfo=M.cloudWeb=null;"ahnlab"==a.ESVS.SecureKeyboardType&&(a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_KS_INSTALL_CHECK),$ASTX2.init(function(){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");a.isSKModule=!0},function(){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");a.isSKModule=!1;$ASTX2.getLastError()}));a.CONST.medias={removable:a.CONST.__USFB_M_DISK,sectoken:a.CONST.__USFB_M_HSMKEY,savetoken:a.CONST.__USFB_M_SMARTCARD,mobilephone:a.CONST.__USFB_M_MOBILE,harddisk:a.CONST.__USFB_M_HDD,mobiletoken:a.CONST.__USFB_M_MOBILETOKEN,securedisk:a.CONST.__USFB_M_SECUREDISK,webstorage:a.CONST.__PF_M_LS,browsersign:a.CONST.__PF_M_SS,touchsign:a.CONST.__PF_M_TOUCHSIGN,smartsign:a.CONST.__PF_M_SMARTSIGN,websectoken:a.CONST.__PF_M_WEBSECTOKEN,websofttoken:a.CONST.__PF_M_WEBSOFTTOKEN,cloudsign:a.CONST.__PF_M_CLOUDSIGN,cloud:a.CONST.__PF_M_CLOUD};VerifyLicense=function(){var b="";null!=a.ESVS.License&&"undefined"!==typeof a.ESVS.License&&(b=J({eval:!1,intergrity:!1,name:"License",url:a.ESVS.License}));if("touchen"==a.ESVS.SecureKeyboardType)a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_KS_INSTALL_CHECK),a.nimservice().GetCertForKeyboardEncrypt(document.domain,b,function(b,d,e){0==b?a.pubkey=e:a.ESVS.SecureKeyboardType="";a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");return!0});else return!0};VerifyPFLicense=function(){return!0};if(4&a.ESVS.Mode&&a.nimservice())VerifyLicense(function(a){});else if(!VerifyPFLicense())return;var wb=function(){CheckIntergrity()&&(Y=null,null==N&&(N=!0))};null!=a.intergrity.data?wb():setTimeout(wb,1E3);a.cloudInfo&&a.cloudInfo.cloudWeb&&(a.cloudInfo.cloudWeb.init(Cb,Db,Bb),a.cloudInfo.cloudWeb.initLicense(a.cloudInfo.siteCode,a.cloudInfo.domain,a.cloudInfo.customID,a.cloudInfo.APIKey),a.cloudInfo.cloudWeb.addUIEventListener(function(a,c,d){20010==a.code&&(confirm("\ub2e4\ub978 \uc774\ub984\uc73c\ub85c \uac00\uc785\ub41c \uc815\ubcf4\uac00 \uc788\uc2b5\ub2c8\ub2e4.\n\uc7ac\uac00\uc785 \ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?\n\uc800\uc7a5\ub41c \uc778\uc99d\uc11c\ub294 \ubaa8\ub450 \uc0ad\uc81c\ub429\ub2c8\ub2e4.")?c():d())}));a.CLOUD=new function(){var b=null;a.cloudInfo&&a.cloudInfo.cloudWeb&&(b=a.cloudInfo.cloudWeb);return{getCloudCertsList:function(a){if(b){var c=C();b.getCertificateListInfo().then(function(b){c.certsList=b;a(c)}).catch(function(b){a(C(b.code,b.message))});return!0}a(C(-1));return!1},getCloudUserCert:function(c,d,e){if(b){var g=C();b.getCertificate(c,a.cloudInfo.secureFunc.setData(d)).then(function(b){g.cert=b[0];g.cert.key=a.cloudInfo.secureFunc.getData(b[0].key);g.cert.kmkey=a.cloudInfo.secureFunc.getData(b[0].kmkey);g.cert.pwd=a.usWebToolkit.util.decode64(a.cloudInfo.secureFunc.getData(b[0].secret));e(g)}).catch(function(a){g=C(a.code,a.message);20109==a.code&&(g.errorCount=a.error_count);e(g)})}else e(C(-1));return!0},uploadCert:function(c,d,e,g){if(b){var f=C();d=a.cloudInfo.secureFunc.setData(d);e=a.cloudInfo.secureFunc.setData(e);b.importCertificate(d,e,c.signcert,c.signpri,c.kmcert,c.kmpri).then(function(a){g(f)}).catch(function(a){g(C(a.code,a.message))})}else return g(C(-1)),!1},exportCert:function(c,d,e,g){if(b){var f=C();e=a.cloudInfo.secureFunc.setData(e);d=a.cloudInfo.secureFunc.setData(d);b.exportCertificate([c],d,e).then(function(a){f.signCert=a[0].cert;f.signPri=a[0].key;a.kmcert&&(f.kmCert=a[0].kmcert,f.kmPri=a[0].kmkey);g(f)}).catch(function(a){g(C(a.code,a.message))})}else return g(C(-1)),!1},deleteCert:function(a,d){if(b){var c=C();b.deleteCertificate([a]).then(function(a){d(c)}).catch(function(a){d(C(a.code,a.message))})}else return d(C(-1)),!1},changePin:function(c,d,e,g){if(b){var f=C();d=a.cloudInfo.secureFunc.setData(d);e=a.cloudInfo.secureFunc.setData(e);b.changePin([c],d,e).then(function(a){g(f)}).catch(function(a){g(C(a.code,a.message))})}else return g(C(-1)),!1},checkConn:function(a){if(b)b.checkConnect().then(function(b){a(!0)}).catch(function(b){a(!1)});else return a(C(-1)),!1},disConnect:function(a){if(b){var c=C();b.checkConnect().then(function(d){d?b.disConnect().then(function(b){a(c)}).catch(function(b){a(C(b.code,b.message))}):a(c)}).catch(function(b){a(C(b.code,b.message))})}else return a(C(-1)),!1},getUserInfo:function(a){if(b){var c=C();b.getUserInfo().then(function(b){c.name=b.name;c.hp=b.phone_number;a(c)}).catch(function(b){a(C(b.code,b.message))})}else return a(C(-1)),!1},getAutoConnectInfo:function(a){if(b){var c=C();b.getAutoConnectInfo().then(function(b){c.autoConnectInfo=b;a(c)}).catch(function(b){a(C(b.code,b.message))})}else return a(C(-1)),!1},getCertificateHistory:function(a){if(b){var c=C();b.getCertHistory().then(function(b){c.certHistory=b;a(c)}).catch(function(b){a(C(b.code,b.message))})}else return a(C(-1)),!1},getUserHistory:function(a){if(b){var c=C();b.getMemeberHistory().then(function(b){c.userHistory=b;a(c)}).catch(function(b){a(C(b.code,b.message))})}else return a(C(-1)),!1},getConnectionHistory:function(a){if(b){var c=C();b.getConnectHistory().then(function(b){c.connectionHistory=b;a(c)}).catch(function(b){a(C(b.code,b.message))})}else return a(C(-1)),!1},unlockCertificate:function(a,d){if(b){var c=C();b.activeCertificate([a]).then(function(a){d(c)}).catch(function(a){d(C(a.code,a.message))})}else return d(C(-1)),!1},deleteAccount:function(a){if(b){var c=C();b.deleteAccount().then(function(b){a(c)}).catch(function(b){a(C(b.code,b.message))})}else return a(C(-1)),!1},deleteAutoConnect:function(a,d){if(b){var c=C();b.deleteAutoConnect(a).then(function(a){d(c)}).catch(function(a){d(C(a.code,a.message))})}else return d(C(-1)),!1}}};if(a.PFSH)try{a.PFSH.LoadAllCerts(document.domain)}catch(b){301E5===b.code?(a.PFSH.InstallCACerts(document.domain),a.PFSH.LoadAllCerts(document.domain)):cb=window.console||{log:function(){}}}4<P&&"harddisk"!=K.defaultdevice&&"harddisk"==ia&&Ib();return{Available:function(){return a.isAvailable()},isMilPKI:function(){return 0<=a.ESVS.PKI.indexOf("MilPKI")?!0:!1},GetLocale:function(b){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b)return!1;var c=n();4&a.ESVS.Mode?a.nimservice().GetLocale(function(d,e,g){0==d?(c.locale=g,b(c)):(a.ERROR.Code=d,a.ERROR.Message=e,b(n(a.ERROR.Code,a.ERROR.Message)))}):(c.locale=navigator.language,b(c))}},IsValidity:function(){return 0==a.isAvailable()?(a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE),!1):a.nimservice()?!0:!1},GetLastError:function(b){0==a.isAvailable()?a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE):(b(a.ERROR.Code,a.ERROR.Message),a.ERROR.Code=0,a.ERROR.Message=null)},SetEmbeddedUI:function(b){0==a.isAvailable()?a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE):a.ESVS.Embedded=b?!0:!1},SignDataP1:function(b,c,d){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||!d||document.getElementById("us-div-cert-select"))return!1;var e=n(),g=function(a){1==d.length?d(a):(null==a&&(a=n()),d(a.signedData,a.theCert,a.theDN))};a.reInitialize();var f=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P1",args:{dn:c,possibleWhale:!0},onConfirm:function(c,d,m,l,t,q,r){e.theCert=c;e.theDN=d;if("undefined"!==typeof l&&"undefined"!==typeof t){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(q))if(q!=a.CONST.__USFB_M_DISK.device&&q!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(q==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){var h=a.usWebToolkit.md.algorithms.sha256.create();h.start();h.update(a.usWebToolkit.util.encodeUtf8(b));d=h.digest().toHex();d=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+d);m={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(b){b=JSON.parse(b);if(0!=b.returnObj.returnCode&&"E1000"!=b.returnObj.returnCode)e.resultMessage=a.ERROR.Message=b.returnObj.returnMsg,e.resultCode=a.ERROR.Code=b.returnObj.returnCode,setTimeout(function(){f.dispose(!0)},10),g(e);else if("E1000"==b.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(e),setTimeout(function(){f.dispose(!0)},10),g(e);else{var c=b.signResult.b64Signer;_certAttrs=a.certUtil().getTheCertAttributes(c,"Base64");D(l,t,q,c,_certAttrs);e.certAttrs=_certAttrs;e.signedData=b.signResult.b64SignedData[0];e.theCert=b.signResult.b64Signer;e.theDN=_certAttrs.subjectName;e.tokenlabel="";g(e);setTimeout(function(){f.dispose()},10)}},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]};m.msg[0]=d;m.plainText=[];m.plainText[0]=a.usWebToolkit.util.encodeUtf8(b);jSmartCertNP.SignByJSON(m).Open()}else a.nimservice()?Q(l,q,function(d){0!=d.rv?(a.ERROR.Code=e.resultCode=d.rv,a.ERROR.Message=e.resultMessage=d.rvMsg,a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){f.dispose()},10),g(e)):(d=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().GetSignDataP1(l,t,d,null,!1,function(b,d,h,k,p,l){0!=b?(a.ERROR.Code=e.resultCode=b,a.ERROR.Message=e.resultMessage=d,a.uiUtil().errMsgBox(d,b)):(null==c&&a.CONST.__USFB_M_MOBILETOKEN.device==q&&(_certAttrs=a.certUtil().getTheCertAttributes(p,"Base64"),e.theCert=p,e.theDN=_certAttrs.subjectName),e.signedData=h,e.tokenlabel=l,null!=r&&q==a.CONST.__USFB_M_HSMKEY.device&&(e.tokenName=r.name,e.tokenDriver=r.driver));g(e);a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){f.dispose()},10)}))}):(a.ERROR.Code=e.resultCode=-1,a.ERROR.Message=e.resultMessage=a.uiUtil().getErrorMessageLang().IDS_MSGBOX_NIM_ERROR_UNLOAD,g(e),setTimeout(function(){f.dispose(!0)},10));else-1==l||""==t?(e.resultMessage=a.ERROR.Message=m,e.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){f.dispose(!0)},10),g(e)):(a.uiUtil().loadingBox(!0,"us-div-list-load",1),d=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.Whale().getSignDataP1(d,l,t,function(b,c,d){0!=b?(e.resultCode=b,e.resultMessage=c):(e.signedData=d,e.tokenlabel="");setTimeout(function(){f.dispose()},10);a.uiUtil().loadingBox(!1,"us-div-list-load",1);g(e)}));else if(q==a.CONST.__PF_M_CLOUDSIGN.device)a.uiUtil().loadingBox(!0,"us-div-list-load",1),a.PFCS().reqGenSignNonVerifyPin(l,a.usWebToolkit.util.encodeUtf8(b),"Y",function(b,c,d){0!=b&&(a.ERROR.Code=b,a.ERROR.Message=c,setTimeout(function(){f.dispose()},10),g(n(b,c)));e.signedData=d;setTimeout(function(){f.dispose()},10);g(e)});else{try{var k=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[l].signcert),w=a.usWebToolkit.pkcs8.decryptRsaPrivateKeyFromBase64(a.PFUC[l].signpri,t);h=null;switch(a.usWebToolkit.pki.oids[k.signatureOid]){case "sha1WithRSAEncryption":h=crosscert.md.algorithms.sha1.create();break;case "kcdsaWithSHA1":k.md=crosscert.md.algorithms.sha1.create();break;case "md5WithRSAEncryption":h=crosscert.md.algorithms.md5.create();break;case "sha256WithRSAEncryption":h=crosscert.md.algorithms.sha256.create();break;case "RSASSA-PSS":h=crosscert.md.algorithms.sha256.create()}h.update(a.usWebToolkit.util.encodeUtf8(b));var z=w.sign(h);e.signedData=a.usWebToolkit.util.encode64(z);g(e)}catch(B){a.ERROR.Code=B.code,a.ERROR.Message=B.message,a.uiUtil().errMsgBox(m,a.ERROR.Code),g(n(a.ERROR.Code,a.ERROR.Message))}setTimeout(function(){f.dispose()},10)}l=t=k=pri=null}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg(e);g(e);f.dispose(!0)}});f.show();return!0}},VerifySignedDataP1:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else if(b&&c&&d||e(-1),a.reInitialize(),4&a.ESVS.Mode&&a.ESVS.chkEXESetup)if(null!=a.Whale()){c=a.usWebToolkit.util.decode64(c);d=a.usWebToolkit.pki.certificateFromBase64(d);var g=ra(d);g.update(a.usWebToolkit.util.encodeUtf8(b));try{var f=d.publicKey.verify(g.digest().getBytes(),c)}catch(h){f=!1}f?e(0):e(-1)}else a.nimservice()&&(b=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().VerifyP1SignData(b,c,d,function(b,c){0!=b&&(a.ERROR.Code=a.nimservice().GetLastErrorCode(),a.ERROR.Message=a.nimservice().GetLastErrorMessage());e(b);a.uiUtil().loadingBox(!1,"us-div-list-load")}));else{c=a.usWebToolkit.util.decode64(c);d=a.usWebToolkit.pki.certificateFromBase64(d);g=ra(d);g.update(b);try{f=d.publicKey.verify(g.digest().getBytes(),c)}catch(h){f=!1}return f?0:-1}},SignDataP7:function(b,c,d,e,g){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||!g||document.getElementById("us-div-cert-select"))return!1;var f=n(),h=function(a){1==g.length?g(a):(null==a&&(a=n(-1)),g(a.signedData,a.curDevice,a.certAttrs,a.b64RValue))};a.reInitialize();var k=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:c,possibleWhale:!0},onConfirm:function(c,g,t,q,r,p,v){var l=t;if("undefined"!==typeof q&&"undefined"!==typeof r)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(p))p!=a.CONST.__USFB_M_DISK.device&&p!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?p==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP?(c=a.usWebToolkit.md.algorithms.sha256.create(),c.start(),c.update(a.usWebToolkit.util.encodeUtf8(b)),c=c.digest().toHex(),c=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+c),t={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(c){c=JSON.parse(c);if(0!=c.returnObj.returnCode&&"E1000"!=c.returnObj.returnCode)f.resultMessage=a.ERROR.Message=c.returnObj.returnMsg,f.resultCode=a.ERROR.Code=c.returnObj.returnCode,setTimeout(function(){k.dispose(!0)},10),h(f);else if("E1000"==c.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(f),setTimeout(function(){k.dispose(!0)},10),h(f);else{var d=c.signResult.b64Signer;l=a.certUtil().getTheCertAttributes(d,"Base64");D(q,r,p,d,l);f.certAttrs=l;var g=a.usWebToolkit.util.decode64(c.signResult.b64SignedData[0]);d=a.usWebToolkit.pki.certificateFromBase64(d);var v=a.usWebToolkit.pkcs7.createSignedData();v.signWithP1(g,b,d,null,null);f.signedData=a.usWebToolkit.pkcs7.messageToBase64(v);f.curDevice=p;if(e)try{var m=a.usWebToolkit.util.decode64(c.signResult.R[0]),w=a.usWebToolkit.pki.certificateFromBase64(e);v=a.usWebToolkit.pkcs7.createEnvelopedData();v.addRecipient(w);v.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];v.content=m;v.encrypt();f.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(v)}catch(Eb){}f.tokenLabel="";h(f);setTimeout(function(){k.dispose()},10)}},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]},t.msg[0]=c,d&&(t.plainText=[],t.plainText[0]=a.usWebToolkit.util.encodeUtf8(b)),jSmartCertNP.SignByJSON(t).Open()):a.nimservice()?(a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[1]),Q(q,p,function(c){0!=c.rv?(a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"),a.ERROR.Code=f.resultCode=c.rv,a.ERROR.Message=f.resultMessage=c.rvMsg,setTimeout(function(){k.dispose()},10),h(f)):(c=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().GetSignDataP7(q,r,c,T,d,e,a.ESVS.multiuse,!1,function(b,c,d,e,w,t){setTimeout(function(){k.dispose()},10);a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=b?(a.ERROR.Code=f.resultCode=b,a.ERROR.Message=f.resultMessage=c):(null==l&&a.CONST.__USFB_M_MOBILETOKEN.device==p?(l=a.certUtil().getTheCertAttributes(w,"Base64"),D(q,r,p,w,l)):D(q,r,p,g,l),f.certAttrs=l,f.signedData=d,f.curDevice=p,f.b64RValue=e,f.tokenLabel=t,null!=v&&p==a.CONST.__USFB_M_HSMKEY.device&&(f.tokenName=v.name,f.tokenDriver=v.driver));h(f);q=r=g=m=null}))})):(a.ERROR.Code=f.resultCode=-1,a.ERROR.Message=f.resultMessage=a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER,h(f),setTimeout(function(){k.dispose(!0)},10)):-1==q||""==r?(f.resultMessage=a.ERROR.Message=c,f.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){k.dispose(!0)},10),h(f)):(a.uiUtil().loadingBox(!0,"us-div-list-load",1),c=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.Whale().getSignDataP7(c,q,r,d,function(b,c,d){0!=b?(f.resultCode=b,f.resultMessage=c,a.uiUtil().loadingBox(!1,"us-div-list-load",1),h(f),setTimeout(function(){k.dispose()},10)):(f.certAttrs=l,f.signedData=d,f.curDevice=p,e?a.Whale().getCertR(q,r,function(b,c,d){a.uiUtil().loadingBox(!1,"us-div-list-load",1);if(0==b)try{var g=a.usWebToolkit.util.hexToBytes(d),r=a.usWebToolkit.pki.certificateFromBase64(e),p=a.usWebToolkit.pkcs7.createEnvelopedData();p.addRecipient(r);p.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];p.content=g;p.encrypt();f.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(p)}catch(Sb){}h(f);setTimeout(function(){k.dispose()},10)}):(a.uiUtil().loadingBox(!1,"us-div-list-load",1),h(f),setTimeout(function(){k.dispose()},10)))}));else if(p==a.CONST.__PF_M_CLOUDSIGN.device)-1==q?(f.resultMessage=a.ERROR.Message=c,f.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){k.dispose(!0)},10),h(f)):(a.uiUtil().loadingBox(!0,"us-div-list-load",1),a.PFCS().reqGetCertR(q,function(c,d,v){0!=c&&(f.resultCode=c,f.resultMessage=d,setTimeout(function(){k.dispose()},10),h(n(c,d)));a.PFCS().reqGenSignNonVerifyPin(q,a.usWebToolkit.util.encodeUtf8(b),"Y",function(c,d,w){0!=c?(a.ERROR.Code=c,a.ERROR.Message=d,h(n(c,d))):(D(q,r,p,g,l),c=a.usWebToolkit.util.decode64(w),d=a.usWebToolkit.pki.certificateFromBase64(g),w=crosscert.pkcs7.createSignedData(),w.signWithP1(c,b,d,null,null),f.signedData=a.usWebToolkit.pkcs7.messageToBase64(w),f.curDevice=p,f.RValue=v,e&&(c=a.usWebToolkit.util.hexToBytes(v),d=a.usWebToolkit.pki.certificateFromBase64(e),w=a.usWebToolkit.pkcs7.createEnvelopedData(),w.addRecipient(d),w.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"],w.content=c,w.encrypt(),f.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(w)),h(f));a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k.dispose()},10);q=r=g=m=null})}));else if(-1==q||""==r)f.resultMessage=a.ERROR.Message=c,f.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){k.dispose(!0)},10),h(f);else{try{g=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[q].signcert);var m=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[q].signpri),B=a.usWebToolkit.pkcs7.createSignedData();B.sign(b,g,m,r,null,null);var A=a.usWebToolkit.pkcs8.decryptPrivateKeyInfo(m,r),E=a.usWebToolkit.pkcs8.getPrivateKeyAttributesRandom(A);D(q,r,p,g,l);f.signedData=a.usWebToolkit.pkcs7.messageToBase64(B);f.RValue=a.usWebToolkit.util.bytesToHex(E);f.certAttrs=l;f.curDevice=p;if(e){var F=a.usWebToolkit.pki.certificateFromBase64(e),y=a.usWebToolkit.pkcs7.createEnvelopedData();y.addRecipient(F);y.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];y.content=E;y.encrypt();f.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(y)}h(f)}catch(G){a.ERROR.Code=G.code,a.ERROR.Message=G.message,112047==G.code&&(a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD),a.uiUtil().errMsgBox(a.ERROR.Message,a.ERROR.Code),h(n(G.code,G.message))}setTimeout(function(){k.dispose()},10);q=r=g=m=null}else f.resultMessage=a.ERROR.Message=c,f.resultCode=a.ERROR.Code=43021E3,f.theDN="",setTimeout(function(){k.dispose(!0)},10),h(f)},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg(f);h(f);k.dispose(!0)}});k.show();return!0}},VerifySignedDataP7:function(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b)return null;var d=null;a.reInitialize();if(2&a.ESVS.Mode){d=null;try{d=a.usWebToolkit.pkcs7.messageFromBase64(b),d.verify()}catch(e){if(a.ERROR.Code=e.code,a.ERROR.Message=e.message,c)c(null);else return null}if(d.verifyResult)if(d=d.content,c)c(d);else return d}else if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(a.SELECTINFO.curdevice))if(null!=a.Whale()){d=null;try{d=a.usWebToolkit.pkcs7.messageFromBase64(b),d.verify()}catch(e){if(a.ERROR.Code=e.code,a.ERROR.Message=e.message,c)c(null);else return null}if(d.verifyResult)if(d=d.content,c)c(d);else return d}else a.nimservice()&&a.nimservice().VerifySignedData(null,b,function(b,d,f){0!=b?(a.ERROR.Code=a.nimservice().GetLastErrorCode(),a.ERROR.Message=a.nimservice().GetLastErrorMessage(),c(null)):c(a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(f)));a.uiUtil().loadingBox(!1,"us-div-list-load")});else{d=null;try{d=a.usWebToolkit.pkcs7.messageFromBase64(b),d.verify()}catch(e){return a.ERROR.Code=e.code,a.ERROR.Message=e.message,null}if(d.verifyResult)return d=d.content}}},SignDataP7Ext:function(b,c,d,e,g,f){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!c&&!d||document.getElementById("us-div-cert-select")||!g)return!1;var h=n();b||(b="DIGITAL_SIGNATURE_P7_EXT");a.reInitialize();var k=a.loadUI("certselect")({type:b,args:{dn:e,possibleWhale:!1},onConfirm:function(b,c,e,f,r){4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(r)&&(a.nimservice()?a.nimservice().GetSignDataP7(c,e,d,T,!0,null,!0,!1,function(b,d,l,q,m,t){0!=b?(a.ERROR.Code=h.resultCode=b,a.ERROR.Message=h.resultMessage=d,a.uiUtil().errMsgBox(d,a.ERROR.Code)):(h.signedData=l,h.certIndex=c,h.password=e,h.curDevice=f,h.curDrive=r,h.tokenLabel=t);g(h);a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k.dispose()},10)}):(setTimeout(function(){k.dispose(!0)},10),g(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER))))},onCancel:function(){k.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg(h);g(h)}});k.show();return!0}},SelectMediaForCertImporting:function(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b)return!1;var d=n();a.reInitialize();Dialog=a.loadUI("storageselect")({type:"CERT_STORAGE",args:{possibleWhale:!1},onConfirm:function(e,g){Dialog.dispose();2===e||3===e?(PWDialog=a.loadUI("password")({type:null,args:null,onConfirm:function(f){PWDialog.dispose();var h=null;h=2===e?"PIN_SECURITY_TOKEN":"PIN_SAVE_TOKEN";PINDialog=a.loadUI("pin")({type:h,args:null,onConfirm:function(a){PINDialog.dispose();d.curDevice=e;d.curDrive=g;d.password=f;d.pin=a;b(d);f=null},onCancel:function(){PINDialog.dispose();f=null;a.uiUtil().getUserCancelErrCodeNMsg();c&&c()}});PINDialog.show()},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();c&&c()}}),PWDialog.show()):(d.curDevice=e,d.curDrive=g,d.password=null,d.pin=null,b(d))},onCancel:function(){Dialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();c&&c()}});Dialog.show()}},ExportCert:function(b,c,d,e,g,f){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b)return null;var h=n();a.reInitialize();if(-1==b){var k=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_EXT_DISABLE_SECTOKEN",args:{dn:null,possibleWhale:!1},onConfirm:function(b,c,d,g,r){4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(r)&&(a.nimservice()?a.nimservice().ExportCertEx(g,r,c,e,d,function(a,b,c){h.resultCode=a;h.resultMessage=b;h.pfx=c;f(h)}):f(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)));setTimeout(function(){k.dispose()},10)},onCancel:function(){k.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg(h);f(h)}});k.show()}else 4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(c)&&(a.nimservice()?a.nimservice().ExportCertEx(c,d,b,e,g,function(a,b,c){h.resultCode=a;h.resultMessage=b;h.pfx=c;f(h)}):f(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)))}},ImportCert:function(b,c,d,e,g,f,h){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(1>d||0>e)return-1;a.reInitialize();4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(d)&&(a.nimservice()?a.nimservice().ImportCertEx(d,e,g,f,b,c,function(a,b){h(n(a,b))}):h(n(-1,a.uiUtil().getErrorMessageLang().IDS_MSGBOX_NIM_ERROR_UNLOAD)));return-1}},IssueCert:function(b,c,d){function e(b,c,d,e,f){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(b))if(b!=a.CONST.__USFB_M_DISK.device&&b!=a.CONST.__USFB_M_HDD.device||null==a.Whale())a.nimservice()?(g=a.loadUI("certprocessing"),IssuingDialog=g({type:"CERT_ISSUE",args:null,onConfirm:null,onCancel:null}),IssuingDialog.show(),setTimeout(function(){a.nimservice().GetAllUserCertListNum(5,0,"",function(g,p,r){a.nimservice().IssueCertificate(a.ESVS.CMPIP,a.ESVS.CMPPort,h,k,d,e,b,c,f,function(b,c){d=f=null;if(0!=b)return a.ERROR.Code=a.nimservice().GetLastErrorCode(),a.ERROR.Message=a.nimservice().GetLastErrorMessage(),IssuingDialog.dispose(b,a.ERROR.Code,a.ERROR.Message,!1,function(){m(n(b,c))}),!1;IssuingDialog.dispose(b,0,null,!1,function(){m(n(b))});return!0})})},1E3)):(m(n(-1)),d=f=null);else{var g=a.loadUI("certprocessing");IssuingDialog=g({type:"CERT_ISSUE",args:null,onConfirm:null,onCancel:null});IssuingDialog.show();g="root";b==a.CONST.__USFB_M_DISK.device&&(g="");a.Whale().issueCertificate(h,k,e,g,c,function(b,c){if(0!=b)return IssuingDialog.dispose(b,a.ERROR.Code,a.ERROR.Message,!1,function(){m(n(b,c))}),!1;IssuingDialog.dispose(b,0,null,!1,function(){m(n(b))});return!0})}else if(2&a.ESVS.Mode&&a.uiUtil().isItPFDevice(b)){var r=function(b){if(b==a.CONST.__PF_M_LS.device){if(!a.PFSH)return m(null),!1;try{a.usWebToolkit.usWebCMP.issueCert(h,k,d,document.domain,"",a.PFSH,function(b,c,e){1===b?IssuingDialog.dispose(0,0,null,!0,function(){var b=a.loadUI("confirm")({type:null,args:{msg:p.IDS_CONFIRMBOX_WILL_YOU_BACKUP_CERT},onConfirm:function(){b.dispose();a.uiUtil().isItPortableDevice()?fb():eb(d);d=null;m(n())},onCancel:function(){b.dispose();d=null;m(n(998,a.uiUtil().getErrorMessageLang().IDS_CANCEL_BACKUP))}});b.show()}):(2===b?(a.ERROR.Code=-1,a.ERROR.Message=c,IssuingDialog.dispose(-1,a.ERROR.Code,a.ERROR.Message,!0,function(){m(n(a.ERROR.Code,a.ERROR.Message))})):(a.ERROR.Code=e.code,a.ERROR.Message=e.message,IssuingDialog.dispose(-2,a.ERROR.Code,a.ERROR.Message,!0,function(){m(n(a.ERROR.Code,a.ERROR.Message))})),d=null)})}catch(y){a.ERROR.Code=y.code,a.ERROR.Message=y.message,IssuingDialog.dispose(-2,a.ERROR.Code,a.ERROR.Message,!1,function(){m(n(a.ERROR.Code,a.ERROR.Message))}),d=null}}else if(b==a.CONST.__PF_M_SS.device)try{var c=function(b,c,e){1==b?IssuingDialog.dispose(0,0,null,!0,function(){var b=a.loadUI("confirm")({type:null,args:{msg:p.IDS_CONFIRMBOX_WILL_YOU_BACKUP_CERT},onConfirm:function(){b.dispose();a.uiUtil().isItPortableDevice()?hb():gb(d);d=null;m(n())},onCancel:function(){b.dispose();d=null;m(n(998,a.uiUtil().getErrorMessageLang().IDS_CANCEL_BACKUP))}});b.show()}):2==b?IssuingDialog.dispose(b,b,c,!0,function(){m(n(b,c))}):3==b&&(b=e.code,IssuingDialog.dispose(b,b,e.message,!0,function(){m(n(e.code,e.message))}))},e=function(b,c,d,e){a.CCPFSH().SaveUserCert(d,c,!0,function(a,b){0!=a?e(!1):e(!0)})};a.CCPFSH().GetCCStorageHandler(u.EncAlgo,u.HashAlgo,u.BSPKI,function(b,f){a.usWebToolkit.usWebCMP.issueCert(h,k,d,null,"",f,c,null,null,e)})}catch(y){a.ERROR.Code=y.code,a.ERROR.Message=y.message,IssuingDialog.dispose(-2,a.ERROR.Code,a.ERROR.Message,!0,function(){m(n(y.code,y.message))}),d=null}};g=a.loadUI("certprocessing");IssuingDialog=g({type:"CERT_ISSUE",args:null,onConfirm:null,onCancel:null});IssuingDialog.show();g=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");g.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/lang/"+a.ESVS.Language+"/certbackup_"+a.ESVS.Language+".js?version="+a.ver,!1);g.send(null);var p=eval(g.responseText);setTimeout(function(){r(b)},1E3)}}function g(b,c,d){6===b?e(b,c,"",d):(PWDialog=a.loadUI(2===b?"pin":"newpassword")({type:null,args:null,onConfirm:function(a,f){PWDialog.dispose();e(b,c,a,f,d)},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();m(n(a.ERROR.Code,a.ERROR.Message));PWDialog.dispose()}}),PWDialog.show())}function f(){l=a.loadUI("storageselect")({type:"CERT_STORAGE",args:{possibleWhale:!0},onConfirm:function(b,c,d){l.dispose();0==a.ESVS.IssueCertInBIOToken&&b==a.CONST.__USFB_M_HSMKEY.device&&-1!=d.indexOf("BIO_")?(a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_CANT_ISSUECERT_BIOTOKEN,m(n(a.ERROR.Code,a.ERROR.Message))):3===b?(PINDialog=a.loadUI("pin")({type:"PIN_SAVE_TOKEN",args:null,onConfirm:function(a){PINDialog.dispose();g(b,c,a)},onCancel:function(){PINDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();m(n(a.ERROR.Code,a.ERROR.Message))}}),PINDialog.show()):g(b,c,"")},onCancel:function(){l.dispose();a.uiUtil().getUserCancelErrCodeNMsg();m(n(a.ERROR.Code,a.ERROR.Message))}});l.show()}if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!d)return!1;var h=b,k=c,m=d;a.reInitialize();if(h&&k)f();else{var l=a.loadUI("certissue")({type:null,args:null,onConfirm:function(a,b){h=a;k=b;l.dispose();f()},onCancel:function(){l.dispose();a.uiUtil().getUserCancelErrCodeNMsg();m(n(a.ERROR.Code,a.ERROR.Message))}});l.show()}return!0}},IssueKMCert:function(b){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else if(b&&!document.getElementById("us-div-cert-select")){var c=n();a.reInitialize();var d=a.loadUI("certselect")({type:"CERT_RENEWAL_KMCERT",args:{dn:null,possibleWhale:!1},onConfirm:function(e,g,f,h,k,m){d.dispose();if(confirm(g)){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(f))return a.nimservice()?(RenewingDialog=a.loadUI("certprocessing")({type:"CERT_ISSUE",args:null,onConfirm:null,onCancel:null}),RenewingDialog.show(),a.nimservice().IssueKMCertificate(a.ESVS.CMPIP,a.ESVS.CMPPort,k,m,function(d,e){0==d?RenewingDialog.dispose(0,0,null,!0,function(){b(c)}):(a.ERROR.Code=d,a.ERROR.Message=e,RenewingDialog.dispose(d,a.ERROR.Code,a.ERROR.Message,!1,function(){b(n(d,e))}))})):b(n(-1)),!1}else a.uiUtil().getUserCancelErrCodeNMsg(),b(n(a.ERROR.Code,a.ERROR.Message))},onCancel:function(){d.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();b(n(a.ERROR.Code,a.ERROR.Message))}});d.show();return!0}},RevocateCert:function(b,c){function d(b,c,d,f){var h=a.loadUI("certrevoke")({type:null,args:null,onConfirm:function(f){h.dispose();if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(d))if(d!=a.CONST.__USFB_M_DISK.device&&d!=a.CONST.__USFB_M_HDD.device||null==a.Whale())a.nimservice()?(k=a.loadUI("certprocessing"),RevokingDialog=k({type:"CERT_REVOCATION",args:null,onConfirm:null,onCancel:null}),RevokingDialog.show(),a.nimservice().RevokeCertificate(a.ESVS.CMPIP,a.ESVS.CMPPort,b,c,f,1,function(a,b){0===a?RevokingDialog.dispose(0,null,null,!0,function(){e(n(0))}):RevokingDialog.dispose(a,a,b,!1,function(){e(n(a,b))})})):(ca(),e(n(-1)));else{var k=a.loadUI("certprocessing");RevokingDialog=k({type:"CERT_REVOCATION",args:null,onConfirm:null,onCancel:null});RevokingDialog.show();k="key_compromise";switch(parseInt(f)){case 1:k="key_compromise";break;case 3:k="affiliation_changed";break;case 5:k="cessation_of_operation"}a.Whale().revokeCertificate(b,c,k,function(a,b){0===a?RevokingDialog.dispose(0,null,null,!0,function(){e(n(0))}):RevokingDialog.dispose(a,a,b,!1,function(){e(n(a,b))})})}else if(2&a.ESVS.Mode&&a.uiUtil().isItPFDevice(d)){var p=function(){if(d==a.CONST.__PF_M_LS.device)return a.PFSH;if(d==a.CONST.__PF_M_SS.device)return a.CCPFSH()};k=a.loadUI("certprocessing");RevokingDialog=k({type:"CERT_REVOCATION",args:null,onConfirm:null,onCancel:null});RevokingDialog.show();setTimeout(function(){var d=a.usWebToolkit.usWebCMP.revReason.keyCompromise;switch(f){case 1:d=a.usWebToolkit.usWebCMP.revReason.keyCompromise;break;case 3:d=a.usWebToolkit.usWebCMP.revReason.afilationChanged;break;case 5:d=a.usWebToolkit.usWebCMP.revReason.superseded}try{a.usWebToolkit.usWebCMP.revocation(a.PFUC[b].signcert,a.PFUC[b].signpri,a.PFUC[b].kmcert,c,document.domain,d,p(),function(d,f,h){b=0;c=null;1===d?RevokingDialog.dispose(0,0,null,!0,function(){e(g)}):2===d?(a.ERROR.Code=-1,a.ERROR.Message=f,g.resultCode=a.ERROR.Code,g.resultMessage=a.ERROR.Message,RevokingDialog.dispose(-1,a.ERROR.Code,a.ERROR.Message,!0,function(){e(g)})):(a.ERROR.Code=h.code,a.ERROR.Message=h.message,g.resultCode=a.ERROR.Code,g.resultMessage=a.ERROR.Message,RevokingDialog.dispose(-2,a.ERROR.Code,a.ERROR.Message,!0,function(){e(g)}))})}catch(w){b=0,c=null,a.ERROR.Code=w.code,a.ERROR.Message=w.message,g.resultCode=a.ERROR.Code,g.resultMessage=a.ERROR.Message,RevokingDialog.dispose(-2,a.ERROR.Code,a.ERROR.Message,!0,function(){e(g)})}},1E3)}},onCancel:function(){ca();h.dispose();a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}});h.show()}if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else if(b&&!document.getElementById("us-div-cert-select")){var e=b,g={};a.reInitialize();var f=a.loadUI("certselect")({type:"CERT_REVOCATION",args:{dn:null,possibleWhale:!0},onConfirm:function(b,k,m,l,t,q){f.dispose();var h=!0;c&&(h=c(q));if(!h)return g.resultCode=a.ERROR.Code=998,g.resultMessage=a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_NOALLOW_REVOCATION,g.certAttrs=q,e(g),!0;var p=a.loadUI("confirm")({type:null,args:{msg:b},onConfirm:function(){p.dispose();d(k,m,l,t)},onCancel:function(){ca();p.dispose();a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}});p.show()},onCancel:function(){f.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}});f.show();return!0}},SOECert:function(b,c){function d(b,c,d,f){4<=a.ESVS.Mode&&(a.nimservice()?(RevokingDialog=a.loadUI("certprocessing")({type:"CERT_SOE",args:null,onConfirm:null,onCancel:null}),RevokingDialog.show(),a.nimservice().RevokeCertificate(a.ESVS.CMPIP,a.ESVS.CMPPort,b,c,6,0,function(a,b){0===a?RevokingDialog.dispose(0,null,null,!0,function(){e(n(0))}):RevokingDialog.dispose(a,a,b,!1,function(){e(n(a,b))})})):(ca(),e(n(-1))))}if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||document.getElementById("us-div-cert-select"))return!1;var e=b,g={};a.reInitialize();var f=a.loadUI("certselect")({type:"CERT_SOE",args:{dn:null,possibleWhale:!1},onConfirm:function(b,k,m,l,t,q){f.dispose();var h=!0;c&&(h=c(q));if(!h)return g.resultCode=a.ERROR.Code=998,g.resultMessage=a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_NOALLOW_SOE,g.certAttrs=q,e(g),!0;var p=a.loadUI("confirm")({type:null,args:{msg:b},onConfirm:function(){p.dispose();d(k,m,l,t)},onCancel:function(){ca();p.dispose();a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}});p.show()},onCancel:function(){f.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}});f.show();return!0}},VerifyVID:function(b,c){function d(b,d,f,l,t,q,r){if("PFS"==r)try{var h=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[f].signcert),k=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[f].signpri),w=a.usWebToolkit.pkcs8.verifyVID(k,l,d,h);l=d="";w?g(n(0)):g(n(14208,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID))}catch(z){l=d="",a.ERROR.Code=z.code,a.ERROR.Message=z.message,g(n(z.code,z.message))}else"NIM"==r&&(a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_VID_VERIFY_MESSAGE),a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.SELECTINFO.curdevice==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP?(b=a.usWebToolkit.md.algorithms.sha256.create(),b.start(),b.update(a.usWebToolkit.util.encodeUtf8("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00")),b=b.digest().toHex(),b=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+b),f={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(b){b=JSON.parse(b);if(0!=b.returnObj.returnCode&&"E1000"!=b.returnObj.returnCode)e.resultMessage=a.ERROR.Message=b.returnObj.returnMsg,e.resultCode=a.ERROR.Code=b.returnObj.returnCode,g(e);else if("E1000"==b.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(e),g(e);else{var f=b.signResult.b64Signer;b=a.usWebToolkit.util.decode64(b.signResult.R[0]);f=a.usWebToolkit.pki.certificateFromBase64(f);a.usWebToolkit.pkcs8.verifyVIDForHSM(b,d,f)?g(n(0)):(a.ERROR.Code=14208,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID,c(n(14208,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)))}},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]},f.msg[0]=b,jSmartCertNP.SignByJSON(f).Open()):a.nimservice().VerifyVID(f,l,b,d,function(b,c){4305E4==b&&(b=14208);a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?g(n(0)):(a.ERROR.Code=b,a.ERROR.Message=c,g(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)));l=d=""}):a.Whale().verifyVID(f,l,d,function(b,d){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?g(n(0)):(3061==b&&(b=14208),a.ERROR.Code=b,a.ERROR.Message=d,c(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)))}))}if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!c||document.getElementById("us-div-cert-select"))return!1;var e=n(),g=function(a){1==c.length?c(a):(null==a&&(a=n(-1)),c(a.resultCode,a.resultMessage))};a.reInitialize();var f=a.loadUI("certselect")({type:"VID_VERIFICATION",args:{dn:null,possibleWhale:!0},onConfirm:function(c,k,m,l,t){Q(c,a.SELECTINFO.curdevice,function(h){setTimeout(function(){f.dispose()},10);if(0!=h.rv&&"NIM"==t)a.ERROR.Code=e.resultCode=h.rv,a.ERROR.Message=e.resultMessage=h.rvMsg,g(e);else if(b)d(0,b,c,k,m,l,t);else{var r=a.loadUI("ssn")({type:null,onConfirm:function(a){d(1,a,c,k,m,l,t);r.dispose()},onCancel:function(){ca();r.dispose();a.uiUtil().getUserCancelErrCodeNMsg();g(n(a.ERROR.Code,a.ERROR.Message))}});r.show()}})},onCancel:function(){f.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();g(n(a.ERROR.Code,a.ERROR.Message))}});f.show();return!0}},ManageCert:function(){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{a.reInitialize();var b=a.loadUI("certmanage")({type:"CERT_MANAGEMENT",onConfirm:null,onCancel:function(){b.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg()}});b.show();return!0}},ManageCertByType:function(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(4&a.ESVS.Mode||1!=b&&6!=b&&7!=b){a.reInitialize();var d=null,e=n();c&&(d=c);var g=a.loadUI("certmanage")({type:"CERT_MANAGEMENT",args:{type:b},onConfirm:function(a,b){g.dispose(!0);d&&(e.certAttrs=b,e.driveName=a,d(e))},onCancel:function(){g.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg()}});g.show();return!0}a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_FUC_NOT_SUPPORT)}},ImportCertFromMobileApp:function(b,c,d){function e(){try{try{a.PFSH.SelectStorage(1)}catch(q){alert("error : "+q.detail),h(n(q.code,q.message))}try{a.PFSH.LoadAllCerts(document.domain)}catch(q){301E5===q.code?(a.PFSH.InstallCACerts(document.domain),a.PFSH.LoadAllCerts(document.domain)):(alert("error : "+q.detail),h(n(q.code,q.message)))}var d=a.PFSH.SetP12HexOnMemory(b,c),e=d.aluc[d.index];a.usWebToolkit.x509Certificate.parser(e.signcert,"Base64");var g=a.usWebToolkit.x509Certificate.getCertificatePoliciesOid(),t=a.certUtil().getIssuerEnName(g);a.PFSH.SaveUserCert(t,e,document.domain,!0);h(f)}catch(q){alert("error : "+q.detail),h(null)}}function g(){a.CCPFSH().SetP12HexOnMemory(b,c,function(b,c,e){0==b?(b=e.aluc[e.index],a.usWebToolkit.x509Certificate.parser(b.signcert,"Base64"),c=a.usWebToolkit.x509Certificate.getCertificatePoliciesOid(),c=a.certUtil().getIssuerEnName(c),a.CCPFSH().SaveUserCert(c,b,!0,function(a){h(n(a))})):d(n(b,c))})}if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{c&&b||h(null);var f=n();a.PFSH||h(null);f=n();var h=function(a){1==d.length?d(a):(null==a&&(a=n(-1)),d(a.resultCode,a.resultMessage))};if(0==b.indexOf("MI")){for(b=b.replace(/_/g,"/").replace(/-/g,"+");0!=b.length%4;)b+="=";b=a.usWebToolkit.util.bytesToHex(a.usWebToolkit.util.decode64(b))}a.reInitialize();SSDialog=a.loadUI("storageselect")({type:"CERT_STORAGE",args:{possibleWhale:!1},onConfirm:function(b,c){SSDialog.dispose();b==a.CONST.__PF_M_LS.device?e():b==a.CONST.__PF_M_SS.device&&a.CCPFSH().IsCCPFSHAvailable(function(b){0==b?g():a.CCPFSH().GetCCStorageHandler(a.ESVS.EncAlgo,a.ESVS.HashAlgo,a.ESVS.BSPKI,function(a,b){0==a?g():SSDialog.dispose()})})},onCancel:function(){SSDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();h(n(a.ERROR.Code,a.ERROR.Message))}});SSDialog.show()}},SetSelectedDevice:function(b){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{var c="",d;for(d in a.CONST.medias)if(a.CONST.medias[d].device===b){c=a.CONST.medias[d].name;break}a.ESVS.Media.defaultdevice=c}},NimServiceLoaded:function(){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else return a.nimservice()?a.nimservice().GetIframeLoaded():null},SecureMail:function(b,c,d,e,g){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else if("seed"!=c&&(a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_ALGORITHM,g(n(a.ERROR.Code,a.ERROR.Message))),null==d||""==d||1>d.length)alert(a.uiUtil().getErrorMessageLang().IDS_NOT_ENCRYPTED_DATA);else{a.reInitialize();var f=0,h=a.loadUI("securemail")({type:"SECURE_MAIL",args:{algorithm:c,data:d,decryptData:this.DecryptFileData,mode:b},onConfirm:function(c,d,l,t){if(3<f)null!=document.getElementById("html_encripted")&&(document.getElementById("html_encripted").innerHTML=""),alert(l.IDS_KEY_TYPE[b]+l.IDS_PASSWORD_WRONG),h.dispose();else{var k=document.getElementById("us-input-secure-mail-password");c=t(c,k.value,d,e);if(-10===c)return a.ERROR.Code=-10,a.ERROR.Message=l.IDS_ALGORITHM_ALERT,h.dispose(),g(n(a.ERROR.Code,a.ERROR.Message));if(-11===c){a.ERROR.Code=-11;a.ERROR.Message=l.IDS_KEY_TYPE[b]+l.IDS_PASSWORD_WRONG;if(4<f)return h.dispose(),g(n(a.ERROR.Code,a.ERROR.Message));f+=1;alert(l.IDS_KEY_TYPE[b]+l.IDS_DISCORDANCE_PASSWORD.replace("@",f));k.value=""}else{if(-12===c)return h.dispose(),g(n(-12));if(-13===c){a.ERROR.Code=-13;a.ERROR.Message=l.IDS_KEY_TYPE[b]+l.IDS_PASSWORD_WRONG;if(4<f)return h.dispose(),g(n(-13));f+=1;alert(l.IDS_KEY_TYPE[b]+l.IDS_DISCORDANCE_PASSWORD.replace("@",f));k.value=""}else h.dispose(),l=n(),l.decryptedData=c,g(l)}}},onCancel:function(){h.dispose();a.uiUtil().getUserCancelErrCodeNMsg();g(n(a.ERROR.Code,a.ERROR.Message))}});h.show()}},DecryptFileData:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{var g=c;var f=0;for(c=c.length;16>c;c++)g+="abcdefghijklmnopqrstuvwxyz".substr(f++,1);f=g+"0123450123456789";c=b.toLowerCase();if("seed"==c)g=f.substring(0,16),f=f.substring(16,32);else if("3des"==c)g=f.substring(0,24),f=f.substring(24,32);else if("rc2"==c)g=f.substring(0,5),f=f.substring(5,13);else if("des"==c)g=f.substring(0,8),f=f.substring(8,16);else return-10;d=a.usWebToolkit.util.decode64(d);"3des"==c&&(b="des");c=null;try{var h=a.usWebToolkit.cipher.algorithms[b].startDecrypting(g,f);h.update(a.usWebToolkit.util.createBuffer(d));if(0==h.finish())return-11;0==e||null==e?c=h.output.toHex():1==e&&(c=h.output.getBytes())}catch(k){return a.ERROR.Code=k.code,a.ERROR.Message=k.message,-12}if(0==e||null==e)try{c=a.usWebToolkit.unicode.hex2UTF8(c)}catch(k){return-13}return c}},getFileDownload:function(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else if("function"==typeof Ea){if(null==c||""==c||1>c.length)c=document.location.href.split("/"),c=c[c.length-1];b=new Blob([b],{type:"application/otect-stream"});try{Ea(b,c)}catch(d){alert(a.uiUtil().getErrorMessageLang().IDS_ERROR_BROWSER_NOT_SUPPORT)}}else alert(a.uiUtil().getErrorMessageLang().IDS_ERROR_BROWSER_NOT_SUPPORT)},SignData_noConWithHash:function(b,c,d,e,g,f){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||document.getElementById("us-div-cert-select")||!f)return!1;var h=n(),k=function(a){1==f.length?f(a):(null==a&&(a=n(-1)),f(a.jsonSignedData,a.b64RValue,a.certAttrs))};a.reInitialize();var m=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P1",args:{dn:c,possibleWhale:!0},onConfirm:function(a,c,f,h,p,v,w){sa(b,d,a,h,p,v,e,m,g,w,k)},onCancel:function(){m.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg(h);k(h)}});m.show();return!0}},SignData_noConWithHashEx:function(b,c,d,e,g,f){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!c||!f)return!1;a.reInitialize();if(0==b){var h=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P1",args:{dn:d,possibleWhale:!0},onConfirm:function(a,b,d,n,q,r,p){sa(c,e,a,n,q,r,null,h,g,p,f)},onCancel:function(){h.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}});h.show()}else sa(c,e,a.SELECTINFO.cert,a.SELECTINFO.index,a.SELECTINFO.pw,a.SELECTINFO.curdevice,null,null,g,null,f)}},SignDataP7NVID_noConWithHash:function(b,c,d,e,g,f,h){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||document.getElementById("us-div-cert-select")||!h)return!1;a.reInitialize();var k=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P1_AND_VID_VERIFICATION",args:{dn:c,possibleWhale:!0},onConfirm:function(c,l,t,q,r,p,v){var w={};if("undefined"!==typeof c&&"undefined"!==typeof l)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(p))if(p!=a.CONST.__USFB_M_DISK.device&&p!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(p==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){t={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(e){e=JSON.parse(e);var f=n();if(0!=e.returnObj.returnCode&&"E1000"!=e.returnObj.returnCode)f.resultMessage=a.ERROR.Message=e.returnObj.returnMsg,f.resultCode=a.ERROR.Code=e.returnObj.returnCode,a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){k.dispose(!0)},10),h(f);else if("E1000"==e.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(f),a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){k.dispose(!0)},10),h(f);else{f=e.signResult.b64Signer;var r=null;_certAttrs=a.certUtil().getTheCertAttributes(f,"Base64");D(c,l,p,f,_certAttrs);if(1==e.signResult.b64SignedData.length){var v=e.signResult.b64SignedData[0];v=a.usWebToolkit.util.decode64(v);var q=a.usWebToolkit.pki.certificateFromBase64(f),w=a.usWebToolkit.pkcs7.createSignedData();w.signWithHashDataNP1(v,a.usWebToolkit.util.decode64(b),d.toLowerCase(),q);r=a.usWebToolkit.pkcs7.messageToBase64(w)}else{var m=0;r={};for(var t in b)""==b[t]?r[t]="":(v=e.signResult.b64SignedData[m++],v=a.usWebToolkit.util.decode64(v),q=a.usWebToolkit.pki.certificateFromBase64(f),w=a.usWebToolkit.pkcs7.createSignedData(),w.signWithHashDataNP1(v,a.usWebToolkit.util.decode64(b[t]),d.toLowerCase(),q),r[t]=a.usWebToolkit.pkcs7.messageToBase64(w))}O(g,c,l,r,_certAttrs,p,"",null,h,e.signResult.R[0],f);a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k.dispose()},10)}},multisignYn:"Y",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]};if("object"==typeof b){t.multisignYn="Y";for(var m in b)""!=b[m]&&(q=a.usWebToolkit.util.bytesToHex(a.usWebToolkit.util.decode64(b[m])),t.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+q)))}else t.multisignYn="N",q=a.usWebToolkit.util.bytesToHex(a.usWebToolkit.util.decode64(b[m])),t.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+q));jSmartCertNP.SignByJSON(t).Open()}else a.nimservice()?Q(c,p,function(e){if(0!=e.rv)a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=e.rv,a.ERROR.Message=e.rvMsg,setTimeout(function(){k.dispose()},10),h(n(a.ERROR.Code,a.ERROR.Message));else{e=0;var q=[];if(b)for(var m in b)q[e]=b[m],e++;a.nimservice().GetSignDataP7WithHash(c,l,d,q,T,!1,null,!0,f,function(d,e,f,q,m,t){if(0!=d)a.ERROR.Code=d,a.ERROR.Message=e,a.uiUtil().errMsgBox(e,a.ERROR.Code),h(n(d,e));else{d=0;if("object"==typeof f)for(var z in b)w[z]=f[d++];else w=f;null==r&&a.CONST.__USFB_M_MOBILETOKEN.device==p&&(r=a.certUtil().getTheCertAttributes(m,"Base64"));O(g,c,l,w,r,p,t,v,h)}l=g="";a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k.dispose()},10)})}}):(h(null),setTimeout(function(){k.dispose(!0)},10));else-1==c||""==l?(resultObject.resultMessage=a.ERROR.Message=t,resultObject.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){k.dispose(!0)},10),h(resultObject)):a.Whale().getSignDataP7_noConWithHash(b,c,l,d,f,function(b,d,e){0!=b?(a.ERROR.Code=b,a.ERROR.Message=d,a.uiUtil().errMsgBox(d,a.ERROR.Code),h(n(b,d))):O(g,c,l,e,r,p,"",null,h);l=g="";a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){k.dispose()},10)});else{try{sa(b,d,a.PFUC[c].signcert,c,l,p,e,k,f,null,function(b){O(g,c,l,b.jsonSignedData,a.certUtil().getTheCertAttributes(a.PFUC[c].signcert,"Base64"),p,"",null,h)})}catch(B){a.ERROR.Code=B.code,a.ERROR.Message=B.message,a.uiUtil().errMsgBox(B.message,a.ERROR.Code),h(n(B.code,B.message))}c=l=pri=null;setTimeout(function(){k.dispose(!0)},10)}else h(null),setTimeout(function(){k.dispose(!0)},10)},onCancel:function(){k.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();h(n(a.ERROR.Code,a.ERROR.Message))}});k.show();return!0}},VerifySignData_noConWithHash:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||!c)return!1;a.reInitialize();d=null;try{var g=a.usWebToolkit.util.decode64(b);d=a.usWebToolkit.pkcs7.messageFromBase64(c);d.verifyWithHash(g);1==d.verifyResult?e(0):e(-1)}catch(f){a.ERROR.Code=f.code,a.ERROR.Message=f.message,e(f.code)}}},SignMultiDataP7:function(b,c,d,e,g,f){if(!b&&!c||!f||document.getElementById("us-div-cert-select"))return!1;var h=n(),k=function(a){1==f.length?f(a):(null==a&&(a=n(-1)),f(a.jsonSignedData,a.b64RValue,a.certAttrs,a.curDevice))};a.reInitialize();var m=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:d,possibleWhale:!0},onConfirm:function(d,f,q,r,p,v,w){var l=1,t={},A=q;if("undefined"!==typeof r&&"undefined"!==typeof p)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(v))if(v!=a.CONST.__USFB_M_DISK.device&&v!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(v==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){d={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(c){c=JSON.parse(c);if(0!=c.returnObj.returnCode&&"E1000"!=c.returnObj.returnCode)h.resultMessage=a.ERROR.Message=c.returnObj.returnMsg,h.resultCode=a.ERROR.Code=c.returnObj.returnCode,setTimeout(function(){m.dispose(!0)},10),k(h);else if("E1000"==c.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(h),setTimeout(function(){m.dispose(!0)},10),k(h);else{var d=c.signResult.b64Signer;A=a.certUtil().getTheCertAttributes(d,"Base64");D(r,p,v,d,A);h.certAttrs=A;if(1==c.signResult.b64SignedData.length){var e=c.signResult.b64SignedData[0];e=a.usWebToolkit.util.decode64(e);var f=a.usWebToolkit.pki.certificateFromBase64(d),l=a.usWebToolkit.pkcs7.createSignedData();l.signWithP1(e,b,f,null,null);h.jsonSignedData=a.usWebToolkit.pkcs7.messageToBase64(l)}else{var q=0;h.jsonSignedData={};for(var w in b)""==b[w]?h.jsonSignedData[w]="":(e=c.signResult.b64SignedData[q++],e=a.usWebToolkit.util.decode64(e),f=a.usWebToolkit.pki.certificateFromBase64(d),l=a.usWebToolkit.pkcs7.createSignedData(),l.signWithP1(e,b[w],f,null,null),h.jsonSignedData[w]=a.usWebToolkit.pkcs7.messageToBase64(l))}if(g)try{var n=a.usWebToolkit.util.decode64(c.signResult.R[0]),t=a.usWebToolkit.pki.certificateFromBase64(g);l=a.usWebToolkit.pkcs7.createEnvelopedData();l.addRecipient(t);l.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];l.content=n;l.encrypt();h.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(l)}catch(Rb){}h.curDevice=v;h.tokenLabel="";k(h);setTimeout(function(){m.dispose()},10)}},multisignYn:"Y",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[],plainText:[]};if(b)if("object"==typeof b)for(y in b){if(""!=b[y]){var E=a.usWebToolkit.util.encodeUtf8(b[y]),F=a.usWebToolkit.md.algorithms.sha256.create();F.start();F.update(E);F=F.digest().toHex();d.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+F));e&&d.plainText.push(E)}}else E=a.usWebToolkit.util.encodeUtf8(b),F=a.usWebToolkit.md.algorithms.sha256.create(),F.start(),F.update(E),F=F.digest().toHex(),d.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+F)),e&&d.plainText.push(E);else if("object"==typeof b)for(y in jsonPlainData)E[y]=c[y];else E=c;jSmartCertNP.SignByJSON(d).Open()}else a.nimservice()?Q(r,v,function(d){if(0!=d.rv)a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=h.resultCode=d.rv,a.ERROR.Message=h.resultMessage=d.rvMsg,setTimeout(function(){m.dispose()},10),k(h);else{d=0;var l=[];if(b)if("object"==typeof b)for(var q in b)l[d++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b[q]));else l=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));else if("object"==typeof jsonPlainData)for(q in jsonPlainData)l[d++]=c[q];else l=c;a.nimservice().GetSignDataP7(r,p,l,T,e,g,a.ESVS.multiuse,!1,function(d,e,g,l,q,z){if(0!=d)a.ERROR.Code=d,a.ERROR.Message=e,k(n(a.ERROR.Code,a.ERROR.Message));else{d=0;e=b;c&&(e=c);if("object"==typeof g)for(var B in e)t[B]=g[d++];else t=g;null==A&&a.CONST.__USFB_M_MOBILETOKEN.device==v?(A=a.certUtil().getTheCertAttributes(q,"Base64"),D(r,p,v,q,A)):D(r,p,v,f,A);h.jsonSignedData=t;h.b64RValue=l;h.certAttrs=A;h.curDevice=v;h.tokenLabel=z;null!=w&&v==a.CONST.__USFB_M_HSMKEY.device&&(h.tokenName=w.name,h.tokenDriver=w.driver);k(h)}r=p=f=G=null;a.uiUtil().loadingBox(!1,"us-div-list-load");m.dispose()})}}):(k(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),m.dispose(!0));else if(-1==r||""==p)h.resultMessage=a.ERROR.Message=d,h.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){m.dispose(!0)},10),k(h);else{a.uiUtil().loadingBox(!0,"us-div-list-load",1);E={};if(b)if("object"==typeof b)for(var y in b)E[y]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b[y]));else E=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));else if("object"==typeof b)for(y in jsonPlainData)E[y]=c[y];else E=c;a.Whale().getSignDataP7(E,r,p,e,function(b,c,d){0!=b?(h.resultCode=b,h.resultMessage=c,k(h)):(D(r,p,v,f,A),h.jsonSignedData=d,h.certAttrs=A,h.curDevice=v,h.tokenLabel="",g?a.Whale().getCertR(r,p,function(b,c,d){a.uiUtil().loadingBox(!1,"us-div-list-load",1);if(0==b)try{var e=a.usWebToolkit.util.hexToBytes(d),f=a.usWebToolkit.pki.certificateFromBase64(g),p=a.usWebToolkit.pkcs7.createEnvelopedData();p.addRecipient(f);p.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];p.content=e;p.encrypt();h.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(p)}catch(Rb){}k(h);setTimeout(function(){m.dispose()},10)}):(k(h),setTimeout(function(){m.dispose()},10)))})}else{a.uiUtil().loadingBox(!0,"us-div-list-load");if(e)try{f=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[r].signcert);var G=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[r].signpri),Z=a.usWebToolkit.pkcs8.decryptPrivateKeyInfo(G,p),S=a.usWebToolkit.pkcs8.getPrivateKeyAttributesRandom(Z);if("object"==typeof b)for(l in b){var x=a.usWebToolkit.pkcs7.createSignedData();x.sign(b[l],f,G,p,null,null);t[l]=a.usWebToolkit.pkcs7.messageToBase64(x)}else x=a.usWebToolkit.pkcs7.createSignedData(),x.sign(b,f,G,p,null,null),t=a.usWebToolkit.pkcs7.messageToBase64(x);h.jsonSignedData=t;if(g)try{var Ha=a.usWebToolkit.pki.certificateFromBase64(g),ba=a.usWebToolkit.pkcs7.createEnvelopedData();ba.addRecipient(Ha);ba.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];ba.content=S;ba.encrypt();h.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(ba)}catch(U){}h.curDevice=v;h.certAttrs=a.certUtil().getTheCertAttributes(a.PFUC[r].signcert,"Base64");k(h)}catch(U){a.ERROR.Code=U.code,a.ERROR.Message=U.message,a.uiUtil().errMsgBox(U.message,a.ERROR.Code),k(n(U.code,U.message))}else try{f=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[r].signcert);G=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[r].signpri);Z=a.usWebToolkit.pkcs8.decryptPrivateKeyInfo(G,p);S=a.usWebToolkit.pkcs8.getPrivateKeyAttributesRandom(Z);for(l in b){F=a.usWebToolkit.md.algorithms.sha256.create();F.start();var C=a.usWebToolkit.util.encodeUtf8(b[l]);F.update(C);x=a.usWebToolkit.pkcs7.createSignedData();x.signWithHashData(F.digest().getBytes(),"sha256",f,G,p,null,null,!1);t[l]=a.usWebToolkit.pkcs7.messageToBase64(x)}h.jsonSignedData=t;if(g)try{Ha=a.usWebToolkit.pki.certificateFromBase64(g),ba=a.usWebToolkit.pkcs7.createEnvelopedData(),ba.addRecipient(Ha),ba.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"],ba.content=S,ba.encrypt(),h.b64RValue=a.usWebToolkit.pkcs7.messageToBase64(ba)}catch(U){}h.curDevice=v;h.certAttrs=a.certUtil().getTheCertAttributes(a.PFUC[r].signcert,"Base64");k(h)}catch(U){a.ERROR.Code=U.code,a.ERROR.Message=U.message,a.uiUtil().errMsgBox(U.message,a.ERROR.Code),k(n(U.code,U.message))}a.uiUtil().loadingBox(!1,"us-div-list-load");m.dispose();r=p=f=G=null}},onCancel:function(){m.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();k(n(a.ERROR.Code,a.ERROR.Message))}});m.show();return!0},SignMultiDataP7NVerifyVID:function(b,c,d,e,g,f){if(!b&&!c||!f||document.getElementById("us-div-cert-select"))return!1;var h=n(),k=function(a){1==f.length?f(a):(null==a&&(a=n(-1)),f(a.resultCode,a.signedData,a.certAttrs,a.curDevice))};a.reInitialize();var m=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:d,possibleWhale:!0},onConfirm:function(d,f,q,r,p,v,w){var l=1,t={},A=q;if("undefined"!==typeof r&&"undefined"!==typeof p)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(v))if(v!=a.CONST.__USFB_M_DISK.device&&v!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(v==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){d={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(c){c=JSON.parse(c);if(0!=c.returnObj.returnCode&&"E1000"!=c.returnObj.returnCode)h.resultMessage=a.ERROR.Message=c.returnObj.returnMsg,h.resultCode=a.ERROR.Code=c.returnObj.returnCode,setTimeout(function(){m.dispose(!0)},10),k(h);else if("E1000"==c.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(h),setTimeout(function(){m.dispose(!0)},10),k(h);else{var d=c.signResult.b64Signer;A=a.certUtil().getTheCertAttributes(d,"Base64");D(r,p,v,d,A);h.certAttrs=A;var e="";if(1==c.signResult.b64SignedData.length){var f=c.signResult.b64SignedData[0];f=a.usWebToolkit.util.decode64(f);var l=a.usWebToolkit.pki.certificateFromBase64(d),q=a.usWebToolkit.pkcs7.createSignedData();q.signWithP1(f,b,l,null,null);e=a.usWebToolkit.pkcs7.messageToBase64(q)}else{var w=0;e={};for(var n in b)""==b[n]?e[n]="":(f=c.signResult.b64SignedData[w++],f=a.usWebToolkit.util.decode64(f),l=a.usWebToolkit.pki.certificateFromBase64(d),q=a.usWebToolkit.pkcs7.createSignedData(),q.signWithP1(f,b[n],l,null,null),e[n]=a.usWebToolkit.pkcs7.messageToBase64(q))}O(g,r,p,e,A,v,"",null,k,c.signResult.R[0],d);a.uiUtil().loadingBox(!1,"us-div-list-load",1);setTimeout(function(){m.dispose()},10)}},multisignYn:"Y",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[],plainText:[]};if(b)if("object"==typeof b)for(F in b){if(""!=b[F]){var E=a.usWebToolkit.util.encodeUtf8(b[F]);q=a.usWebToolkit.md.algorithms.sha256.create();q.start();q.update(E);q=q.digest().toHex();d.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+q));e&&d.plainText.push(E)}}else E=a.usWebToolkit.util.encodeUtf8(b),q=a.usWebToolkit.md.algorithms.sha256.create(),q.start(),q.update(E),q=q.digest().toHex(),d.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+q)),e&&d.plainText.push(E);else if("object"==typeof b)for(F in jsonPlainData)E[F]=c[F];else E=c;jSmartCertNP.SignByJSON(d).Open()}else a.nimservice()?Q(r,v,function(d){if(0!=d.rv)a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=h.resultCode=d.rv,a.ERROR.Message=h.resultMessage=d.rvMsg,setTimeout(function(){m.dispose()},10),k(h);else{d=0;var l=[];if(b)if("object"==typeof b)for(var q in b)l[d++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b[q]));else l=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));else if("object"==typeof b)for(q in jsonPlainData)l[d++]=c[q];else l=c;a.nimservice().GetSignDataP7(r,p,l,T,e,null,!0,!1,function(d,e,h,l,q,z){if(0!=d)a.ERROR.Code=d,a.ERROR.Message=e,k(n(a.ERROR.Code,a.ERROR.Message));else{d=0;e=b;c&&(e=c);if("object"==typeof h)for(var B in e)t[B]=h[d++];else t=h;null==A&&a.CONST.__USFB_M_MOBILETOKEN.device==v&&(A=a.certUtil().getTheCertAttributes(q,"Base64"));O(g,r,p,t,A,v,z,w,k)}r=p=f=y=null;a.uiUtil().loadingBox(!1,"us-div-list-load");m.dispose()})}}):(k(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),m.dispose(!0));else if(-1==r||""==p)h.resultMessage=a.ERROR.Message=d,h.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){m.dispose(!0)},10),k(h);else{a.uiUtil().loadingBox(!0,"us-div-list-load",1);E={};if(b)if("object"==typeof b)for(var F in b)E[F]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b[F]));else E=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));else if("object"==typeof b)for(F in jsonPlainData)E[F]=c[F];else E=c;a.Whale().getSignDataP7(E,r,p,e,function(b,c,d){0!=b?(h.resultCode=b,h.resultMessage=c,k(h)):(O(g,r,p,d,A,v,"",null,k),r=p=f=y=null);a.uiUtil().loadingBox(!1,"us-div-list-load",1);setTimeout(function(){m.dispose()},10)})}else{if(e)try{f=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[r].signcert);var y=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[r].signpri);if("object"==typeof b)for(l in b){var G=a.usWebToolkit.pkcs7.createSignedData();G.sign(b[l],f,y,p,null,null);t[l]=a.usWebToolkit.pkcs7.messageToBase64(G)}else G=a.usWebToolkit.pkcs7.createSignedData(),G.sign(b,f,y,p,null,null),t=a.usWebToolkit.pkcs7.messageToBase64(G);O(g,r,p,t,q,v,"",null,k)}catch(Z){a.ERROR.Code=Z.code,a.ERROR.Message=Z.message,a.uiUtil().errMsgBox(Z.message,a.ERROR.Code),k(n(Z.code,Z.message))}else a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_BROWSER_NOT_SUPPORT,k(n(a.ERROR.Code,a.ERROR.Message));r=p=f=y=null;m.dispose(!0)}else k(null),m.dispose(!0)},onCancel:function(){m.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();k(n(a.ERROR.Code,a.ERROR.Message))}});m.show();return!0},Base64Encoding:function(b,c){b=c&&"binary"==c?b:a.usWebToolkit.util.encodeUtf8(b);return(b=a.usWebToolkit.util.encode64(b))?b:""},Base64Decoding:function(b,c){b=a.usWebToolkit.util.decode64(b);return(c=c&&"binary"==c?b:a.usWebToolkit.util.decodeUtf8(b))?c:""},SignUCPIDReqInfo:function(b,c,d,e,g,f){if(!b||!c||5>c.length||!f||document.getElementById("us-div-cert-select"))return!1;g=a.usWebToolkit.util.decode64(d);var h=n();a.reInitialize();d=function(b,c,d){var e=null,g=b,h=!1,p=a.usWebToolkit.asn1.Class.UNIVERSAL;switch(c){case "UTF8":try{g=a.usWebToolkit.util.encodeUtf8(b)}catch(G){a.ERROR.Code=1E7;a.ERROR.Message="[TOOLKIT UTIL ERROR] during encoding utf8 character set.\ndetail : "+G;f(n(a.ERROR.Code,a.ERROR.Message));return}break;case "INTEGER":g=String.fromCharCode(b);break;case "SEQUENCE":g=[];h=!0;for(var k in b)g.push(b[k]);break;case "EXPLICIT":h=!0,p=a.usWebToolkit.asn1.Class.CONTEXT_SPECIFIC+d,c="NONE",g=[],g.push(b)}try{e=a.usWebToolkit.asn1.create(p,a.usWebToolkit.asn1.Type[c],h,g)}catch(G){a.ERROR.Code=1E7;a.ERROR.Message="[TOOLKIT ASN.1 ERROR] during creating useragreement asn.1 struct.\ndetail : "+G;return}return e};var k=a.nimVersion.split(".");c={version:2,ucpidNonce:g,personIfo:{userAgreement:b,userAgree:c},moduleInfo:{moduleName:"UniSign",moduleVenderName:"CrossCert",moduleVersion:{major:k[0],minor:k[1],build:k[2],revision:k[3]}},ispUrlInfo:document.domain};b={};for(var m in c)if("object"==typeof c[m]){g={};for(var l in c[m])if("object"==typeof c[m][l]){k={};var t={},q;for(q in c[m][l])"major"==q||"minor"==q?k[q]=d(c[m][l][q],"INTEGER"):(t=d(c[m][l][q],"INTEGER"),k[q]="build"==q?d(t,"EXPLICIT",0):d(t,"EXPLICIT",1));g[l]=d(k,"SEQUENCE")}else isNaN(c[m][l])?g[l]=d(c[m][l],"UTF8"):(t=c[m][l],k=0,"1"===t.charAt(0)&&(k|=128),"1"===t.charAt(1)&&(k|=64),"1"===t.charAt(2)&&(k|=32),"1"===t.charAt(3)&&(k|=16),"1"===t.charAt(4)&&(k|=8),t=String.fromCharCode(3),k=String.fromCharCode(k),g[l]=d(t+k,"BITSTRING"));b[m]=d(g,"SEQUENCE")}else"string"==typeof c[m]?b[m]="ucpidNonce"==m?d(c[m],"OCTETSTRING"):d(c[m],"UTF8"):"number"==typeof c[m]&&(b[m]=d(c[m],"INTEGER"));b=d(b,"SEQUENCE");m=null;try{m=a.usWebToolkit.asn1.toDer(b)}catch(v){a.ERROR.Code=1E7;a.ERROR.Message="[TOOLKIT ASN.1 ERROR] during converting object to der format.\ndetail : "+v;f(n(a.ERROR.Code,a.ERROR.Message));return}var r=null;try{r=a.usWebToolkit.util.encode64(m.getBytes())}catch(v){a.ERROR.Code=1E7;a.ERROR.Message="[TOOLKIT UTIL ERROR] during encoding base64 string.\ndetail : "+v;f(n(a.ERROR.Code,a.ERROR.Message));return}var p=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:e},onConfirm:function(b,c,d,e,g,k){"undefined"!==typeof e&&"undefined"!==typeof g&&4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(k)&&(a.nimservice()?a.nimservice().GetSignDataP7(e,g,r,"utf8",!0,null,!1,!1,function(b,c,e){0!=b?(a.ERROR.Code=b,a.ERROR.Message=c,f(n(a.ERROR.Code,a.ERROR.Message))):(h.signedData=e,h.certAttrs=d,f(h));a.uiUtil().loadingBox(!1,"us-div-list-load");p.dispose()}):(f(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),p.dispose(!0)))},onCancel:function(){p.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}});p.show();return!0},MultiSignUCPIDReqInfo:function(b,c,d,e){if("object"!=typeof b||!e||document.getElementById("us-div-cert-select"))return!1;var g=n(),f=function(a){return a.replaceAll("/","_").replaceAll("+","-").replaceAll("=","")};a.reInitialize();var h=["1","0","0","0"],k=function(b){var c;for(c=b.ucpidNonce.replaceAll("_","/").replaceAll("-","+");0!=c.length%4;)c+="=";c=a.usWebToolkit.util.decode64(c);var d=b.userAgreement,e=b.userAgreeInfo,f=0,g;for(g in e)switch(g){case "realName":e[g]?f+=1E4:f+0;break;case "gender":e[g]?f+=1E3:f+0;break;case "nationalInfo":e[g]?f+=100:f+0;break;case "birthDate":e[g]?f+=10:f+0;break;case "ci":e[g]?f+=1:f+0}for(g=f+"";0!=g.length%5;)g="0"+g;return{version:2,ucpidNonce:c,personIfo:{userAgreement:d,userAgree:g},moduleInfo:{moduleName:"UniSign",moduleVenderName:"CrossCert",moduleVersion:{major:h[0],minor:h[1],build:h[2],revision:h[3]}},ispUrlInfo:b.ispUrlInfo}},m=function(b,c,d){var f=null,g=b,h=!1,p=a.usWebToolkit.asn1.Class.UNIVERSAL;switch(c){case "UTF8":try{g=a.usWebToolkit.util.encodeUtf8(b)}catch(E){a.ERROR.Code=1E7;a.ERROR.Message="[TOOLKIT UTIL ERROR] during encoding utf8 character set.\ndetail : "+E;e(n(a.ERROR.Code,a.ERROR.Message));return}break;case "INTEGER":g=String.fromCharCode(b);break;case "SEQUENCE":g=[];h=!0;for(var k in b)g.push(b[k]);break;case "EXPLICIT":h=!0,p=a.usWebToolkit.asn1.Class.CONTEXT_SPECIFIC+d,c="NONE",g=[],g.push(b)}try{f=a.usWebToolkit.asn1.create(p,a.usWebToolkit.asn1.Type[c],h,g)}catch(E){a.ERROR.Code=1E7;a.ERROR.Message="[TOOLKIT ASN.1 ERROR] during creating useragreement asn.1 struct.\ndetail : "+E;return}return f},l=function(b){var c={},d;for(d in b)if("object"==typeof b[d]){var f={},g;for(g in b[d])if("object"==typeof b[d][g]){var h={},k;for(k in b[d][g])if("major"==k||"minor"==k)h[k]=m(b[d][g][k],"INTEGER");else{var l=m(b[d][g][k],"INTEGER");h[k]="build"==k?m(l,"EXPLICIT",0):m(l,"EXPLICIT",1)}f[g]=m(h,"SEQUENCE")}else isNaN(b[d][g])?f[g]=m(b[d][g],"UTF8"):(l=b[d][g],h=0,"1"===l.charAt(0)&&(h|=128),"1"===l.charAt(1)&&(h|=64),"1"===l.charAt(2)&&(h|=32),"1"===l.charAt(3)&&(h|=16),"1"===l.charAt(4)&&(h|=8),l=String.fromCharCode(3),h=String.fromCharCode(h),f[g]=m(l+h,"BITSTRING"));c[d]=m(f,"SEQUENCE")}else"string"==typeof b[d]?c[d]="ucpidNonce"==d?m(b[d],"OCTETSTRING"):m(b[d],"UTF8"):"number"==typeof b[d]&&(c[d]=m(b[d],"INTEGER"));c=m(c,"SEQUENCE");b=null;try{b=a.usWebToolkit.asn1.toDer(c)}catch(E){return a.ERROR.Code=1E7,a.ERROR.Message="[TOOLKIT ASN.1 ERROR] during converting object to der format.\ndetail : "+E,e(n(a.ERROR.Code,a.ERROR.Message)),""}c=null;try{c=a.usWebToolkit.util.encode64(b.getBytes())}catch(E){return a.ERROR.Code=1E7,a.ERROR.Message="[TOOLKIT UTIL ERROR] during encoding base64 string.\ndetail : "+E,e(n(a.ERROR.Code,a.ERROR.Message)),""}return c},t=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:c},onConfirm:function(c,d,h,v,m,z){if("undefined"!==typeof v&&"undefined"!==typeof m)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(z))if(a.nimservice()){for(var p=[],r=[],q=0;q<b.length;q++){r.push(b[q].orgCode);p.push(l(k(b[q].ucpidRequestInfo)));var w=a.usWebToolkit.util.encodeUtf8(JSON.stringify(b[q].consentInfo));p.push(a.usWebToolkit.util.encode64(w))}a.nimservice().GetSignDataP7(v,m,p,"utf8",!0,null,!0,!0,function(b,c,d){if(0!=b)a.ERROR.Code=b,a.ERROR.Message=c,e(n(a.ERROR.Code,a.ERROR.Message));else{g.signedData={};g.signedData.caOrg=a.certUtil().getO(h.subjectName);g.signedData.signedDataList=[];for(c=b=0;b<d.length;b++,c++){var k={};k.orgCode=r[c];k.signedPersonInfoReq=f(d[b++]);k.signedConsent=f(d[b]);g.signedData.signedDataList.push(k)}g.certAttrs=h;e(g)}a.uiUtil().loadingBox(!1,"us-div-list-load");t.dispose()})}else e(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),t.dispose(!0);else if(-1==v||""==m)g.resultMessage=a.ERROR.Message=c,g.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){t.dispose(!0)},10),e(g);else{try{p=[];r=[];for(q=0;q<b.length;q++)r.push(b[q].orgCode),p.push(l(k(b[q].ucpidRequestInfo))),w=JSON.stringify(b[q].consentInfo),p.push(w);d=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[v].signcert);var u=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[v].signpri);g.signedData={};g.signedData.caOrg=a.certUtil().getO(h.subjectName);g.signedData.signedDataList=[];for(c=q=0;q<p.length;q++,c++){v={};v.orgCode=r[c];var G=a.usWebToolkit.pkcs7.createSignedData();G.sign(a.usWebToolkit.util.decode64(p[q++]),d,u,m,null,null,!0,!0);v.signedPersonInfoReq=f(a.usWebToolkit.pkcs7.messageToBase64(G));var Z=a.usWebToolkit.pkcs7.createSignedData();Z.sign(p[q],d,u,m,null,null,!0,!1);v.signedConsent=f(a.usWebToolkit.pkcs7.messageToBase64(Z));g.signedData.signedDataList.push(v)}g.certAttrs=h;e(g)}catch(S){a.ERROR.Code=S.code,a.ERROR.Message=S.message,112047==S.code&&(a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD),a.uiUtil().errMsgBox(a.ERROR.Message,a.ERROR.Code),e(n(S.code,S.message))}setTimeout(function(){t.dispose()},10);v=m=d=u=null}},onCancel:function(){t.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}});t.show();return!0},SignMultiDataP1:function(b,c,d){if(!b||!d||document.getElementById("us-div-cert-select"))return!1;var e=n(),g=function(a){1==d.length?d(a):(null==a&&(a=n(-1)),d(a.jsonSignedData,a.theCert,a.theDN))};a.reInitialize();var f=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P1",args:{dn:c,possibleWhale:!0},onConfirm:function(c,d,m,l,t,q,r){var h={};if("undefined"!==typeof l&&"undefined"!==typeof t)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(q))if(q!=a.CONST.__USFB_M_DISK.device&&q!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(q==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){m={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(c){c=JSON.parse(c);if(0!=c.returnObj.returnCode&&"E1000"!=c.returnObj.returnCode)e.resultMessage=a.ERROR.Message=c.returnObj.returnMsg,e.resultCode=a.ERROR.Code=c.returnObj.returnCode,setTimeout(function(){f.dispose(!0)},10),g(e);else if("E1000"==c.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(e),setTimeout(function(){f.dispose(!0)},10),g(e);else{var d=c.signResult.b64Signer;_certAttrs=a.certUtil().getTheCertAttributes(d,"Base64");D(l,t,q,d,_certAttrs);e.certAttrs=_certAttrs;e.theCert=d;e.theDN=_certAttrs.subjectName;if(1==c.signResult.b64SignedData.length)e.jsonSignedData=c.signResult.b64SignedData[0];else{d=0;e.jsonSignedData={};for(var h in b)e.jsonSignedData[h]=""==b[h]?"":c.signResult.b64SignedData[d++]}e.curDevice=q;e.tokenLabel="";g(e);setTimeout(function(){f.dispose()},10)}},multisignYn:"Y",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[],plainText:[]};if(b)if("object"==typeof b)for(z in b){if(""!=b[z]){var k=a.usWebToolkit.util.encodeUtf8(b[z]),w=a.usWebToolkit.md.algorithms.sha256.create();w.start();w.update(k);w=w.digest().toHex();m.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+w));_inclCon&&m.plainText.push(k)}}else k=a.usWebToolkit.util.encodeUtf8(b),w=a.usWebToolkit.md.algorithms.sha256.create(),w.start(),w.update(k),w=w.digest().toHex(),m.msg.push(a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+w)),_inclCon&&m.plainText.push(k);else if("object"==typeof b)for(z in jsonPlainData)k[z]=_jsonPlainB64Text[z];else k=_jsonPlainB64Text;jSmartCertNP.SignByJSON(m).Open()}else a.nimservice()?Q(l,q,function(k){if(0!=k.rv)a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=e.resultCode=k.rv,a.ERROR.Message=e.resultMessage=k.rvMsg,setTimeout(function(){f.dispose()},10),g(e);else{k=0;var p=[];if(b)if("object"==typeof b)for(var v in b)p[k++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b[v]));else p=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));a.nimservice().GetSignDataP1(l,t,p,null,a.ESVS.multiuse,function(k,p,l,v,m,w){if(0!=k)a.ERROR.Code=k,a.ERROR.Message=p,a.uiUtil().errMsgBox(p,a.ERROR.Code),g(n(k,p));else{k=0;if("object"==typeof l)for(var t in b)h[t]=l[k++];else h=l;null==c&&a.CONST.__USFB_M_MOBILETOKEN.device==q&&(l=a.certUtil().getTheCertAttributes(m,"Base64"),c=m,d=l.subjectName);e.jsonSignedData=h;e.theCert=c;e.theDN=d;e.tokenLabel=w;null!=r&&q==a.CONST.__USFB_M_HSMKEY.device&&(e.tokenName=r.name,e.tokenDriver=r.driver);g(e)}a.uiUtil().loadingBox(!1,"us-div-list-load");f.dispose()})}}):(g(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),f.dispose(!0));else if(-1==l||""==t)e.resultMessage=a.ERROR.Message=m,e.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){f.dispose(!0)},10),g(e);else{a.uiUtil().loadingBox(!0,"us-div-list-load",1);k=[];if(b)if("object"==typeof b)for(var z in b)k[z]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b[z]));else k=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));a.Whale().getSignDataP1(k,l,t,function(b,h,k){0!=b?(e.resultCode=b,e.resultMessage=h,a.uiUtil().errMsgBox(h,b)):(e.jsonSignedData=k,e.theCert=c,e.theDN=d,e.tokenLabel="");setTimeout(function(){f.dispose()},10);a.uiUtil().loadingBox(!1,"us-div-list-load",1);g(e)})}else l=t=cert=pri=null,f.dispose()},onCancel:function(){f.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();g(n(a.ERROR.Code,a.ERROR.Message))}});f.show();return!0},VerifySignedDataP7ExcludedContent:function(b,c,d){if(!c)return null;a.reInitialize();if(4&a.ESVS.Mode)if(null!=a.Whale()){var e=null;try{e=a.usWebToolkit.pkcs7.messageFromBase64(c),e.verify(void 0,b)}catch(g){a.ERROR.Code=g.code;a.ERROR.Message=g.message;d(g.code);return}if(1==e.verifyResult)return d(0),0;d(-1)}else a.nimservice()&&(b=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().VerifySignedData(b,c,function(b,c,e){0!=b&&(a.ERROR.Code=a.nimservice().GetLastErrorCode(),a.ERROR.Message=a.nimservice().GetLastErrorMessage());d(b);a.uiUtil().loadingBox(!1,"us-div-list-load")}));else{e=null;try{e=a.usWebToolkit.pkcs7.messageFromBase64(c),e.verify(void 0,b)}catch(g){a.ERROR.Code=g.code;a.ERROR.Message=g.message;_rvCallback(g.code);return}if(1==e.verifyResult)return _rvCallback(0),0;_rvCallback(-1)}},SignDataP7AndVerifyVID:function(b,c,d,e){if(!b&&!plainB64Text||!e||document.getElementById("us-div-cert-select"))return!1;var g=n(),f=function(a){1==e.length?e(a):(null==a&&(a=n(-1)),e(a.resultCode,a.signedData,a.certAttrs,a.curDevice))};a.reInitialize();var h=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_AND_VID_VERIFICATION",args:{dn:c,possibleWhale:!0},onConfirm:function(c,e,l,t,q,r,p){var k=q;if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(r))if(r!=a.CONST.__USFB_M_DISK.device&&r!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(r==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){l=a.usWebToolkit.md.algorithms.sha256.create();l.start();l.update(a.usWebToolkit.util.encodeUtf8(b));l=l.digest().toHex();l=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+l);var w={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(p){p=JSON.parse(p);if(0!=p.returnObj.returnCode&&"E1000"!=p.returnObj.returnCode)g.resultMessage=a.ERROR.Message=p.returnObj.returnMsg,g.resultCode=a.ERROR.Code=p.returnObj.returnCode,a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){h.dispose(!0)},10),f(g);else if("E1000"==p.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(g),a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){h.dispose(!0)},10),f(g);else{var l=p.signResult.b64Signer;k=a.certUtil().getTheCertAttributes(l,"Base64");D(c,e,r,l,k);var q=a.usWebToolkit.util.decode64(p.signResult.b64SignedData[0]),v=a.usWebToolkit.pki.certificateFromBase64(l),w=a.usWebToolkit.pkcs7.createSignedData();w.signWithP1(q,b,v,null,null);q=a.usWebToolkit.pkcs7.messageToBase64(w);O(d,c,e,q,k,r,"",null,f,p.signResult.R[0],l);a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){h.dispose()},10)}},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]};w.msg[0]=l;w.plainText=[];w.plainText[0]=a.usWebToolkit.util.encodeUtf8(b);jSmartCertNP.SignByJSON(w).Open()}else Q(c,r,function(l){0!=l.rv?(a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=g.resultCode=l.rv,a.ERROR.Message=g.resultMessage=l.rvMsg,setTimeout(function(){h.dispose()},10),f(g)):(l=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().GetSignDataP7(c,e,l,T,!0,null,!0,!1,function(b,g,l,q,v,w){0!=b?(a.ERROR.Code=b,a.ERROR.Message=g,f(n(b,g))):(null==k&&a.CONST.__USFB_M_MOBILETOKEN.device==r?(k=a.certUtil().getTheCertAttributes(v,"Base64"),D(c,e,r,v,k)):D(c,e,r,t,k),O(d,c,e,l,k,r,w,p,f));e=d="";a.uiUtil().loadingBox(!1,"us-div-list-load");h.dispose()}))});else-1==c||""==e?(g.resultMessage=a.ERROR.Message=l,g.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){h.dispose(!0)},10),f(g)):(l=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.Whale().getSignDataP7(l,c,e,!0,function(b,p,l){0!=b?(g.resultCode=b,g.resultMessage=p,f(g)):(D(c,e,r,t,k),O(d,c,e,l,k,r,"",null,f));a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){h.dispose()},10)}));else if(r==a.CONST.__PF_M_CLOUDSIGN.device){a.uiUtil().loadingBox(!0,"us-div-list-load",1);var m=function(c,d,p,l,r,q){a.PFCS().reqVerifyVID(c,d,function(d,l,v){0==d?v?a.PFCS().reqGetCertR(c,function(d,l,v){0!=d&&(g.resultCode=d,g.resultMessage=l,setTimeout(function(){h.dispose()},10),q(n(d,l)));a.PFCS().reqGenSignNonVerifyPin(c,a.usWebToolkit.util.encodeUtf8(b),"Y",function(b,d,l){0!=b?(a.ERROR.Code=b,a.ERROR.Message=d,f(n(b,d))):(D(c,e,r,t,k),b=a.usWebToolkit.util.decode64(l),d=a.usWebToolkit.pki.certificateFromBase64(t),l=crosscert.pkcs7.createSignedData(),l.signWithP1(b,p,d,null,null),g.certAttrs=k,g.signedData=a.usWebToolkit.pkcs7.messageToBase64(l),g.curDevice=r,f(g));a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){h.dispose()},10)})}):(a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_MSGBOX_VID_ERROR_VERIFICATION,a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){h.dispose()},10),q(n(a.ERROR.Code,a.ERROR.Message))):(a.ERROR.Code=d,a.ERROR.Message=l,a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){h.dispose()},10),q(n(d,l)))})};if(d)m(c,d,b,q,r,f);else{var B=a.loadUI("ssn")({type:null,onConfirm:function(a){m(c,a,b,q,r,f);B.dispose()},onCancel:function(){f(n(-1,a.uiUtil().getUserCancelErrCodeNMsg()));B.dispose()}});B.show()}}else{try{t=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[c].signcert);w=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[c].signpri);var A=a.usWebToolkit.pkcs7.createSignedData();A.sign(b,t,w,e,null,null);var E=a.usWebToolkit.pkcs7.messageToBase64(A);O(d,c,e,E,q,r,"",null,f);h.dispose()}catch(F){a.ERROR.Code=F.code,a.ERROR.Message=F.message,a.uiUtil().errMsgBox(F.message,a.ERROR.Code),f(n(F.code,F.message))}setTimeout(function(){h.dispose()},10);c=e=t=w=null}},onCancel:function(){h.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}});h.show();return!0},MakeHash:function(b,c,d,e){function g(b,d){if(null==b||0>=b.length)d(0,"","");else if(4&a.ESVS.Mode)a.nimservice()?"FilePath"===m?(b=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().MakeHash(1,b,c,function(b,c,e){0==b?d(b,c,e):(a.ERROR.Code=b,a.ERROR.Message=c,d(b,c,""))})):(b=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().MakeHash(0,b,c,function(b,c,e){0==b?d(b,c,e):(a.ERROR.Code=b,a.ERROR.Message=c,d(b,c,""))})):(a.ERROR.Code=-1,d(-1,"",""));else if("FilePath"!==m)try{var e=a.usWebToolkit.util.encodeUtf8(h),f=crosscert.md.algorithms[k.toLowerCase()].create();f.start();f.update(e);d(0,"",a.usWebToolkit.util.encode64(f.digest().getBytes()))}catch(B){a.ERROR.Code=B.code,a.ERROR.Message=B.message,d(B.code,B.message,"")}}function f(a){g(a,function(a,b,c){0!=a?q(n(a,b)):(l[r]=c,r++,h.length==r?(t.hashValue=l,q(t)):f(h[r]))})}if(!b)return null;var h=b,k=c,m=d,l=[];k&&"undefined"!==typeof k||(k="SHA256");var t=n(),q=function(a){1==e.length?e(a):(null==a&&(a=n(-1)),e(a.resultCode,a.hashValue))};"string"===typeof b&&(h=[b]);var r=0;f(h[r])},EncryptData:function(b,c,d,e,g){function f(b,c,d,e,f,g,k,m){4&a.ESVS.Mode&&(a.nimservice()?(f=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(f)),a.nimservice().EnvelopData(b,c,d,e,f,!1,function(b,c,d){0==b?(h.encryptedData=d,k(h)):(a.ERROR.Code=b,a.uiUtil().errMsgBox(c,a.ERROR.Code),k(n(b,c)));m.dispose()})):(a.ERROR.Code=-1,k(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),m&&m.dispose(!0)))}if(!b||!g||document.getElementById("us-div-cert-select"))return!1;var h=n(),k=function(a){1==g.length?g(a):(null==a&&(a=n(-1)),g(a.resultCode,a.encryptedData))};a.reInitialize();if(d&&0<d.length)f("kmcert",-1,"",d,b,null,k,null);else{var m=a.loadUI("certselect")({type:"ENCRYPT_P7",args:{dn:c,possibleWhale:!1},onConfirm:function(a,c,e){f("kmcert",a,c,d,b,e,k,m)},onCancel:function(){m.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();k(n(a.ERROR.Code,a.ERROR.Message))}});m.show()}return!0},EncryptDatabySymm:function(b,c){if(!b)return null;var d=n();4&a.ESVS.Mode&&(a.nimservice()?(b=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().EncryptData(b,function(b,g,f){0==b?(d.encryptedData=f,c(d)):(a.ERROR.Code=b,c(n(b,g)))})):(a.ERROR.Code=-1,c(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER))))},EncryptDataWithSymmKey:function(b,c,d,e,g){if(!d||!c)return null;var f=n();if(4&a.ESVS.Mode)a.nimservice()?(d=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(d)),a.nimservice().EncryptDataWithSymmKey(b,c,d,e,!0,function(b,c,d){0==b?(f.encryptedData=d,g(f)):(a.ERROR.Code=b,g(n(b,c)))})):(a.ERROR.Code=-1,g(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)));else try{var h=crosscert.cipher.algorithms[symmAlgo].startEncrypting(key,iv);h.update(crosscert.util.createBuffer(d));h.finish();f.encryptedData=a.usWebToolkit.util.encode64(h.output.getBytes());g(f)}catch(k){a.ERROR.Code=k.code,a.ERROR.Message=k.message,g(n(a.ERROR.Code,a.ERROR.Message))}},DecryptDataWithSymmKey:function(b,c,d,e,g,f){if(!d||!c)return null;var h=n(),k=function(a){1==f.length?f(a):(null==a&&(a=n(-1)),f(a.resultCode,a.decryptedData))};if(4&a.ESVS.Mode)a.nimservice()?a.nimservice().DecryptDataWithSymmKey(b,c,d,e,g,function(b,c,d){0==b?("utf-8"==g.toLowerCase()?h.decryptedData=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(d)):h.decryptedData=a.usWebToolkit.util.decode64(d),k(h)):(a.ERROR.Code=b,k(n(b,c)))}):(a.ERROR.Code=-1,k(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)));else try{var m=a.usWebToolkit.util.decode64(d),l=crosscert.cipher.algorithms[symmAlgo].startDecrypting(key,iv);l.update(crosscert.util.createBuffer(m));l.finish();h.decryptedData=l.output.getBytes();k(h)}catch(t){a.ERROR.Code=t.code,a.ERROR.Message=t.message,k(n(a.ERROR.Code,a.ERROR.Message))}},SetConfigInfo:function(b){"undefined"!=typeof b.Mode&&(a.ESVS.Mode=u.Mode=P=b.Mode);"undefined"!=typeof b.SecureKeyboardType&&(a.ESVS.SecureKeyboardType=u.SecureKeyboardType=aa=b.SecureKeyboardType,"ahnlab"==aa?(eval(J({eval:!1,intergrity:!1,name:"astx2.min.js",url:"unisignweb/framework/keyboard/astx2.min.js"})),eval(J({eval:!1,intergrity:!1,name:"astx2_custom.js",url:"unisignweb/framework/keyboard/astx2_custom.js"}))):"touchen"==aa&&(X=b.touchEnFunc?b.touchEnFunc:{loading:TK_Loading,scan:TK_Rescan,encFunc:TK_GetEncCommWithSha2,flag:loadflag},a.ESVS.touchEnFunc=u.touchEnFunc=X,a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_KS_INSTALL_CHECK),a.nimservice().GetCertForKeyboardEncrypt(document.domain,"",function(b,c,d){0==b?(a.pubkey=d,a.ESVS.touchEnFunc.loading()):a.ESVS.SecureKeyboardType=u.SecureKeyboardType=aa="";a.uiUtil().createLoadingBox("hide","us-div-loading-dialog")})));if("undefined"!=typeof b.Language){var c=b.Language.toLowerCase().replace("-","_");a.ESVS.Language="ko_kr"!=c&&"en_us"!=c?"ko_kr":c;__FileUtil=__ForgeryUtil=__CertUtil=__UIUtil=null;__UIUtil=new Va;__CertUtil=new Wa;__ForgeryUtil=new Fa;__FileUtil=new Ya}if("undefined"!=typeof b.Media){c=b.Media;ka=!0;c.list=c.list?c.list.toLowerCase():null;c.defaultdevice?(c.defaultdevice=c.defaultdevice.toLowerCase(),null!=c.list&&(c.defaultdevice=0>c.list.indexOf(c.defaultdevice)?c.list.split("|")[0]:c.defaultdevice)):c.defaultdevice=null;if(void 0==c.defaultdevice||null==c.defaultdevice)c.defaultdevice=2==P?"browsersign":"harddisk";var d="";if(-1!=c.list.indexOf("browsersign")){d="https://browsersign.crosscert.com";var e=document.createElement("iframe");e.src=d+"/index.html";e.name="shareframe";e.id="shareframe";e.style.visibility="hidden";e.style.position="absolute";document.body.appendChild(e);Za=ab(a)}else pa="";a.ESVS.SHARESTORAGE=u.SHARESTORAGE=d;a.ESVS.Media=u.Media=c}"undefined"!=typeof b.verifyCertBeforeSign&&(a.ESVS.verifyCertBeforeSign=u.verifyCertBeforeSign=Ia=b.verifyCertBeforeSign);"undefined"!=typeof b.TabIndex&&(a.ESVS.TabIndex=u.TabIndex=na=b.TabIndex);"undefined"!=typeof b.LimitNumOfTimesToTryToInputPW&&(a.ESVS.LimitNumOfTimesToTryToInputPW=u.LimitNumOfTimesToTryToInputPW=ja=b.LimitNumOfTimesToTryToInputPW);"undefined"!=typeof b.Policy&&(a.ESVS.Policy=u.Policy=ya=b.Policy);"undefined"!=typeof b.ShowExpiredCerts&&(a.ESVS.ShowExpiredCerts=u.ShowExpiredCerts=za=b.ShowExpiredCerts);"undefined"!=typeof b.LimitMinNewPWLen&&(a.ESVS.LimitMinNewPWLen=u.LimitMinNewPWLen=V=b.LimitMinNewPWLen);"undefined"!=typeof b.LimitMaxNewPWLen&&(a.ESVS.LimitMaxNewPWLen=u.LimitMaxNewPWLen=W=b.LimitMaxNewPWLen);"undefined"!=typeof b.LimitNewPWPattern&&(a.ESVS.LimitNewPWPattern=u.LimitNewPWPattern=fa=b.LimitNewPWPattern);"undefined"!=typeof b.CertRequestPageEnable&&(a.ESVS.CertRequestPageEnable=u.CertRequestPageEnable=Aa=b.CertRequestPageEnable)},SignFileP7:function(b,c,d,e,g,f){if(document.getElementById("us-div-cert-select")||!f||!b||0<d&&!e)return!1;var h=n(),k=function(a){1==f.length?f(a):(null==a&&(a=n(-1)),f(a.resultCode,a.signedData,a.curDevice))};a.reInitialize();var m=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_FILE",args:{dn:c,possibleWhale:!1},onConfirm:function(c,f,q,r,p,v,w){4&a.ESVS.Mode&&(a.nimservice()?Q(c,v,function(p){if(0!=p.rv)a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=h.resultCode=p.rv,a.ERROR.Message=h.resultMessage=p.rvMsg,setTimeout(function(){m.dispose()},10),k(h);else{p=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));var r="";null!=e&&(r=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(e)));p=[p,d,r,1];a.nimservice().GetSignFileP7(c,f,p,g,null,function(b,e,g,p,r,l){0!=b?(a.ERROR.Code=b,a.ERROR.Message=e,k(n(a.ERROR.Code,a.ERROR.Message))):(h.curDevice=v,h.tokenLabel=l,null!=w&&v==a.CONST.__USFB_M_HSMKEY.device&&(h.tokenName=w.name,h.tokenDriver=w.driver),h.signedData=0<d?a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(g)):g,k(h));c=f=cert=pri=null;a.uiUtil().loadingBox(!1,"us-div-list-load");m.dispose()})}}):(k(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),m.dispose(!0)))},onCancel:function(){m.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();k(n(a.ERROR.Code,a.ERROR.Message))}});m.show();return!0},SignMultiFileP7:function(b,c,d,e,g,f){if(!b||!f||document.getElementById("us-div-cert-select"))return!1;var h=n(),k=function(a){1==f.length?f(a):(null==a&&(a=n(-1)),f(a.resultCode,a.jsonSignedData,a.curDevice))};a.reInitialize();var m=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_FILE",args:{dn:c,possibleWhale:!1},onConfirm:function(c,f,q,r,p,v,w){var l={};4&a.ESVS.Mode?a.nimservice()?Q(c,v,function(p){if(0!=p.rv)a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=h.resultCode=p.rv,a.ERROR.Message=h.resultMessage=p.rvMsg,setTimeout(function(){m.dispose()},10),k(h);else{p=0;var r=[],q=[];if(b)if("object"==typeof b)for(var t in b)r[p++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b[t]));else r=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));if(e)if(p=0,"object"==typeof b)for(t in e)q[p++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(e[t]));else q=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(e));t=[r,d,q,1];a.nimservice().GetSignFileP7(c,f,t,g,null,function(e,g,p,r,q,t){if(0!=e)a.ERROR.Code=e,a.ERROR.Message=g,k(n(a.ERROR.Code,a.ERROR.Message));else{e=0;if(1==d)if("object"==typeof p)for(var z in b)l[z]=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(p[e++]));else l=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(p));else if("object"==typeof p)for(z in b)l[z]=p[e++];else l=p;h.curDevice=v;h.jsonSignedData=l;h.tokenLabel=t;null!=w&&v==a.CONST.__USFB_M_HSMKEY.device&&(h.tokenName=w.name,h.tokenDriver=w.driver);k(h)}c=f=cert=pri=null;a.uiUtil().loadingBox(!1,"us-div-list-load");m.dispose()})}}):(k(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),m.dispose(!0)):(k(null),m.dispose(!0))},onCancel:function(){m.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();k(n(a.ERROR.Code,a.ERROR.Message))}});m.show();return!0},SetUBIKeyEnvInfo:function(b,c,d,e){a.ubiKeyEnv={version:b,siteInfo:c,securityInfo:d,downloadURL:e}},SetMobileTokenEnvInfo:function(b,c,d,e,g,f){var h=f;if("undefined"!==typeof f||null==f||0>=f.length)h="http://download.smartcert.kr";a.usimEnv={sitecode:b,modecode:c,siteURL:d,serviceIP:e,servicePort:g,downloadURL:h}},DecryptData:function(b,c){function d(c,d,f,l){4&a.ESVS.Mode&&(a.nimservice()?a.nimservice().DeEnvelopData("kmcert",c,d,b,function(b,c,d){0==b?(e.decryptedData=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(d)),g(e)):(a.ERROR.Code=b,a.uiUtil().errMsgBox(c,a.ERROR.Code),g(n(b,c)));l.dispose()}):(a.ERROR.Code=-1,g(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),l.dispose()))}if(!b||!c||document.getElementById("us-div-cert-select"))return!1;var e=n(),g=function(a){1==c.length?c(a):(null==a&&(a=n(-1)),c(a.resultCode,a.decryptedData))};a.reInitialize();var f=a.loadUI("certselect")({type:"ENCRYPT_P7",args:{dn:null,possibleWhale:!1},onConfirm:function(a,b,c){d(a,b,c,f)},onCancel:function(){f.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();g(n(a.ERROR.Code,a.ERROR.Message))}});f.show();return!0},VerifyKeyPair:function(b){function c(c,d,f,l,t){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(f))a.nimservice().GetSignDataP7(c,d,e,T,!0,null,!0,!1,function(c,d,e,f,h,k){0!=c?(a.ERROR.Code=c,a.ERROR.Message=d,g.errmsg=d,l&&l.dispose(!0),b(n(a.ERROR.Code,g))):a.nimservice().VerifySignedData(null,e,function(b,c,d){0!=b?(a.ERROR.Code=a.nimservice().GetLastErrorCode(),a.ERROR.Message=a.nimservice().GetLastErrorMessage(),g.signcert=a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_SIGN+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_FAIL+"("+a.uiUtil().getErrorMessageLang().IDS_VERIFY_SIGN+")"):g.signcert=a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_SIGN+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_OK;t(0)})});else{f="";try{var h=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[c].signcert),k=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[c].signpri),p=a.usWebToolkit.pkcs7.createSignedData();p.sign(e,h,k,d,null,null);f=a.usWebToolkit.pkcs7.messageToBase64(p)}catch(w){a.ERROR.Code=w.code;a.ERROR.Message=w.message;112047==w.code&&(a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD);l&&l.dispose(!0);g.errmsg=a.ERROR.Message;t(0);return}try{var v=a.usWebToolkit.pkcs7.messageFromBase64(f);v.verify()}catch(w){a.ERROR.Code=w.code,a.ERROR.Message=w.message,g.signcert=a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_SIGN+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_FAIL+"("+a.uiUtil().getErrorMessageLang().IDS_VERIFY_SIGN+")",t(0)}g.signcert=v.verifyResult?a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_SIGN+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_OK:a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_SIGN+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_FAIL+"("+a.uiUtil().getErrorMessageLang().IDS_VERIFY_SIGN+")";t(0)}}function d(c,d,f,l){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(f))a.nimservice().EnvelopData("kmcert",c,d,null,e,!0,function(e,f,h){0==e?a.nimservice().DeEnvelopData("kmcert",c,d,h,function(c,d,e){g.kmcert=0==c?a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_OK:-2==c?a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_NONE:a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_FAIL+"("+d+")";l&&l.dispose();b(n(0,g))}):(g.kmcert=-2==e?a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_NONE:a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_FAIL+"("+f+")",l&&l.dispose(),b(n(0,g)))});else{if(a.PFUC[c].kmcert){f="";try{var h=crosscert.pkcs7.createEnvelopedData(),k=crosscert.pki.certificateFromBase64(a.PFUC[c].kmcert);h.addRecipient(k);h.encContent.algorithm=crosscert.pki.oids["seed-CBC"];h.content=crosscert.util.createBuffer(e);h.encrypt();f=crosscert.pkcs7.messageToBase64(h)}catch(p){g.kmcert=a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_FAIL+"("+p.message+")";l&&l.dispose();b(n(0,g));return}try{h=crosscert.pkcs7.messageFromBase64(f);var r=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[c].kmpri);privKey=crosscert.pkcs8.decryptPrivateKeyInfo(r,d);privKey=crosscert.pki.privateKeyFromAsn1(privKey);h.decrypt(h.recipients[0],privKey);h.content&&(g.kmcert=a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_OK)}catch(p){g.kmcert=a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_FAIL+"("+p.message+")"}}else g.kmcert=a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_KM+" : "+a.uiUtil().getErrorMessageLang().IDS_VERIFYKEY_FAIL+"("+a.uiUtil().getErrorMessageLang().IDS_NO_KMCERT+")";l&&l.dispose();b(n(0,g))}}if(!b)return!1;n();var e=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00")),g={errmsg:"",signcert:"",kmcert:""};a.reInitialize();var f=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_EXT_MOBILE",args:{dn:null,possibleWhale:!1},onConfirm:function(e,k,m){a.uiUtil().isItPFDevice(m)?c(e,k,m,f,function(a){d(e,k,m,f)}):Q(e,m,function(h){0!=h.rv?(a.ERROR.Code=h.rv,g.errmsg=a.ERROR.Message=h.rvMsg,f&&setTimeout(function(){f.dispose()},10),b(n(a.ERROR.Code,g))):c(e,k,m,f,function(a){d(e,k,m,f)})})},onCancel:function(){f.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();g.errmsg=a.ERROR.Message;b(n(a.ERROR.Code,g))}});f.show();return!0},VerifyP7SignedFileWithFile:function(b,c,d,e,g,f){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!d||0<e&&!g)return null;a.reInitialize();if(4&a.ESVS.Mode&&a.nimservice()){var h=null;null!=b&&(h=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)));b=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(d));g=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(g));a.nimservice().VerifySignedFile(h,c,b,e,g,function(b,c,d,g){0!=b?(a.ERROR.Code=a.nimservice().GetLastErrorCode(),a.ERROR.Message=a.nimservice().GetLastErrorMessage(),f(b,null)):0<e?(c=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(d)),f(b,c,g)):f(b,d,g);a.uiUtil().loadingBox(!1,"us-div-list-load")})}}},VerifyP7SignedDataWithFile:function(b,c,d,e,g){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!c||1==d&&!e)return null;a.reInitialize();if(4&a.ESVS.Mode&&a.nimservice()){var f=null;null!=b&&(f=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)));b=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(e));a.nimservice().VerifySignedFile(f,0,c,d,b,function(b,c,e,f){0!=b?(a.ERROR.Code=a.nimservice().GetLastErrorCode(),a.ERROR.Message=a.nimservice().GetLastErrorMessage(),g(b,null)):1==d?(c=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(e)),g(b,c,f)):g(b,e,f);a.uiUtil().loadingBox(!1,"us-div-list-load")})}}},RenewCertNSignedSubjectDn:function(b,c,d,e,g,f,h,k){function m(b,c,d,h,k,r,l,m,y){b=!0;d!=a.CONST.__USFB_M_MOBILETOKEN.device&&(b=confirm(c));if(b){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(d)){if(d!=a.CONST.__USFB_M_DISK.device&&d!=a.CONST.__USFB_M_HDD.device||null==a.Whale())a.nimservice()?(c=a.loadUI("certprocessing"),RenewingDialog=c({type:"CERT_RENEWAL",args:null,onConfirm:null,onCancel:null}),RenewingDialog.show(),a.nimservice().RenewCertificate(a.ESVS.CMPIP,a.ESVS.CMPPort,k,r,l,m,e,function(b,c,p){q.resultCode=b;q.resultMessage=c;q.curDevice=d;q.curDrive=h;d==a.CONST.__USFB_M_MOBILETOKEN.device&&p&&(y=a.certUtil().getTheCertAttributes(p,"Base64"));if(0==b)RenewingDialog.dispose(0,0,null,!1,function(){q.certAttrs=y;t(q)}),a.uiUtil().loadingBox(!1,"us-div-list-load");else if(a.ERROR.Code=b,a.ERROR.Message=c,a.uiUtil().loadingBox(!1,"us-div-list-load"),1==e&&null!=y&&y.subjectName){var r=1==g?"utf8":"euckr",l=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(y.subjectName));a.nimservice().GetAllUserCertListNum(d,h,m,function(e,g,h){a.nimservice().GetSignDataP7(k,m,l,r,!0,null,!1,!1,function(e,g,h,k,p,r){RenewingDialog.dispose(b,a.ERROR.Code,a.ERROR.Message,f,function(){0==e?(null==y&&a.CONST.__USFB_M_MOBILETOKEN.device==d&&(y=a.certUtil().getTheCertAttributes(p,"Base64")),q.certAttrs=y,q.signedData=h):(q.resultMessage=c,q.certAttrs=y);t(q);a.uiUtil().loadingBox(!1,"us-div-list-load")})})})}else ca(),a.uiUtil().loadingBox(!1,"us-div-list-load"),RenewingDialog.dispose(b,a.ERROR.Code,c?c:a.ERROR.Message,!1,function(){q.resultCode=b;q.resultMessage=c;q.certAttrs=y;q.curDevice=d;q.curDrive=h;t(q)})})):(ca(),t(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)));else{c=a.loadUI("certprocessing");RenewingDialog=c({type:"CERT_RENEWAL",args:null,onConfirm:null,onCancel:null});RenewingDialog.show();var p=m;""!=l&&(p=l);a.Whale().reNewCertificate(k,p,function(b,c){q.resultCode=b;q.resultMessage=c;q.curDevice=d;q.curDrive=h;if(0==b)RenewingDialog.dispose(0,0,null,!1,function(){q.certAttrs=y;t(q)}),a.uiUtil().loadingBox(!1,"us-div-list-load");else{a.ERROR.Code=b;var g=c;3604==b&&(g=a.uiUtil().getErrorMessageLang().IDS_ERROR_RENEW_WHALE,q.resultMessage=g);a.ERROR.Message=g;a.uiUtil().loadingBox(!1,"us-div-list-load");1==e&&null!=y&&y.subjectName?(c=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(y.subjectName)),a.Whale().getSignDataP7(c,k,m,!0,function(c,d,e){RenewingDialog.dispose(b,a.ERROR.Code,a.ERROR.Message,f,function(){0==c?(q.certAttrs=y,q.signedData=e):(q.resultMessage=a.ERROR.Message,q.certAttrs=y);t(q);a.uiUtil().loadingBox(!1,"us-div-list-load")})})):(a.uiUtil().loadingBox(!1,"us-div-list-load"),RenewingDialog.dispose(b,a.ERROR.Code,g?g:a.ERROR.Message,!1,function(){q.resultCode=b;q.resultMessage=g;q.certAttrs=y;q.curDevice=d;q.curDrive=h;t(q)}))}})}return!1}if(2&a.ESVS.Mode&&a.uiUtil().isItPFDevice(d)){var v=function(b,c,e){1==b?RenewingDialog.dispose(0,0,null,!0,function(){var b=a.loadUI("confirm")({type:null,args:{msg:w.IDS_CONFIRMBOX_WILL_YOU_BACKUP_CERT},onConfirm:function(){b.dispose();a.CONST.__PF_M_LS.device===d?a.uiUtil().isItPortableDevice()?fb():eb(p):a.CONST.__PF_M_SS.device===d&&(a.uiUtil().isItPortableDevice()?hb():gb(p));p=null;t(q)},onCancel:function(){b.dispose();pw=null;a.uiUtil().getUserCancelErrCodeNMsg();t(n(a.ERROR.Code,a.ERROR.Message))}});b.show()}):2==b?RenewingDialog.dispose(b,b,c,!0,function(){t(n(b,c))}):3==b&&(b=e.code,RenewingDialog.dispose(b,b,e.message,!0,function(){t(n(b,e.message))}))};c=a.loadUI("certprocessing");RenewingDialog=c({type:"CERT_RENEWAL",args:null,onConfirm:null,onCancel:null});RenewingDialog.show();p=m;""!=l&&(p=l);r=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");r.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/lang/"+a.ESVS.Language+"/certbackup_"+a.ESVS.Language+".js?version="+a.ver,!1);r.send(null);var w=eval(r.responseText);if(a.CONST.__PF_M_LS.device===d)a.usWebToolkit.usWebCMP.update(a.PFUC[k].signcert,a.PFUC[k].signpri,a.PFUC[k].kmcert,a.PFUC[k].kmpri,pwd,document.domain,"",a.PFSH,v);else if(a.CONST.__PF_M_SS.device===d){var z=function(b,c,d,e){a.CCPFSH().SaveUserCert(d,c,!1,function(a,b){e(a)})};a.CCPFSH().GetCCStorageHandler(u.EncAlgo,u.HashAlgo,u.BSPKI,function(b,c){a.usWebToolkit.usWebCMP.update(a.PFUC[k].signcert,a.PFUC[k].signpri,a.PFUC[k].kmcert,a.PFUC[k].kmpri,p,null,"",c,v,null,null,null,z)})}}}else ca()}if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else if(h&&!document.getElementById("us-div-cert-select")){var l=b;b&&a.uiUtil().isValidDevice(b)||(d=null,l=c=-1);var t=h,q=n();a.reInitialize();var r=a.loadUI("certselect")({type:"CERT_RENEWAL_SIGN",args:{device:l,drive:c,dn:d,possibleWhale:!0},onConfirm:function(b,c,d,e,f,g,h){r.dispose();var p=!0;k&&(p=k(h));if(!p)return q.resultCode=a.ERROR.Code=998,q.resultMessage=a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_NOALLOW_UPDATECERT,q.certAttrs=h,t(q),!0;a.CONST.__USFB_M_HSMKEY.device!=d&&a.CONST.__USFB_M_SMARTCARD.device!=d&&a.CONST.__USFB_M_MOBILETOKEN.device!=d?a.uiUtil().CheckPwdPattern(g,function(k){1==k?m(b,c,d,e,f,"","",g,h):(PWDialog=a.loadUI("newpassword")({type:null,args:{renew:!0,pw:g},onConfirm:function(a,k){PWDialog.dispose();m(b,c,d,e,f,a,k,g,h)},onCancel:function(){ca();PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();t(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}):m(b,c,d,e,f,"","",g,h)},onCancel:function(){r.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();t(n(a.ERROR.Code,a.ERROR.Message))}});r.show();return!0}},SetOptions:function(b,c){a.options[b]=c},MakeTaxXMLDSIGNVID:function(b,c,d,e,g,f){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||!f)return!1;var h=b;"string"===typeof b&&(h=[b]);var k=n();a.reInitialize();a.ESVS.multiuse=!0;var m=function(){var b=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_XML",args:{dn:null,possibleWhale:!0},onConfirm:function(c,d,r,l,q,m,t){var p={};if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(q))if(q!=a.CONST.__USFB_M_DISK.device&&q!=a.CONST.__USFB_M_HDD.device||null==a.Whale())a.nimservice()?(v=d,O(e,r,l,"",v,q,"",null,function(c){if(0!=c.resultCode)a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){b.dispose()},10),f(c);else{var d=0;c=[];for(var e in h)c[d++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(h[e]));a.nimservice().MakeXMLDSIG(r,l,c,g,1,function(c,e,g,w,z,u){a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){b.dispose()},10);if(0!=c)a.ERROR.Code=c,a.ERROR.Message=e,f(n(a.ERROR.Code,a.ERROR.Message));else{d=0;if("object"==typeof g)for(var A in h)p[A]=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(g[d++]));else p=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(g));a.CONST.__USFB_M_MOBILETOKEN.device==q?(v=a.certUtil().getTheCertAttributes(z,"Base64"),D(r,l,q,z,v)):D(r,l,q,m,v);k.signedData=p;k.certAttrs=v;k.tokenLabel=u;null!=t&&q==a.CONST.__USFB_M_HSMKEY.device&&(k.tokenName=t.name,k.tokenDriver=t.driver);k.b64RValue=w;f(k)}})}})):(f(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),setTimeout(function(){b.dispose(!0)},10));else if(-1==r||""==l)k.resultMessage=a.ERROR.Message=c,k.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){b.dispose(!0)},10),f(k);else{var v=d;O(e,r,l,"",v,q,"",null,function(c){0!=c.resultCode?(a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){b.dispose()},10),f(c)):ma(h,v,r,l,m,g,function(c){a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){b.dispose()},10);f(c)})})}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message));b.dispose(!0)}});b.show()};if(""==c||null==c)m();else{b=function(b,c,d){b!=a.CONST.__USFB_M_DISK.device&&b!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice().GetAllUserCertListNum(b,c,"",function(c,e,f){nCertsCnt=f;if(0==c)0<nCertsCnt?a.nimservice().GetAllUserCert(f,function(b,c){0==b?a.certsList={list:c}:a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)}):(a.certsList=null,a.uiUtil().loadingBox(!1,"us-div-cert-list-load"),d(0));else{if(b==a.CONST.__USFB_M_MOBILE.device&&61E6==c)return a.ERROR.Code=11003,a.ERROR.Message=__lang.IDS_MSGBOX_NOT_INSTALL_MOBILE,document.getElementById("us-cls-btn").click(),"firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"),a.certsList=null,d(c),!1;-1!==nCertsCnt&&(a.nimservice().GetLastErrorCode(),a.nimservice().GetLastErrorMessage());d(c);a.certsList=null;a.uiUtil().loadingBox(!1,"us-div-cert-list-load")}}):a.Whale().getCerts(__device,__drive,function(b,c,e){0==b?a.certsList={list:e}:a.uiUtil().errMsgBox(c,b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)})};var l=function(b,c){var d={};4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(a.SELECTINFO.curdevice)&&(a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice()?O(e,b,c,"",a.SELECTINFO.certattrs,a.SELECTINFO.curdevice,"",null,function(e){if(0!=e.resultCode)f(e);else{var p=0;e=[];for(var r in h)e[p++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(h[r]));a.nimservice().MakeXMLDSIG(b,c,e,g,1,function(e,g,r,l,q,m){if(0!=e)a.ERROR.Code=e,a.ERROR.Message=g,f(n(a.ERROR.Code,a.ERROR.Message));else{p=0;if("object"==typeof r)for(var v in h)d[v]=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(r[p++]));else d=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(r));e=a.SELECTINFO.certattrs;a.CONST.__USFB_M_MOBILETOKEN.device==a.SELECTINFO.curdevice?(e=a.certUtil().getTheCertAttributes(q,"Base64"),D(b,pw,a.SELECTINFO.curdevice,q,e)):D(b,c,a.SELECTINFO.curdevice,a.SELECTINFO.cert,e);k.signedData=d;k.certAttrs=e;k.tokenLabel=m;k.b64RValue=l;f(k)}})}}):f(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)):O(e,b,c,"",a.SELECTINFO.certattrs,a.SELECTINFO.curdevice,"",null,function(d){0!=d.resultCode?f(d):ma(h,a.SELECTINFO.certattrs,b,c,a.SELECTINFO.cert,g,function(a){f(a)})}))},t=function(){for(var b=-1,d=0,e=0;e<a.certsList.list.length;e++)if(a.SELECTINFO.curdevice==a.CONST.__PF_M_CLOUD.device){if(a.certsList.list[e].cert&&a.certsList.list[e].cert.subject_dn){var f=a.usWebToolkit.util.decode64(a.certsList.list[e].cert.subject_dn);if(c==f)if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){b=a.certsList.list[e].index;d++;break}}else b=a.certsList.list[e].index,d++}}else if(null!=a.certsList.list[e]&&null!=a.certsList.list[e].cert&&(a.usWebToolkit.x509Certificate.parser(a.certsList.list[e].cert,"Base64"),c==a.usWebToolkit.x509Certificate.getSubjectName()))if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){b=a.certsList.list[e].index;d++;break}}else b=a.certsList.list[e].index,d++;1<d&&(b=-1);return b};if(null==a.certsList)b(a.SELECTINFO.curdevice,0,function(b){if(0!=b)a.uiUtil().errMsgBox(a.uiUtil().getErrorMessageLang().IDS_MSGBOX_COMMON_ERROR_GET_CERT,b);else{var c=t();0>c?m():null!=d&&""!=d||null!=a.SELECTINFO.pw?null!=d&&""!=d||a.SELECTINFO.index!=c||null==a.SELECTINFO.pw?l(c,d):l(c,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();l(c,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}});else{var q=t();0>q?m():null!=d&&""!=d||null!=a.SELECTINFO.pw?null!=d&&""!=d||a.SELECTINFO.index!=q||null==a.SELECTINFO.pw?l(q,d):l(q,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();l(q,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}}return!0}},MakeTaxXMLDSIG:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||!e)return!1;var g=b;"string"===typeof b&&(g=[b]);var f=n();a.reInitialize();var h=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_XML",args:{dn:c,possibleWhale:!0},onConfirm:function(b,c,l,t,q,r,p){var k={};if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(q))if(q!=a.CONST.__USFB_M_DISK.device&&q!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(a.nimservice()){var m=0;b=[];for(var z in g)b[m++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(g[z]));a.nimservice().MakeXMLDSIG(l,t,b,d,0,function(b,d,l,r,v,w){if(0!=b)a.ERROR.Code=b,a.ERROR.Message=d,e(n(a.ERROR.Code,a.ERROR.Message));else{m=0;if("object"==typeof l)for(var t in g)k[t]=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(l[m++]));else k=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(l));a.CONST.__USFB_M_MOBILETOKEN.device==q&&(c=a.certUtil().getTheCertAttributes(v,"Base64"));f.signedData=k;f.b64RValue=r;f.certAttrs=c;f.tokenLabel=w;null!=p&&q==a.CONST.__USFB_M_HSMKEY.device&&(f.tokenName=p.name,f.tokenDriver=p.driver);e(f)}a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){h.dispose()},10)})}else e(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),setTimeout(function(){h.dispose(!0)},10);else-1==l||""==t?(f.resultMessage=a.ERROR.Message=b,f.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){h.dispose(!0)},10),e(f)):ma(g,c,l,t,r,d,function(b){a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){h.dispose()},10);e(b)})},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message));h.dispose(!0)}});h.show();return!0}},MakeTaxXMLDSIGNonEnveloped:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||!e)return!1;var g=b;"string"===typeof b&&(g=[b]);var f=n();a.reInitialize();var h=function(){var b=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_XML",args:{dn:null,possibleWhale:!0},onConfirm:function(c,d,h,k,l,m,t){var p={};if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(l))if(l!=a.CONST.__USFB_M_DISK.device&&l!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(a.nimservice()){var r=0;c=[];for(var q in g)c[r++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(g[q]));a.nimservice().MakeXMLDSIG(h,k,c,"",1,function(c,h,k,q,m,v){a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){b.dispose()},10);if(0!=c)a.ERROR.Code=c,a.ERROR.Message=h,e(n(a.ERROR.Code,a.ERROR.Message));else{r=0;if("object"==typeof k)for(var w in g)p[w]=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(k[r++]));else p=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(k));a.CONST.__USFB_M_MOBILETOKEN.device==l&&(d=a.certUtil().getTheCertAttributes(m,"Base64"));f.signedData=p;f.certAttrs=d;f.tokenLabel=v;null!=t&&l==a.CONST.__USFB_M_HSMKEY.device&&(f.tokenName=t.name,f.tokenDriver=t.driver);e(f)}})}else e(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER)),setTimeout(function(){b.dispose(!0)},10);else-1==h||""==k?(f.resultMessage=a.ERROR.Message=c,f.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){b.dispose(!0)},10),e(f)):ma(g,d,h,k,m,null,function(c){a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){b.dispose()},10);e(c)})},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message));b.dispose(!0)}});b.show()};if(""==c||null==c)h();else{b=function(b,c,d){b!=a.CONST.__USFB_M_DISK.device&&b!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice().GetAllUserCertListNum(b,c,"",function(c,e,f){nCertsCnt=f;if(0==c)0<nCertsCnt?a.nimservice().GetAllUserCert(f,function(b,c){0==b?a.certsList={list:c}:a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)}):(a.certsList=null,a.uiUtil().loadingBox(!1,"us-div-cert-list-load"),d(0));else{if(b==a.CONST.__USFB_M_MOBILE.device&&61E6==c)return a.ERROR.Code=11003,a.ERROR.Message=__lang.IDS_MSGBOX_NOT_INSTALL_MOBILE,document.getElementById("us-cls-btn").click(),"firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"),a.certsList=null,d(c),!1;-1!==nCertsCnt&&(a.nimservice().GetLastErrorCode(),a.nimservice().GetLastErrorMessage());d(c);a.certsList=null;a.uiUtil().loadingBox(!1,"us-div-cert-list-load")}}):a.Whale().getCerts(__device,__drive,function(b,c,e){0==b?a.certsList={list:e}:a.uiUtil().errMsgBox(c,b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)})};var k=function(b,c){var d={};if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(a.SELECTINFO.curdevice))if(a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(a.nimservice()){var h=0,k=[],l;for(l in g)k[h++]=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(g[l]));a.nimservice().MakeXMLDSIG(b,c,k,"",1,function(b,c,k,p,l,r){if(0!=b)a.ERROR.Code=b,a.ERROR.Message=c,e(n(a.ERROR.Code,a.ERROR.Message));else{h=0;if("object"==typeof k)for(var q in g)d[q]=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(k[h++]));else d=a.usWebToolkit.util.decodeUtf8(a.usWebToolkit.util.decode64(k));b=a.SELECTINFO.certattrs;a.CONST.__USFB_M_MOBILETOKEN.device==a.SELECTINFO.curdevice&&(b=a.certUtil().getTheCertAttributes(l,"Base64"));f.signedData=d;f.certAttrs=b;f.tokenLabel=r;e(f)}})}else e(n(-1,a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER));else ma(g,a.SELECTINFO.certattrs,b,c,a.SELECTINFO.cert,null,function(a){e(a)})},m=function(){for(var b=-1,d=0,e=0;e<a.certsList.list.length;e++)if(a.SELECTINFO.curdevice==a.CONST.__PF_M_CLOUD.device){if(a.certsList.list[e].cert&&a.certsList.list[e].cert.subject_dn){var f=a.usWebToolkit.util.decode64(a.certsList.list[e].cert.subject_dn);if(c==f)if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){b=a.certsList.list[e].index;d++;break}}else b=a.certsList.list[e].index,d++}}else if(null!=a.certsList.list[e]&&null!=a.certsList.list[e].cert&&(a.usWebToolkit.x509Certificate.parser(a.certsList.list[e].cert,"Base64"),c==a.usWebToolkit.x509Certificate.getSubjectName()))if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){b=a.certsList.list[e].index;d++;break}}else b=a.certsList.list[e].index,d++;1<d&&(b=-1);return b};if(null==a.certsList)b(a.SELECTINFO.curdevice,0,function(b){if(0!=b)a.uiUtil().errMsgBox(a.uiUtil().getErrorMessageLang().IDS_MSGBOX_COMMON_ERROR_GET_CERT,b);else{var c=m();0>c?h():null!=d&&""!=d||null!=a.SELECTINFO.pw?null!=d&&""!=d||a.SELECTINFO.index!=c||null==a.SELECTINFO.pw?k(c,d):k(c,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();k(c,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}});else{var l=m();0>l?h():null!=d&&""!=d||null!=a.SELECTINFO.pw?null!=d&&""!=d||a.SELECTINFO.index!=l||null==a.SELECTINFO.pw?k(l,d):k(l,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();k(l,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}}return!0}},DecryptWithUserSymmKey:function(b,c,d,e,g){function f(c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(0==b){for(;-1<d.indexOf("-");)d=d.replace("-","");if(10>d.length)return-11}else if(1==b&&6>d.length)return-11;var f=d;var g=0;for(d=d.length;16>d;d++)f+="abcdefghijklmnopqrstuvwxyz".substr(g++,1);g=f+"0123450123456789";f=g.substring(0,16);g=g.substring(16,32);e=a.usWebToolkit.util.decode64(e);d=null;try{var h=a.usWebToolkit.cipher.algorithms[c].startDecrypting(f,g);h.update(a.usWebToolkit.util.createBuffer(e));if(0==h.finish())return-11;d=h.output.getBytes()}catch(w){return a.ERROR.Code=w.code,a.ERROR.Message=w.message,-12}return d}}if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{var h=n();if("seed"!=c)a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_ALGORITHM,g(n(a.ERROR.Code,a.ERROR.Message));else if(null==e||""==e||1>e.length)alert(a.uiUtil().getErrorMessageLang().IDS_NOT_ENCRYPTED_DATA);else{a.reInitialize();var k=0,m=a.loadUI("securemail")({type:"SECURE_MAIL",args:{algorithm:c,data:e,decryptData:f,mode:b},onConfirm:function(c,d,e,r){3<k?(null!=document.getElementById("html_encripted")&&(document.getElementById("html_encripted").innerHTML=""),alert(e.IDS_KEY_TYPE[b]+e.IDS_PASSWORD_WRONG),m.dispose()):(r=document.getElementById("us-input-secure-mail-password"),c=f(c,r.value,d),h.resultCode=c,-10===c?(a.ERROR.Code=-10,a.ERROR.Message=e.IDS_ALGORITHM_ALERT,m.dispose(),g(h)):-11===c?(a.ERROR.Code=-11,a.ERROR.Message=e.IDS_KEY_TYPE[b]+e.IDS_PASSWORD_WRONG,4<k?(m.dispose(),g(h)):(k+=1,alert(e.IDS_KEY_TYPE[b]+e.IDS_DISCORDANCE_PASSWORD.replace("@",k)),r.value="")):-12===c?(m.dispose(),g(h)):-13===c?(a.ERROR.Code=-13,a.ERROR.Message=e.IDS_KEY_TYPE[b]+e.IDS_PASSWORD_WRONG,4<k?(m.dispose(),g(h)):(k+=1,alert(e.IDS_KEY_TYPE[b]+e.IDS_DISCORDANCE_PASSWORD.replace("@",k)),r.value="")):(m.dispose(),h.resultCode=0,h.decryptedData=c,g(h)))},onCancel:function(){m.dispose();a.uiUtil().getUserCancelErrCodeNMsg();g(n(a.ERROR.Code,a.ERROR.Message))}});m.show()}}},EncryptDataWithCert:function(b,c,d){if(!b||!d)return!1;var e=n();a.reInitialize();try{var g=a.usWebToolkit.pki.certificateFromBase64(c),f=a.usWebToolkit.pkcs7.createEnvelopedData();f.addRecipient(g);f.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];f.content=a.usWebToolkit.util.createBuffer(b);f.encrypt();e.encryptedData=a.usWebToolkit.pkcs7.messageToBase64(f);d(e)}catch(h){a.ERROR.Code=h.code,a.ERROR.Message=h.message,d(n(a.ERROR.Code,a.ERROR.Message))}},GetMacAddress:function(b,c){if(!c)return!1;var d=n();a.reInitialize();4&a.ESVS.Mode&&a.nimservice().GetMacAddress(b,function(b,g,f){0!=b?(a.ERROR.Code=b,a.ERROR.Message=g,c(n(a.ERROR.Code,a.ERROR.Message))):(d.mac=f,c(d))})},SetMultiUsingOpt:function(b){a.ESVS.multiuse=b},CheckConnectToCAServer:function(b,c,d){if(!d)return!1;a.reInitialize();4&a.ESVS.Mode&&a.nimservice().CheckConnectToCAServer(a.ESVS.CMPIP,a.ESVS.CMPPort,b,c,function(b,c){a.ERROR.Code=b;a.ERROR.Message=c;d(n(a.ERROR.Code,a.ERROR.Message))})},SetSystemTimeFromTimeServer:function(b,c,d){if(!d)return!1;a.reInitialize();4&a.ESVS.Mode&&a.nimservice().SetSystemTimeFromTimeServer(b,c,function(b,c){a.ERROR.Code=b;a.ERROR.Message=c;d(n(a.ERROR.Code,a.ERROR.Message))})},GetRValueFromKey:function(b,c,d){if(!d)return!1;var e=n(),g=function(b,c,d){b!=a.CONST.__USFB_M_DISK.device&&b!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice().GetAllUserCertListNum(b,c,"",function(c,e,f){nCertsCnt=f;if(0==c)0<nCertsCnt?a.nimservice().GetAllUserCert(f,function(b,c){0==b?a.certsList={list:c}:a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)}):(a.certsList=null,a.uiUtil().loadingBox(!1,"us-div-cert-list-load"),d(0));else{if(b==a.CONST.__USFB_M_MOBILE.device&&61E6==c)return a.ERROR.Code=11003,a.ERROR.Message=__lang.IDS_MSGBOX_NOT_INSTALL_MOBILE,document.getElementById("us-cls-btn").click(),"firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"),a.certsList=null,d(c),!1;-1!==nCertsCnt&&(a.nimservice().GetLastErrorCode(),a.nimservice().GetLastErrorMessage());d(c);a.certsList=null;a.uiUtil().loadingBox(!1,"us-div-cert-list-load")}}):a.Whale().getCerts(__device,__drive,function(b,c,e){0==b?a.certsList={list:e}:a.uiUtil().errMsgBox(c,b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)})},f=function(b,c){a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[6]);if(a.uiUtil().isItPFDevice(a.SELECTINFO.curdevice))if(a.SELECTINFO.curdevice==a.CONST.__PF_M_LS.device||a.SELECTINFO.curdevice==a.CONST.__PF_M_SS.device||a.SELECTINFO.curdevice==a.CONST.__PF_M_CLOUD.device){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[6]);try{a.usWebToolkit.pki.certificateFromBase64(a.PFUC[b].signcert);var f=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[b].signpri),g=a.usWebToolkit.pkcs8.decryptPrivateKeyInfo(f,c),h=a.usWebToolkit.pkcs8.getPrivateKeyAttributesRandom(g);e.RValue=a.usWebToolkit.util.bytesToHex(h);e.b64RValue=a.usWebToolkit.util.encode64(h);d(e)}catch(v){e.resultCode=a.ERROR.Code=v.code,e.resultMessage=a.ERROR.Message=v.message,d(e)}}else a.SELECTINFO.curdevice==a.CONST.__PF_M_CLOUDSIGN.device&&(a.uiUtil().createLoadingBox("hide","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[6]),k());else a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.SELECTINFO.curdevice==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP?(b=a.usWebToolkit.md.algorithms.sha256.create(),b.start(),b.update(a.usWebToolkit.util.encodeUtf8("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00")),b=b.digest().toHex(),b=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+b),c={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(b){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[6]);a.uiUtil().loadingBox(!1,"us-div-list-load",1);b=JSON.parse(b);if(0!=b.returnObj.returnCode&&"E1000"!=b.returnObj.returnCode)e.resultMessage=a.ERROR.Message=b.returnObj.returnMsg,e.resultCode=a.ERROR.Code=b.returnObj.returnCode;else if("E1000"==b.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(e);else{var c=a.usWebToolkit.util.decode64(b.signResult.R[0]);e.RValue=a.usWebToolkit.util.bytesToHex(c);e.b64RValue=b.signResult.R[0]}d(e)},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]},c.msg[0]=b,jSmartCertNP.SignByJSON(c).Open()):a.nimservice().GetRValueFromKey(b,c,function(b,c,f){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[6]);0!=b?(a.ERROR.Code=b,a.ERROR.Message=c,d(n(a.ERROR.Code,c))):(e.RValue=f,b=a.usWebToolkit.util.hexToBytes(f),e.b64RValue=a.usWebToolkit.util.encode64(b),d(e))}):a.Whale().getCertR(b,c,function(b,c,f){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[6]);0!=b?(e.resultCode=b,e.resultMessage=c):e.RValue=f;d(e)})},h=function(){for(var c=-1,d=0,e=0;e<a.certsList.list.length;e++)if(a.SELECTINFO.curdevice==a.CONST.__PF_M_CLOUD.device){if(a.certsList.list[e].cert&&a.certsList.list[e].cert.subject_dn){var f=a.usWebToolkit.util.decode64(a.certsList.list[e].cert.subject_dn);if(b==f)if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){c=a.certsList.list[e].index;d++;break}}else c=a.certsList.list[e].index,d++}}else if(null!=a.certsList.list[e]&&null!=a.certsList.list[e].cert&&(a.usWebToolkit.x509Certificate.parser(a.certsList.list[e].cert,"Base64"),b==a.usWebToolkit.x509Certificate.getSubjectName()))if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){c=a.certsList.list[e].index;d++;break}}else c=a.certsList.list[e].index,d++;1<d&&(c=-1);return c},k=function(){var b=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:null,possibleWhale:!0},onConfirm:function(c,g,h,k,l,m){var p=h;if("undefined"!==typeof k&&"undefined"!==typeof l)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(m))a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.SELECTINFO.curdevice==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP?(setTimeout(function(){b.dispose()},10),f(k,l)):a.nimservice()?(setTimeout(function(){b.dispose()},10),null==p&&a.CONST.__USFB_M_MOBILETOKEN.device==m?(p=a.certUtil().getTheCertAttributes(usimCert,"Base64"),D(k,l,m,usimCert,p)):D(k,l,m,g,p),e.certAttrs=p,f(k,l)):(a.ERROR.Code=e.resultCode=-1,a.ERROR.Message=e.resultMessage=a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER,D(k,l,m,g,p),d(e),setTimeout(function(){b.dispose(!0)},10)):(setTimeout(function(){b.dispose()},10),D(k,l,m,g,p),e.certAttrs=p,f(k,l));else if(m==a.CONST.__PF_M_CLOUDSIGN.device)a.uiUtil().loadingBox(!0,"us-div-list-load",1),a.PFCS().reqGetCertR(k,function(c,f,h){0!=c&&(a.uiUtil().loadingBox(!1,"us-div-list-load"),setTimeout(function(){b.dispose()},10),e.resultCode=c,e.resultMessage=f,d(n(c,f)));a.PFCS().reqGenSignNonVerifyPin(k,a.usWebToolkit.util.encodeUtf8(plainText),"Y",function(c,f,r){a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){b.dispose()},10);0!=c?(a.ERROR.Code=c,a.ERROR.Message=f,d(n(c,f))):(D(k,l,a.SELECTINFO.curdevice,g,p),e.RValue=h,e.b64RValue=a.usWebToolkit.util.encode64(a.usWebToolkit.util.hexToBytes(h)),d(e))})});else{try{g=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[k].signcert),D(k,l,m,g,p),e.certAttrs=p,f(k,l)}catch(B){e.resultCode=a.ERROR.Code=B.code,e.resultMessage=112047==B.code?a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD:a.ERROR.Message=B.message,a.uiUtil().errMsgBox(c,a.ERROR.Code),d(e)}setTimeout(function(){b.dispose()},10)}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg(e);d(e);b.dispose(!0)}});b.show()};if(a.SELECTINFO.curdevice==a.CONST.__USFB_M_MOBILETOKEN.device)k();else{if(null!=b&&""!=b)if(null==a.certsList)g(a.SELECTINFO.curdevice,0,function(b){if(0!=b)a.uiUtil().errMsgBox(a.uiUtil().getErrorMessageLang().IDS_MSGBOX_COMMON_ERROR_GET_CERT,b);else{var e=h();0>e?k():null!=c&&""!=c||null!=a.SELECTINFO.pw?null!=c&&""!=c||a.SELECTINFO.index!=e||null==a.SELECTINFO.pw?f(e,c):f(e,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();f(e,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();d(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}});else{var m=h();0>m?k():null!=c&&""!=c||null!=a.SELECTINFO.pw?null!=c&&""!=c||a.SELECTINFO.index!=m||null==a.SELECTINFO.pw?f(m,c):f(m,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();f(m,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();d(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}else k();return!0}},GetUserDN:function(b){if(!b)return!1;var c=n(),d=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:null,possibleWhale:!0},onConfirm:function(e,g,f,h,k,m){var l=f;if("undefined"!==typeof h&&"undefined"!==typeof k)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(m))m!=a.CONST.__USFB_M_DISK.device&&m!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice()?(setTimeout(function(){d.dispose()},10),a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[1]),e=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00")),a.nimservice().GetSignDataP7(h,k,e,T,!0,null,!0,!1,function(d,e,f,q,n,t){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=d?(a.ERROR.Code=c.resultCode=d,a.ERROR.Message=c.resultMessage=e):(null==l&&a.CONST.__USFB_M_MOBILETOKEN.device==m?(l=a.certUtil().getTheCertAttributes(n,"Base64"),D(h,k,m,n,l)):D(h,k,m,g,l),c.userDN=l.subjectName,c.certAttrs=l);b(c)})):(a.ERROR.Code=c.resultCode=-1,a.ERROR.Message=c.resultMessage=a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER,b(c),setTimeout(function(){d.dispose(!0)},10)):-1==h||""==k?(c.resultMessage=a.ERROR.Message=e,c.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){d.dispose(!0)},10),b(c)):(a.uiUtil().loadingBox(!0,"us-div-list-load",1),e=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00")),a.Whale().getSignDataP7(e,h,k,!0,function(e,f,q){0!=e?(c.resultCode=e,c.resultMessage=f):(D(h,k,m,g,l),c.certAttrs=l,c.userDN=l.subjectName);a.uiUtil().loadingBox(!1,"us-div-list-load",1);b(c);setTimeout(function(){d.dispose()},10)}));else if(m==a.CONST.__PF_M_CLOUDSIGN.device)a.uiUtil().loadingBox(!0,"us-div-list-load",1),a.PFCS().reqGetCertR(h,function(e,f,q){0!=e&&(c.resultCode=e,c.resultMessage=f,setTimeout(function(){d.dispose()},10),b(n(e,f)));a.PFCS().reqGenSignNonVerifyPin(h,a.usWebToolkit.util.encodeUtf8("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00"),"Y",function(e,f,p){0!=e?(a.ERROR.Code=e,a.ERROR.Message=f,b(n(e,f))):(D(h,k,m,g,l),c.userDN=l.subjectName,b(c));a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){d.dispose()},10)})});else{try{g=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[h].signcert);var t=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[h].signpri),q=a.usWebToolkit.pkcs7.createSignedData();q.sign("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00",g,t,k,null,null);a.usWebToolkit.pkcs7.messageToBase64(q);D(h,k,m,g,l);c.userDN=f.subjectName;b(c)}catch(r){c.resultCode=a.ERROR.Code=r.code,c.resultMessage=112047==r.code?a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD:a.ERROR.Message=r.message,a.uiUtil().errMsgBox(e,a.ERROR.Code),b(c)}setTimeout(function(){d.dispose()},10)}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg(c);b(c);d.dispose(!0)}});d.show();return!0},VerifyCertVID:function(b,c,d,e){if(!e)return!1;var g=n(),f=function(a){1==e.length?e(a):(null==a&&(a=n(-1)),e(a.resultCode,a.resultMessage))};a.reInitialize();a.ESVS.multiuse=!0;var h=function(b,c,d,h,k,l,m){if("PFS"==m)try{var p=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[d].signcert),r=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[d].signpri),q=a.usWebToolkit.pkcs8.verifyVID(r,h,c,p);h=c="";q?f(n(0)):f(null)}catch(G){h=c="",a.ERROR.Code=G.code,a.ERROR.Message=G.message,f(n(G.code,G.message))}else"NIM"==m?(a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_VID_VERIFY_MESSAGE),a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.SELECTINFO.curdevice==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP?(b=a.usWebToolkit.md.algorithms.sha256.create(),b.start(),b.update(a.usWebToolkit.util.encodeUtf8("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00")),b=b.digest().toHex(),b=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+b),d={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(b){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");b=JSON.parse(b);if(0!=b.returnObj.returnCode&&"E1000"!=b.returnObj.returnCode)g.resultMessage=a.ERROR.Message=b.returnObj.returnMsg,g.resultCode=a.ERROR.Code=b.returnObj.returnCode,f(g);else if("E1000"==b.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(g),f(g);else{var d=b.signResult.b64Signer;b=a.usWebToolkit.util.decode64(b.signResult.R[0]);d=a.usWebToolkit.pki.certificateFromBase64(d);a.usWebToolkit.pkcs8.verifyVIDForHSM(b,c,d)?f(n(0)):(a.ERROR.Code=14208,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID,e(n(14208,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)))}},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]},d.msg[0]=b,jSmartCertNP.SignByJSON(d).Open()):a.nimservice().VerifyVID(d,h,b,c,function(b,d){4305E4==b&&(b=14208);a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?f(n(0)):(a.ERROR.Code=b,a.ERROR.Message=d,f(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)));h=c=""}):a.Whale().verifyVID(d,h,c,function(b,c){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?f(n(0)):(3061==b&&(b=14208),a.ERROR.Code=b,a.ERROR.Message=c,e(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)))})):"CLOUDSIGN"==m&&a.PFCS().reqVerifyVID(d,c,function(b,c,d){0!=b?(a.ERROR.Code=b,a.ERROR.Message=c,f(n(b,c))):d?f(g):(a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_MSGBOX_VID_ERROR_VERIFICATION,f(n(-1,a.ERROR.Message)))})},k=function(b){var c=a.loadUI("certselect")({type:"VID_VERIFICATION",args:{dn:null,possibleWhale:!0},onConfirm:function(d,e,k,p,l,r,m,q){D(d,e,q,r,m);Q(d,q,function(r){setTimeout(function(){c.dispose()},10);if(0!=r.rv)a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"),a.ERROR.Code=g.resultCode=r.rv,a.ERROR.Message=g.resultMessage=r.rvMsg,f(g);else if(b)h(0,b,d,e,k,p,l);else{var m=a.loadUI("ssn")({type:null,onConfirm:function(a){h(1,a,d,e,k,p,l);m.dispose()},onCancel:function(){m.dispose();a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}});m.show()}})},onCancel:function(){c.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}});c.show()},m=function(b,c,d){b!=a.CONST.__USFB_M_DISK.device&&b!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice().GetAllUserCertListNum(b,c,"",function(c,e,f){nCertsCnt=f;if(0==c)0<nCertsCnt?a.nimservice().GetAllUserCert(f,function(b,c){0==b?a.certsList={list:c}:a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)}):(a.certsList=null,a.uiUtil().loadingBox(!1,"us-div-cert-list-load"),d(0));else{if(b==a.CONST.__USFB_M_MOBILE.device&&61E6==c)return a.ERROR.Code=11003,a.ERROR.Message=__lang.IDS_MSGBOX_NOT_INSTALL_MOBILE,document.getElementById("us-cls-btn").click(),"firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"),a.certsList=null,d(c),!1;-1!==nCertsCnt&&(a.nimservice().GetLastErrorCode(),a.nimservice().GetLastErrorMessage());d(c);a.certsList=null;a.uiUtil().loadingBox(!1,"us-div-cert-list-load")}}):a.Whale().getCerts(__device,__drive,function(b,c,e){0==b?a.certsList={list:e}:a.uiUtil().errMsgBox(c,b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)})},l=function(b,c,h){if(d)a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_VID_VERIFY_MESSAGE),a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice().VerifyVID(b,c,0,d,function(b,d){4305E4==b&&(b=14208);a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?f(n(0)):(a.ERROR.Code=b,a.ERROR.Message=d,f(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)));c=h=""}):a.Whale().verifyVID(b,c,h,function(b,d){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?f(n(0)):(3061==b&&(b=14208),a.ERROR.Code=b,a.ERROR.Message=d,e(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)));c=h=""});else{var k=a.loadUI("ssn")({type:null,onConfirm:function(d){k.dispose();a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_VID_VERIFY_MESSAGE);if(a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(a.SELECTINFO.curdevice==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){var h=a.usWebToolkit.md.algorithms.sha256.create();h.start();h.update(a.usWebToolkit.util.encodeUtf8("abcdefghijklmnopqrstuvwxyz1234567890~!@#$%^&amp;*()\ud55c\uae00"));h=h.digest().toHex();h=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+h);var p={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(b){b=JSON.parse(b);if(0!=b.returnObj.returnCode&&"E1000"!=b.returnObj.returnCode)g.resultMessage=a.ERROR.Message=b.returnObj.returnMsg,g.resultCode=a.ERROR.Code=b.returnObj.returnCode,f(g);else if("E1000"==b.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(g),f(g);else{var c=b.signResult.b64Signer;b=a.usWebToolkit.util.decode64(b.signResult.R[0]);c=a.usWebToolkit.pki.certificateFromBase64(c);a.usWebToolkit.pkcs8.verifyVIDForHSM(b,d,c)?f(n(0)):(a.ERROR.Code=14208,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID,e(n(14208,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)))}},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]};p.msg[0]=h;jSmartCertNP.SignByJSON(p).Open()}else a.nimservice().VerifyVID(b,c,1,d,function(b,e){4305E4==b&&(b=14208);a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?f(n(0)):(a.ERROR.Code=b,a.ERROR.Message=e,f(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)));c=d=""});else a.Whale().verifyVID(b,c,d,function(b,g){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0==b?f(n(0)):(3061==b&&(b=14208),a.ERROR.Code=b,a.ERROR.Message=g,e(n(b,a.uiUtil().getErrorMessageLang().IDS_ERROR_VERIFY_ID)));c=d=""})},onCancel:function(){k.dispose();a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}});k.show()}},t=function(b){for(var c=-1,d=0,e=0;e<a.certsList.list.length;e++)if(a.SELECTINFO.curdevice==a.CONST.__PF_M_CLOUD.device){if(a.certsList.list[e].cert&&a.certsList.list[e].cert.subject_dn){var f=a.usWebToolkit.util.decode64(a.certsList.list[e].cert.subject_dn);if(b==f)if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){c=a.certsList.list[e].index;d++;break}}else c=a.certsList.list[e].index,d++}}else if(null!=a.certsList.list[e]&&null!=a.certsList.list[e].cert&&(a.usWebToolkit.x509Certificate.parser(a.certsList.list[e].cert,"Base64"),b==a.usWebToolkit.x509Certificate.getSubjectName()))if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){c=a.certsList.list[e].index;d++;break}}else c=a.certsList.list[e].index,d++;1<d&&(c=-1);return c};if(""==b||null==b)k(d);else if(null==a.certsList)m(a.SELECTINFO.curdevice,0,function(e){if(0!=e)a.uiUtil().errMsgBox(a.uiUtil().getErrorMessageLang().IDS_MSGBOX_COMMON_ERROR_GET_CERT,e);else{var g=t(b);0>g?k(d):null!=c&&""!=c||a.SELECTINFO.index==g?null!=c&&""!=c||a.SELECTINFO.index!=g||null==a.SELECTINFO.pw?l(g,c,d):l(g,a.SELECTINFO.pw,d):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();l(g,a,d)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}});else{var q=t(b);0>q?k(d):null!=c&&""!=c||a.SELECTINFO.index==q?null!=c&&""!=c||a.SELECTINFO.index!=q||null==a.SELECTINFO.pw?l(q,c,d):l(q,a.SELECTINFO.pw,d):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();l(q,a,d)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}return!0},SignDataP7NonEnveloped:function(b,c,d,e,g){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||!g)return!1;var f=n(),h=function(a){1==g.length?g(a):(null==a&&(a=n(-1)),g(a.signedData,a.curDevice,a.certAttrs))};a.reInitialize();var k=function(){var c=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:null,possibleWhale:!0},onConfirm:function(d,g,k,l,m,q,r){var p=k;if("undefined"!==typeof l&&"undefined"!==typeof m)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(q))q!=a.CONST.__USFB_M_DISK.device&&q!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice()?Q(l,q,function(d){0!=d.rv?(a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"),a.ERROR.Code=f.resultCode=d.rv,a.ERROR.Message=f.resultMessage=d.rvMsg,setTimeout(function(){c.dispose()},10),h(f)):(d=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().GetSignDataP7(l,m,d,T,e,"",1,!1,function(b,d,e,k,n,t){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=b?(a.ERROR.Code=f.resultCode=b,a.ERROR.Message=f.resultMessage=d):(null==p&&a.CONST.__USFB_M_MOBILETOKEN.device==q?(p=a.certUtil().getTheCertAttributes(n,"Base64"),D(l,m,q,n,p)):D(l,m,q,g,p),f.certAttrs=p,f.signedData=e,f.curDevice=q,f.tokenLabel=t,null!=r&&q==a.CONST.__USFB_M_HSMKEY.device&&(f.tokenName=r.name,f.tokenDriver=r.driver));setTimeout(function(){c.dispose()},10);h(f);l=m=g=v=null}))}):(a.ERROR.Code=f.resultCode=-1,a.ERROR.Message=f.resultMessage=a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER,h(f),setTimeout(function(){c.dispose(!0)},10)):-1==l||""==m?(f.resultMessage=a.ERROR.Message=d,f.resultCode=a.ERROR.Code=43021E3,setTimeout(function(){c.dispose(!0)},10),h(f)):(a.uiUtil().loadingBox(!0,"us-div-list-load",1),d=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.Whale().getSignDataP7(d,l,m,e,function(b,d,e){0!=b?(f.resultCode=b,f.resultMessage=d):(D(l,m,q,g,p),f.certAttrs=p,f.signedData=e,f.curDevice=q,f.tokenLabel="");a.uiUtil().loadingBox(!1,"us-div-list-load",1);h(f);setTimeout(function(){c.dispose()},10)}));else if(q==a.CONST.__PF_M_CLOUDSIGN.device)a.uiUtil().loadingBox(!0,"us-div-list-load",1),a.PFCS().reqGenSign(l,m,function(b,d,e,g){0!=b?(a.ERROR.Code=b,a.ERROR.Message=d,h(n(b,d))):(f.signedData=e,f.curDevice=q,h(f));a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){c.dispose()},10)});else{try{g=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[l].signcert);var v=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[l].signpri),t=a.usWebToolkit.pkcs7.createSignedData();D(l,m,q,g,p);t.sign(b,g,v,m,null,null);var w=a.usWebToolkit.pkcs7.messageToBase64(t);f.certAttrs=k;f.signedData=w;f.curDevice=q;h(f)}catch(S){f.resultCode=a.ERROR.Code=S.code,f.resultMessage=112047==S.code?a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD:a.ERROR.Message=S.message,a.uiUtil().errMsgBox(a.ERROR.Message,a.ERROR.Code),h(f)}setTimeout(function(){c.dispose()},10);l=m=g=v=null}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg(f);setTimeout(function(){c.dispose()},10);h(f)}});c.show()};if(""==c||null==c)k();else{var m=function(b,c,d){b!=a.CONST.__USFB_M_DISK.device&&b!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice().GetAllUserCertListNum(b,c,"",function(c,e,f){nCertsCnt=f;if(0==c)0<nCertsCnt?a.nimservice().GetAllUserCert(f,function(b,c){0==b?a.certsList={list:c}:a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)}):(a.certsList=null,a.uiUtil().loadingBox(!1,"us-div-cert-list-load"),d(0));else{if(b==a.CONST.__USFB_M_MOBILE.device&&61E6==c)return a.ERROR.Code=11003,a.ERROR.Message=__lang.IDS_MSGBOX_NOT_INSTALL_MOBILE,document.getElementById("us-cls-btn").click(),"firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"),a.certsList=null,d(c),!1;-1!==nCertsCnt&&(a.nimservice().GetLastErrorCode(),a.nimservice().GetLastErrorMessage());d(c);a.certsList=null;a.uiUtil().loadingBox(!1,"us-div-cert-list-load")}}):a.Whale().getCerts(__device,__drive,function(b,c,e){0==b?a.certsList={list:e}:a.uiUtil().errMsgBox(c,b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)})},l=function(c,d){if("undefined"!==typeof c&&"undefined"!==typeof d)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(a.SELECTINFO.curdevice))if(a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale())a.nimservice()?(a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CERT_LOADING_MSG[1]),g=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().GetSignDataP7(c,d,g,T,e,"",1,!1,function(b,e,g,p,m,q){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=b?(a.ERROR.Code=f.resultCode=b,a.ERROR.Message=f.resultMessage=e):(b=a.SELECTINFO.certattrs,null==b&&a.CONST.__USFB_M_MOBILETOKEN.device==a.SELECTINFO.curdevice?(b=a.certUtil().getTheCertAttributes(m,"Base64"),D(c,d,a.SELECTINFO.curdevice,m,b)):D(c,d,a.SELECTINFO.curdevice,k,b),f.certAttrs=b,f.signedData=g,f.curDevice=a.SELECTINFO.curdevice,f.tokenLabel=q);h(f);c=d=k=l=null})):(a.ERROR.Code=f.resultCode=-1,a.ERROR.Message=f.resultMessage=a.uiUtil().getErrorMessageLang().IDS_ERROR_LOADING_NIMSERVIER,h(f));else{a.uiUtil().loadingBox(!0,"us-div-list-load",1);var g=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b));a.Whale().getSignDataP7(g,c,d,e,function(b,c,d){0!=b?(f.resultCode=b,f.resultMessage=c):(f.certAttrs=a.SELECTINFO.certattrs,f.signedData=d,f.curDevice=a.SELECTINFO.curdevice,f.tokenLabel="");a.uiUtil().loadingBox(!1,"us-div-list-load",1);h(f)})}else if(a.SELECTINFO.curdevice==a.CONST.__PF_M_CLOUDSIGN.device)a.uiUtil().loadingBox(!0,"us-div-list-load",1),a.PFCS().reqGenSign(c,d,function(b,e,g,p){0!=b?(a.ERROR.Code=b,a.ERROR.Message=e,h(n(b,e))):(f.signedData=g,f.curDevice=a.SELECTINFO.curdevice,h(f));a.uiUtil().loadingBox(!1,"us-div-list-load");c=d=k=l=null});else{try{var k=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[c].signcert),l=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[c].signpri);g=a.usWebToolkit.pkcs7.createSignedData();a.certUtil().getTheCertAttributes(a.PFUC[c].signcert,"Base64");g.sign(b,k,l,d,null,null);var p=a.usWebToolkit.pkcs7.messageToBase64(g);D(c,d,a.SELECTINFO.curdevice,k,a.SELECTINFO.certattrs);f.certAttrs=a.SELECTINFO.certattrs;f.signedData=p;f.curDevice=a.SELECTINFO.curdevice;h(f)}catch(A){f.resultCode=a.ERROR.Code=A.code,f.resultMessage=112047==A.code?a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD:a.ERROR.Message=A.message,a.uiUtil().errMsgBox(a.ERROR.Message,a.ERROR.Code),h(f)}c=d=k=l=null}},t=function(){for(var b=-1,d=0,e=0;e<a.certsList.list.length;e++)if(a.SELECTINFO.curdevice==a.CONST.__PF_M_CLOUD.device){if(a.certsList.list[e].cert&&a.certsList.list[e].cert.subject_dn){var f=a.usWebToolkit.util.decode64(a.certsList.list[e].cert.subject_dn);if(c==f)if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){b=a.certsList.list[e].index;d++;break}}else b=a.certsList.list[e].index,d++}}else if(null!=a.certsList.list[e]&&null!=a.certsList.list[e].cert&&(a.usWebToolkit.x509Certificate.parser(a.certsList.list[e].cert,"Base64"),c==a.usWebToolkit.x509Certificate.getSubjectName()))if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){b=a.certsList.list[e].index;d++;break}}else b=a.certsList.list[e].index,d++;1<d&&(b=-1);return b};if(null==a.certsList)m(a.SELECTINFO.curdevice,0,function(b){if(0!=b)a.uiUtil().errMsgBox(a.uiUtil().getErrorMessageLang().IDS_MSGBOX_COMMON_ERROR_GET_CERT,b);else{var c=t();0>c?k():null!=d&&""!=d||null!=a.SELECTINFO.pw?null!=d&&""!=d||a.SELECTINFO.index!=c||null==a.SELECTINFO.pw?l(c,d):l(c,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();l(c,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();h(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}});else{var q=t();0>q?k():null!=d&&""!=d||null!=a.SELECTINFO.pw?null!=d&&""!=d||a.SELECTINFO.index!=q||null==a.SELECTINFO.pw?l(q,d):l(q,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();l(q,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();h(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}}return!0}},SignDataP1WithPwd:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||!e)return!1;var g=n(),f=function(a){1==e.length?e(a):(null==a&&(a=n()),e(a.signedData,a.theCert,a.theDN))};a.reInitialize();var h=function(){var d=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P1",args:{dn:c,possibleWhale:!0},onConfirm:function(c,e,h,k,l,m){if("undefined"!==typeof k&&"undefined"!==typeof l){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(m))if(m!=a.CONST.__USFB_M_DISK.device&&m!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(m==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){var p=a.usWebToolkit.md.algorithms.sha256.create();p.start();p.update(a.usWebToolkit.util.encodeUtf8(b));h=p.digest().toHex();h=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+h);p={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(b){b=JSON.parse(b);a.uiUtil().loadingBox(!1,"us-div-list-load",1);if(0!=b.returnObj.returnCode&&"E1000"!=b.returnObj.returnCode)g.resultMessage=a.ERROR.Message=b.returnObj.returnMsg,g.resultCode=a.ERROR.Code=b.returnObj.returnCode,setTimeout(function(){d.dispose(!0)},10),f(g);else if("E1000"==b.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(g),setTimeout(function(){d.dispose(!0)},10),f(g);else{var c=b.signResult.b64Signer;_certAttrs=a.certUtil().getTheCertAttributes(c,"Base64");D(k,l,m,c,_certAttrs);g.certAttrs=_certAttrs;g.signedData=b.signResult.b64SignedData[0];g.theCert=b.signResult.b64Signer;g.theDN=_certAttrs.subjectName;g.tokenlabel="";f(g);setTimeout(function(){d.dispose()},10)}},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]};p.msg[0]=h;p.plainText=[];p.plainText[0]=a.usWebToolkit.util.encodeUtf8(b);jSmartCertNP.SignByJSON(p).Open()}else a.nimservice()?Q(k,m,function(h){0!=h.rv?(a.uiUtil().loadingBox(!1,"us-div-list-load"),a.ERROR.Code=g.resultCode=h.rv,a.ERROR.Message=g.resultMessage=h.rvMsg,setTimeout(function(){d.dispose()},10),f(g)):(h=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().GetSignDataP1(k,l,h,null,!0,function(b,h,p,q,n,r){0!=b?(a.ERROR.Code=g.resultCode=b,a.ERROR.Message=g.resultMessage=h,a.uiUtil().errMsgBox(h,b)):(null==c&&a.CONST.__USFB_M_MOBILETOKEN.device==m&&(_certAttrs=a.certUtil().getTheCertAttributes(n,"Base64"),c=n,e=_certAttrs.subjectName),D(k,l,m,c,a.certUtil().getTheCertAttributes(c,"Base64")),g.theCert=c,g.theDN=e,g.signedData=p,g.tokenlabel=r);f(g);a.uiUtil().loadingBox(!1,"us-div-list-load");setTimeout(function(){d.dispose()},10)}))}):(a.ERROR.Code=g.resultCode=-1,a.ERROR.Message=g.resultMessage=a.uiUtil().getErrorMessageLang().IDS_MSGBOX_NIM_ERROR_UNLOAD,f(g),setTimeout(function(){d.dispose(!0)},10));else-1==k||""==l?(g.resultMessage=a.ERROR.Message=h,g.resultCode=a.ERROR.Code=43021E3,a.uiUtil().loadingBox(!1,"us-div-list-load",1),setTimeout(function(){d.dispose(!0)},10),f(g)):(h=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.Whale().getSignDataP1(h,k,l,function(b,h,p){0!=b?(g.resultCode=b,g.resultMessage=h):(D(k,l,m,c,a.certUtil().getTheCertAttributes(c,"Base64")),g.theCert=c,g.theDN=e,g.signedData=p,g.tokenlabel="");setTimeout(function(){d.dispose()},10);a.uiUtil().loadingBox(!1,"us-div-list-load",1);f(g)}));else{try{var q=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[k].signcert),n=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[k].signpri);n=crosscert.pki.privateKeyFromAsn1(crosscert.asn1.fromDer(n));p=null;switch(oids[q.signatureOid]){case "sha1WithRSAEncryption":p=crosscert.md.algorithms[sha1].create();break;case "kcdsaWithSHA1":q.md=crosscert.md.algorithms[sha1].create();break;case "md5WithRSAEncryption":p=crosscert.md.algorithms[md5].create();break;case "sha256WithRSAEncryption":p=crosscert.md.algorithms[sha256].create();break;case "RSASSA-PSS":p=crosscert.md.algorithms[sha256].create()}p.update(b);var r=n.sign(p);a.usWebToolkit.pkcs7.messageToBase64(r);g.theCert=c;g.theDN=e;g.signedData=signedData;f(g)}catch(G){a.ERROR.Code=g.resultCode=G.code,a.ERROR.Message=g.resultMessage=G.message,a.uiUtil().errMsgBox(h,a.ERROR.Code),f(g)}setTimeout(function(){d.dispose()},10)}k=l=q=pri=null}else g.resultMessage=a.ERROR.Message=h,g.resultCode=a.ERROR.Code=43021E3,a.uiUtil().loadingBox(!1,"us-div-list-load",1),setTimeout(function(){d.dispose(!0)},10),f(g)},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg(g);f(g);d.dispose(!0)}});d.show()};if(""==c||null==c)h();else{var k=function(b,c,d){b!=a.CONST.__USFB_M_DISK.device&&b!=a.CONST.__USFB_M_HDD.device||null==a.Whale()?a.nimservice().GetAllUserCertListNum(b,c,"",function(c,e,f){nCertsCnt=f;if(0==c)0<nCertsCnt?a.nimservice().GetAllUserCert(f,function(b,c){0==b?a.certsList={list:c}:a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)}):(a.certsList=null,a.uiUtil().loadingBox(!1,"us-div-cert-list-load"),d(0));else{if(b==a.CONST.__USFB_M_MOBILE.device&&61E6==c)return a.ERROR.Code=11003,a.ERROR.Message=__lang.IDS_MSGBOX_NOT_INSTALL_MOBILE,document.getElementById("us-cls-btn").click(),"firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"),a.certsList=null,d(c),!1;-1!==nCertsCnt&&(a.nimservice().GetLastErrorCode(),a.nimservice().GetLastErrorMessage());d(c);a.certsList=null;a.uiUtil().loadingBox(!1,"us-div-cert-list-load")}}):a.Whale().getCerts(__device,__drive,function(b,c,e){0==b?a.certsList={list:e}:a.uiUtil().errMsgBox(c,b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)})},m=function(d,e){var h=d,k=e;if("undefined"!==typeof h&&"undefined"!==typeof e){if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(a.SELECTINFO.curdevice))if(a.SELECTINFO.curdevice!=a.CONST.__USFB_M_DISK.device&&a.SELECTINFO.curdevice!=a.CONST.__USFB_M_HDD.device||null==a.Whale())if(a.SELECTINFO.curdevice==a.CONST.__USFB_M_MOBILETOKEN.device&&"undefined"!=typeof jSmartCertNP){var l=a.usWebToolkit.md.algorithms.sha256.create();l.start();l.update(a.usWebToolkit.util.encodeUtf8(b));l=l.digest().toHex();l=a.usWebToolkit.util.encode64("3031300d060960864801650304020105000420"+l);var m={msgType:"originHash",signedDataType:"signature",siteDomain:document.domain,complete:function(b){b=JSON.parse(b);a.uiUtil().loadingBox(!1,"us-div-list-load",1);if(0!=b.returnObj.returnCode&&"E1000"!=b.returnObj.returnCode)g.resultMessage=a.ERROR.Message=b.returnObj.returnMsg,g.resultCode=a.ERROR.Code=b.returnObj.returnCode,setTimeout(function(){Dialog.dispose(!0)},10),f(g);else if("E1000"==b.returnObj.returnCode)a.uiUtil().getUserCancelErrCodeNMsg(g),setTimeout(function(){Dialog.dispose(!0)},10),f(g);else{var c=b.signResult.b64Signer;_certAttrs=a.certUtil().getTheCertAttributes(c,"Base64");D(d,e,device,c,_certAttrs);g.certAttrs=_certAttrs;g.signedData=b.signResult.b64SignedData[0];g.theCert=b.signResult.b64Signer;g.theDN=_certAttrs.subjectName;g.tokenlabel="";f(g);setTimeout(function(){Dialog.dispose()},10)}},multisignYn:"N",oid:null==a.ESVS.Policy?"":a.ESVS.Policy,validate:u.ShowExpiredCerts?!1:!0,randomChk:!0,msg:[]};m.msg[0]=l;m.plainText=[];m.plainText[0]=a.usWebToolkit.util.encodeUtf8(b);jSmartCertNP.SignByJSON(m).Open()}else a.nimservice()?(l=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.nimservice().GetSignDataP1(h,e,l,null,!0,function(b,d,e,l,m,p){if(0!=b)a.ERROR.Code=g.resultCode=b,a.ERROR.Message=g.resultMessage=d,a.uiUtil().errMsgBox(d,b);else{b=c;d="";for(l=0;l<a.certsList.list.length&&(null==a.certsList.list[l]||null==a.certsList.list[l].cert||(d=a.certsList.list[l].cert,h!=a.certsList.list[l].index));l++);a.CONST.__USFB_M_MOBILETOKEN.device==a.SELECTINFO.curdevice&&(d=m,b=a.SELECTINFO.certattrs.subjectName);D(h,k,a.SELECTINFO.curdevice,d,a.certUtil().getTheCertAttributes(d,"Base64"));g.theCert=d;g.theDN=b;g.signedData=e;g.tokenlabel=p}f(g);a.uiUtil().loadingBox(!1,"us-div-list-load")})):(a.ERROR.Code=g.resultCode=-1,a.ERROR.Message=g.resultMessage=a.uiUtil().getErrorMessageLang().IDS_MSGBOX_NIM_ERROR_UNLOAD,f(g));else l=a.usWebToolkit.util.encode64(a.usWebToolkit.util.encodeUtf8(b)),a.Whale().getSignDataP1(l,d,e,function(b,d,e){if(0!=b)g.resultCode=b,g.resultMessage=d;else{b="";for(d=0;d<a.certsList.list.length&&(null==a.certsList.list[d]||null==a.certsList.list[d].cert||(b=a.certsList.list[d].cert,h!=a.certsList.list[d].index));d++);g.theCert=b;g.theDN=c;g.signedData=e;g.tokenlabel=""}a.uiUtil().loadingBox(!1,"us-div-list-load",1);f(g)});else try{m=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[d].signcert);var n=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[d].signpri);n=crosscert.pki.privateKeyFromAsn1(crosscert.asn1.fromDer(n));l=null;switch(oids[m.signatureOid]){case "sha1WithRSAEncryption":l=crosscert.md.algorithms[sha1].create();break;case "kcdsaWithSHA1":m.md=crosscert.md.algorithms[sha1].create();break;case "md5WithRSAEncryption":l=crosscert.md.algorithms[md5].create();break;case "sha256WithRSAEncryption":l=crosscert.md.algorithms[sha256].create();break;case "RSASSA-PSS":l=crosscert.md.algorithms[sha256].create()}l.update(b);var q=n.sign(l);singedData=a.usWebToolkit.pkcs7.messageToBase64(q);g.theCert=theCert;g.theDN=theDN;g.signedData=signedData;f(g)}catch(E){a.ERROR.Code=g.resultCode=E.code,a.ERROR.Message=g.resultMessage=E.message,a.uiUtil().errMsgBox(userMsg,a.ERROR.Code),f(g)}d=e=m=pri=null}},l=function(){for(var b=-1,d=0,e=0;e<a.certsList.list.length;e++)if(null!=a.certsList.list[e]&&null!=a.certsList.list[e].cert&&(a.usWebToolkit.x509Certificate.parser(a.certsList.list[e].cert,"Base64"),c==a.usWebToolkit.x509Certificate.getSubjectName()))if(0!=a.SELECTINFO.index){if(a.SELECTINFO.index==a.certsList.list[e].index){b=a.certsList.list[e].index;d++;break}}else b=a.certsList.list[e].index,d++;1<d&&(b=-1);return b};if(null==a.certsList)k(a.SELECTINFO.curdevice,0,function(b){if(0!=b)a.uiUtil().errMsgBox(a.uiUtil().getErrorMessageLang().IDS_MSGBOX_COMMON_ERROR_GET_CERT,b);else{var c=l();0>c?h():null!=d&&""!=d||null!=a.SELECTINFO.pw?null!=d&&""!=d||a.SELECTINFO.index!=c||null==a.SELECTINFO.pw?m(c,d):m(c,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();m(c,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}});else{var t=l();0>t?h():null!=d&&""!=d||null!=a.SELECTINFO.pw?null!=d&&""!=d||a.SELECTINFO.index!=t||null==a.SELECTINFO.pw?m(t,d):m(t,a.SELECTINFO.pw):(PWDialog=a.loadUI("password")({type:null,args:{},onConfirm:function(a){PWDialog.dispose();m(t,a)},onCancel:function(){PWDialog.dispose();a.uiUtil().getUserCancelErrCodeNMsg();f(n(a.ERROR.Code,a.ERROR.Message))}}),PWDialog.show())}}return!0}},getCertPEMType:function(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!c)return!1;var d=n(),e=function(a){1==c.length?c(a):(null==a&&(a=n()),c(a.signedData,a.theCert,a.theDN))};if(""==b)return e(d),!0;var g=function(b,c,d){a.nimservice().GetAllUserCertListNum(b,c,"",function(c,e,f){nCertsCnt=f;if(0==c)0<nCertsCnt?a.nimservice().GetAllUserCert(f,function(b,c){0==b?a.certsList={list:c}:a.uiUtil().errMsgBox(a.nimservice().GetLastErrorMessage(),b);a.uiUtil().loadingBox(!1,"us-div-cert-list-load");d(b)}):(a.certsList=null,a.uiUtil().loadingBox(!1,"us-div-cert-list-load"),d(0));else{if(b==a.CONST.__USFB_M_MOBILE.device&&61E6==c)return a.ERROR.Code=11003,a.ERROR.Message=__lang.IDS_MSGBOX_NOT_INSTALL_MOBILE,document.getElementById("us-cls-btn").click(),"firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"),a.certsList=null,d(c),!1;-1!==nCertsCnt&&(a.nimservice().GetLastErrorCode(),a.nimservice().GetLastErrorMessage());d(c);a.certsList=null;a.uiUtil().loadingBox(!1,"us-div-cert-list-load")}})},f=function(){for(var c="",d=0;d<a.certsList.list.length;d++)if(null!=a.certsList.list[d]&&null!=a.certsList.list[d].cert&&(a.usWebToolkit.x509Certificate.parser(a.certsList.list[d].cert,"Base64"),b==a.usWebToolkit.x509Certificate.getSubjectName())){c=a.certsList.list[d].cert;break}return c};null==a.certsList?g(a.SELECTINFO.curdevice,0,function(b){0!=b?a.uiUtil().errMsgBox(a.uiUtil().getErrorMessageLang().IDS_MSGBOX_COMMON_ERROR_GET_CERT,b):(b=f(),""!=b&&(d.PEMCert=a.usWebToolkit.pki.certificateToPem(a.usWebToolkit.pki.certificateFromBase64(b))),e(d))}):(g=f(),""!=g&&(d.PEMCert=a.usWebToolkit.pki.certificateToPem(a.usWebToolkit.pki.certificateFromBase64(g))),e(d));return!0}},GetCertPath:function(b){if(!b)return!1;var c=n();if(1>a.SELECTINFO.index)return c.certPath="",b(c),!0;4&a.ESVS.Mode?a.nimservice().GetCertPath(a.SELECTINFO.index,function(d,e,g){0!=d?(a.ERROR.Code=d,a.ERROR.Message=e,b(n(d,e))):(c.certPath=g,b(c))}):(a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_BROWSER_NOT_SUPPORT,b(n(a.ERROR.Code,a.ERROR.Message)));return!0},EnvelopedData:function(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!c||document.getElementById("us-div-cert-select"))return!1;var d=n(),e=function(a){1==c.length?c(a):(null==a&&(a=n(-1)),c(a.signedData,a.curDevice,a.certAttrs,a.b64RValue))};a.reInitialize();var g=a.loadUI("certselect")({type:"CERT_SELECT",args:{dn:null},onConfirm:function(c,h,k,m,l,t,q){if("undefined"!==typeof m&&"undefined"!==typeof l)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(t))a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_DEVICE,setTimeout(function(){g.dispose()},10);else if(t==a.CONST.__PF_M_CLOUDSIGN.device)a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_DEVICE,setTimeout(function(){g.dispose()},10);else{try{try{h=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[m].signcert);var f=a.usWebToolkit.pkcs7.createEnvelopedData();f.addRecipient(h);f.encContent.algorithm=a.usWebToolkit.pki.oids["seed-CBC"];f.content=a.usWebToolkit.util.createBuffer(a.usWebToolkit.util.encodeUtf8(b));f.encrypt();d.encryptData=a.usWebToolkit.pkcs7.messageToBase64(f);e(d)}catch(p){a.ERROR.Code=p.code,a.ERROR.Message=p.message,e(n(a.ERROR.Code,a.ERROR.Message))}}catch(p){a.ERROR.Code=p.code,a.ERROR.Message=p.message,112047==p.code&&(a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD),a.uiUtil().errMsgBox(a.ERROR.Message,a.ERROR.Code),e(n(p.code,p.message))}setTimeout(function(){g.dispose()},10);m=l=h=pri=null}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message));g.dispose()}});g.show();return!0}},DeEnvelopedData:function(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!c||document.getElementById("us-div-cert-select"))return!1;var d=n(),e=function(a){1==c.length?c(a):(null==a&&(a=n(-1)),c(a.decryptData,a.curDevice,a.certAttrs,a.b64RValue))};a.reInitialize();var g=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:null},onConfirm:function(c,h,k,m,l,t,q){d.certAttrs=k;if("undefined"!==typeof m&&"undefined"!==typeof l)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(t))a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_DEVICE,setTimeout(function(){g.dispose()},10);else if(t==a.CONST.__PF_M_CLOUDSIGN.device)a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_DEVICE,setTimeout(function(){g.dispose()},10);else{try{try{var f=a.usWebToolkit.pkcs8.decryptRsaPrivateKeyFromBase64(a.PFUC[m].signpri,l),p=crosscert.pkcs7.messageFromBase64(b);p.decrypt(p.recipients[0],f);d.decryptData=a.usWebToolkit.util.decodeUtf8(p.content.data);e(d)}catch(v){a.ERROR.Code=v.code,a.ERROR.Message=v.message,e(n(a.ERROR.Code,a.ERROR.Message))}}catch(v){a.ERROR.Code=v.code,a.ERROR.Message=v.message,112047==v.code&&(a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD),a.uiUtil().errMsgBox(a.ERROR.Message,a.ERROR.Code),e(n(v.code,v.message))}setTimeout(function(){g.dispose()},10);m=l=pri=null}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message));g.dispose()}});g.show();return!0}},MakeSymmetricKey:function(b){var c={};switch(b.toLowerCase()){case "3des":b=24;var d=8;break;case "des":d=b=8;break;default:d=b=16}try{c.resultCode=0,c.symmKey=a.usWebToolkit.util.bytesToHex(a.usWebToolkit.random.getBytes(b)),c.symmIV=a.usWebToolkit.util.bytesToHex(a.usWebToolkit.random.getBytes(d))}catch(e){c.resultCode=e.code,c.errMsg=e.message}return c},SymmetricKeyEncrypt:function(b,c,d,e){var g={};c=c.toLowerCase();switch(c){case "3des":c="des";case "aes":case "seed":case "des":break;default:c="seed"}try{var f=a.usWebToolkit.cipher.algorithms[c].startEncrypting(a.usWebToolkit.util.hexToBytes(d),a.usWebToolkit.util.hexToBytes(e));f.update(a.usWebToolkit.util.createBuffer(a.usWebToolkit.util.encodeUtf8(b)));f.finish();g.resultCode=0;g.encryptData=a.usWebToolkit.util.encode64(f.output.getBytes())}catch(h){g.resultCode=h.code,g.errMsg=h.message}return g},SymmetricKeyDecrypt:function(b,c,d,e){var g={};c=c.toLowerCase();switch(c){case "3des":c="des";case "aes":case "seed":case "des":break;default:c="seed"}try{var f=a.usWebToolkit.cipher.algorithms[c].startDecrypting(a.usWebToolkit.util.hexToBytes(d),a.usWebToolkit.util.hexToBytes(e));f.update(a.usWebToolkit.util.createBuffer(a.usWebToolkit.util.decode64(b)));f.finish();g.resultCode=0;g.decryptData=a.usWebToolkit.util.decodeUtf8(f.output.getBytes());return g}catch(h){g.resultCode=h.code,g.errMsg=h.message}return g},GetHashData:function(b,c,d){var e={},g=!1;"undefined"!=typeof d&&(g=d);c=c.toLowerCase();switch(c){case "md5":case "sha1":case "sha256":break;default:c="sha256"}try{var f=a.usWebToolkit.md.algorithms[c].create();f.start();c=b;g&&(c=a.usWebToolkit.util.encodeUtf8(b));f.update(c);e.resultCode=0;e.hashData=f.digest().toHex()}catch(h){e.resultCode=h.code,e.errMsg=h.message}return e},GetRandomData:function(b){var c=32;b&&(c=b);b={};try{b.resultCode=0,b.rendomData=a.usWebToolkit.util.bytesToHex(a.usWebToolkit.random.getBytes(c))}catch(d){b.resultCode=d.code,b.errMsg=d.message}return b},VerifyCertificate:function(b){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||document.getElementById("us-div-cert-select"))return!1;n();var c=function(a){1==b.length?b(a):(null==a&&(a=n(-1)),b(a.decryptData,a.curDevice,a.certAttrs,a.b64RValue))};a.reInitialize();var d=a.loadUI("certselect")({type:"CERT_SELECT",args:{dn:null,possibleWhale:!0},onConfirm:function(b,g,f,h,k,m,l){b=null;try{var e=a.usWebToolkit.pki.createCaStore();b=a.PFSH.GetCACerts();for(var q in b)caCert=b[q],e.addCertificate(a.usWebToolkit.pki.certificateFromBase64(caCert));var r=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[h].signcert);a.usWebToolkit.pki.verifyCertificateChain(e,r,function(b,d,e){if(!0===b){a.usWebToolkit.x509Certificate.parser(a.PFUC[h].signcert,"Base64");var f=a.usWebToolkit.x509Certificate.getcRLDistributionPoints();if(""==f)b=3060,e=a.uiUtil().getErrorMessageLang().IDS_VERIFY_CERT_ERROR_CHECKING_ISSUER_FAIL;else if(b=a.usWebToolkit.x509Certificate.crlDownload(a.usWebToolkit.usWebCMP.info.CMPUrl,f),null!=b&&""!=b){d=b;if("object"==typeof b){f=f.split("?");var g="";1<f.length&&(g=f[1]);g&&(d=b[g])}!1===a.usWebToolkit.x509Certificate.verifyCRL(e[1],a.usWebToolkit.util.decode64(d)).verify?(b=-1,e=a.uiUtil().getErrorMessageLang().IDS_VERIFY_CERT_ERROR_REVOKED):(b=0,e=a.uiUtil().getErrorMessageLang().IDS_VERIFY_CERT_OK)}else b=3060,e=a.uiUtil().getErrorMessageLang().IDS_VERIFY_CERT_ERROR_CHECKING_ISSUER_FAIL}else null!=e&&void 0!=e&&0<=e.indexOf("Certificate is not valid yet or has expired")?(b=3005,e=a.uiUtil().getErrorMessageLang().IDS_VERIFY_CERT_ERROR_EXPIRED):null!=e&&void 0!=e&&0<=e.indexOf("no parent issuer, so certificate not trusted")?(b=3060,e=a.uiUtil().getErrorMessageLang().IDS_VERIFY_CERT_ERROR_CHECKING_ISSUER_FAIL):b=-1;c(n(b,e))})}catch(p){errCode=p.code,errMsg=p.message,c(n(p.code,p.message))}setTimeout(function(){d.dispose()},10);h=pri=null},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();c(n(a.ERROR.Code,a.ERROR.Message));d.dispose()}});d.show();return!0}},GetCertInfo:function(b){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||document.getElementById("us-div-cert-select"))return!1;var c=n();a.reInitialize();var d=a.loadUI("certselect")({type:"CERT_SELECT",args:{dn:null,possibleWhale:!0},onConfirm:function(a,g,f,h,k,m,l){c.info=f;b(c);setTimeout(function(){d.dispose()},10)},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();b(n(a.ERROR.Code,a.ERROR.Message));d.dispose()}});d.show();return!0}},SignP7File:function(b){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{var c=b;if(!c||document.getElementById("us-div-cert-select")||document.getElementById("us-div-import-cert"))return!1;var d=n();c=function(a){1==b.length?b(a):(null==a&&(a=n(-1)),b(a.signedData,a.curDevice,a.certAttrs,a.b64RValue))};a.reInitialize();var e=function(b){var e=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7",args:{dn:null,possibleWhale:!1},onConfirm:function(f,g,h,n,q,r,p){d.certAttrs=h;if("undefined"!==typeof n&&"undefined"!==typeof q)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(r))a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_DEVICE,setTimeout(function(){e.dispose()},10);else if(r==a.CONST.__PF_M_CLOUDSIGN.device)a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_DEVICE,setTimeout(function(){e.dispose()},10);else{g=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[n].signcert);f=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(a.PFUC[n].signpri);h={};for(var k in b)try{var l=a.usWebToolkit.pkcs7.createSignedData();l.sign(a.usWebToolkit.util.decode64(b[k]),g,f,q,null,null);h[k]=a.usWebToolkit.pkcs7.messageToBase64(l)}catch(z){h[k]=""}d.signedData=h;c(d);setTimeout(function(){e.dispose()},10);n=q=g=f=null}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();c(n(a.ERROR.Code,a.ERROR.Message));e.dispose()}});e.show()},g=a.loadUI("importfile")({type:"importcert",args:null,onConfirm:function(a){g.dispose();for(var b={},c=0;c<a.length;c++)b[a[c].name]=a[c].data;e(b)},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();c(n(a.ERROR.Code,a.ERROR.Message));g.dispose()}});g.show();return!0}},VerifyFileSignedDataP7:function(b,c){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b)return null;n();a.reInitialize();var d=null,e={},g;for(g in b)try{d=a.usWebToolkit.pkcs7.messageFromBase64(b[g]),d.verify(),e[g]=d.verifyResult?d.content.data:""}catch(f){a.ERROR.Code=f.code,a.ERROR.Message=f.message,e[g]=""}c(e);return!0}},SignP1File:function(b){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!b||document.getElementById("us-div-cert-select")||document.getElementById("us-div-import-cert"))return!1;var c=n(),d=function(a){1==b.length?b(a):(null==a&&(a=n()),b(a.signedData,a.theCert,a.theDN))};a.reInitialize();var e=function(b){var e=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P1",args:{dn:null,possibleWhale:!1},onConfirm:function(f,g,h,n,q,r,p){c.theCert=f;c.theDN=g;if("undefined"!==typeof n&&"undefined"!==typeof q)if(4&a.ESVS.Mode&&!a.uiUtil().isItPFDevice(r))a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_DEVICE,setTimeout(function(){e.dispose()},10),d(c);else if(r==a.CONST.__PF_M_CLOUDSIGN.device)a.ERROR.Code=-1,a.ERROR.Message=a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_SUPPORT_DEVICE,setTimeout(function(){e.dispose()},10),d(c);else{f=a.usWebToolkit.pki.certificateFromBase64(a.PFUC[n].signcert);n=a.usWebToolkit.pkcs8.decryptRsaPrivateKeyFromBase64(a.PFUC[n].signpri,q);q=ra(f);f={};g={};for(var k in b){g[k]=b[k];try{q.update(b[k]);var l=n.sign(q);f[k]=a.usWebToolkit.util.encode64(l)}catch(z){a.ERROR.Code=z.code,a.ERROR.Message=z.message,f[k]=""}}c.signedData=f;c.plainData=g;d(c);setTimeout(function(){e.dispose()},10);n=q=f=pri=null}},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();d(n(a.ERROR.Code,a.ERROR.Message));e.dispose()}});e.show()},g=a.loadUI("importfile")({type:"importcert",args:null,onConfirm:function(a){g.dispose();for(var b={},c=0;c<a.length;c++)b[a[c].name]=a[c].data;e(b)},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();d(n(a.ERROR.Code,a.ERROR.Message));g.dispose()}});g.show();return!0}},VerifyFileSignedDataP1:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{b&&c&&d||e(-1);a.reInitialize();d=a.usWebToolkit.pki.certificateFromBase64(d);var g=ra(d),f={},h;for(h in c){var k=a.usWebToolkit.util.decode64(c[h]);g.update(b[h]);try{f[h]=d.publicKey.verify(g.digest().getBytes(),k)}catch(m){a.ERROR.Code=m.code,a.ERROR.Message=m.message,f[h]=!1}}resultObject=f;e(resultObject);return!0}},SymmetricKeyEncryptFile:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!e||document.getElementById("us-div-import-cert"))return!1;var g=n(),f=b.toLowerCase();switch(f){case "3des":f="des";case "aes":case "seed":case "des":break;default:f="seed"}var h=a.loadUI("importfile")({type:"importcert",args:null,onConfirm:function(b){for(var k={},l=0;l<b.length;l++)if(0==b[l].data.length)k[b[l].name]="";else try{var n=a.usWebToolkit.cipher.algorithms[f].startEncrypting(a.usWebToolkit.util.hexToBytes(c),a.usWebToolkit.util.hexToBytes(d));n.update(a.usWebToolkit.util.createBuffer(b[l].data));n.finish();k[b[l].name]=a.usWebToolkit.util.encode64(n.output.getBytes())}catch(q){k[b[l].name]=""}g.encryptData=k;h.dispose();e(g)},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message));h.dispose()}});h.show()}},SymmetricKeyDecryptFile:function(b,c,d,e,g){var f={};c=c.toLowerCase();switch(c){case "3des":c="des";case "aes":case "seed":case "des":break;default:c="seed"}try{var h={},k;for(k in b){var m=a.usWebToolkit.cipher.algorithms[c].startDecrypting(a.usWebToolkit.util.hexToBytes(d),a.usWebToolkit.util.hexToBytes(e));m.update(a.usWebToolkit.util.createBuffer(a.usWebToolkit.util.decode64(b[k])));m.finish();h[k]=m.output.getBytes();g&&a.fileUtil().save(k,h[k].toArrayBuffer())}f.resultCode=0;f.decryptData=h;return f}catch(l){f.resultCode=l.code,f.resultMessage=l.message}return f},EncryptDataP1:function(b,c,d){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!d||!c&&document.getElementById("us-div-cert-select"))return!1;var e=n(),g=a.usWebToolkit.util.encodeUtf8(b);if(c&&"string"==typeof c){try{var f=a.usWebToolkit.x509Certificate.parser(c,"Base64");e.encryptData=a.usWebToolkit.util.encode64(f.publicKey.encrypt(g))}catch(k){a.ERROR.Message=e.resultCode=k.code,a.ERROR.Code=e.resultMessage=k.message}d(e)}else{var h=a.loadUI("certselect")({type:"CERT_SELECT",args:{dn:null},onConfirm:function(b,c,f,n,q,r,p){if(!a.PFUC[n].kmcert)return h.dispose(),a.ERROR.Message=e.resultMessage=a.uiUtil().getErrorMessageLang().IDS_NO_KMCERT,a.ERROR.Code=e.resultCode=3109E4,d(e),!1;b=h;try{var k=a.usWebToolkit.x509Certificate.parser(a.PFUC[n].kmcert,"Base64");e.encryptData=a.usWebToolkit.util.encode64(k.publicKey.encrypt(g))}catch(w){a.ERROR.Message=e.resultCode=w.code,a.ERROR.Code=e.resultMessage=w.message}b.dispose();d(e)},onCancel:function(){h.dispose();a.uiUtil().getUserCancelErrCodeNMsg();d(n(a.ERROR.Code,a.ERROR.Message))}});h.show()}}},DecryptDataP1:function(b,c,d,e){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!e||!c&&document.getElementById("us-div-cert-select"))return!1;var g=n();if(c&&"string"==typeof c&&d){try{var f=a.usWebToolkit.util.decode64(b),h=a.usWebToolkit.pkcs8.decryptRsaPrivateKeyFromBase64(c,d);g.decryptData=a.usWebToolkit.util.decodeUtf8(h.decrypt(f))}catch(m){a.ERROR.Message=g.resultCode=m.code,a.ERROR.Code=g.resultMessage=m.message}e(g)}else{var k=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P1",args:{dn:null},onConfirm:function(c,d,f,h,n,p,v){if(!a.PFUC[h].kmpri)return k.dispose(),a.ERROR.Message=g.resultMessage=a.uiUtil().getErrorMessageLang().IDS_NO_KMCERT,a.ERROR.Code=g.resultCode=3109E4,e(g),!1;c=k;try{var l=a.usWebToolkit.util.decode64(b),m=a.usWebToolkit.pkcs8.decryptRsaPrivateKeyFromBase64(a.PFUC[h].kmpri,n);g.decryptData=a.usWebToolkit.util.decodeUtf8(m.decrypt(l))}catch(B){a.ERROR.Message=g.resultCode=B.code,a.ERROR.Code=g.resultMessage=B.message}c.dispose();e(g)},onCancel:function(){k.dispose();a.uiUtil().getUserCancelErrCodeNMsg();e(n(a.ERROR.Code,a.ERROR.Message))}});k.show()}}},CertTransferV2:function(b,c){function d(b,c){a.ERROR.Code=b;a.ERROR.Message=c;a.errPopup(a.ERROR.Code,a.ERROR.Message)}function e(b,c,d){k.defaultdevice&&(u.Media.defaultdevice=k.defaultdevice);k.list&&(u.Media.list=k.list.slice());a.ESVS.Media=u.Media;d&&d.dispose();c&&268500992!=b&&-1207!=b&&-1208!=b&&a.nimservice().AbnormalFinalize(c,function(a,b){})}function g(b,c,d){k.defaultdevice&&(u.Media.defaultdevice=k.defaultdevice);k.list&&(u.Media.list=k.list.slice());a.ESVS.Media=u.Media;d&&d.dispose();c&&268500992!=b&&a.nimservice().Finalize(c,function(a,b){0==a&&h&&setTimeout(function(){h(a)},0)})}if(0==a.isAvailable())return a.uiUtil().msgBox(a.transferLang().IDS_ERROR_DO_NOT_AVAILABLE),!1;var f=null,h=c?c:null,k={};k.defaultdevice=a.ESVS.Media.defaultdevice;k.list=a.ESVS.Media.list.slice();if("import"==b){var m=function(b){ka||(a.ESVS.Media=6==P?u.Media={defaultdevice:"harddisk",list:"harddisk|removable|sectoken|savetoken|mobilephone|browsersign"}:u.Media={defaultdevice:"harddisk",list:"harddisk|removable|sectoken|savetoken|mobilephone"});a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_TRANSFER);a.nimservice().ImportPFX(b,function(c,f,h,k){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=c?(d(c,f),g(c,b,null)):lb(function(c){var d=c.curDevice,f=c.curDrive,l=c.pin;c=c.password;a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_SAVE);kb(h,k,d,f,l,c,function(c){var d=c.resultCode;c=c.resultMessage;a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=d?(a.uiUtil().errMsgBox(c,d),e(d,b,null)):(a.uiUtil().msgBox(a.transferLang().IDS_SUC_DONE),g(d,b,null))})},function(){a.uiUtil().msgBox(a.transferLang().IDS_CANCEL_SAVING);e(-1,b,null)})})};a.nimservice()?(b=J({eval:!1,intergrity:!1,name:"license",url:a.ESVS.License}),null==b&&(b="Fail to load license"),ImportingDialog=a.loadUI("certimport")({type:null,args:{license:b},onConfirm:function(b,c){ImportingDialog.dispose();a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_SENDRECEIVER);a.nimservice().SendReceiverInfo(c,16,b,function(b,f){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=b?(d(b,f),e(b,c,null)):m(c)})},onCancel:function(){ImportingDialog.dispose();d(-1);c&&setTimeout(function(){c(-1)},0)}}),ImportingDialog.show()):a.uiUtil().msgBox(a.transferLang().IDS_ERR_NIMSERVICE_UNLOAD)}else{var l=function(b,c,f,k,l,m){a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_TRANSFER);a.nimservice().GetPassword(c,function(n,p,q){0==n?jb(f,l,m,q,k,function(f){var k=f.resultCode,l=f.resultMessage;0!=k?(-2!=k&&a.errPopup(k,l),e(k,c,b),a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"),999==k&&h?setTimeout(function(){h(-1)},0):-2==k&&h&&setTimeout(function(){h(-2)},0)):a.nimservice().ExportPFX(c,q,f.pfx,function(f,h){0!=f?(d(f,h),e(f,c,b)):(a.uiUtil().msgBox(a.transferLang().IDS_SUC_DONE),g(f,c,b));a.uiUtil().createLoadingBox("hide","us-div-loading-dialog")})}):(a.errPopup(n,p),e(n,c,b),a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"))})},n=function(b,c){a.nimservice().GetSenderInfoMsg(b,function(f,g,k){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=f?(d(f,g),e(f,b,null)):(ka||(a.ESVS.Media=6==P?u.Media={defaultdevice:"harddisk",list:"harddisk|removable|browsersign"}:u.Media={defaultdevice:"harddisk",list:"harddisk|removable"}),Gb("DIGITAL_SIGNATURE_P7_EXT_DISABLE_SECTOKEN",null,k,null,function(f){0!=f.resultCode?(-2!=f.resultCode&&d(f.resultCode,f.resultMessage),e(f.resultCode,b,null),999==f.resultCode&&h?setTimeout(function(){h(-1)},0):-2==f.resultCode&&h&&setTimeout(function(){h(-2)},0)):(a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_GETCERTNUM),a.nimservice().GetCertNum(b,f.signedData,function(g,h,k){0!=g?(d(g,h),e(g,b,null),a.uiUtil().createLoadingBox("hide","us-div-loading-dialog")):a.nimservice().GetQRCodeData(b,k,function(g,h,l){0!=g||0>=l.length?(a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"),0==g?d(-1305,a.transferLang().IDS_ERR_NETWORK):d(g,h),e(g,b,null)):c(g,h,k,l,f.certIndex,f.password,f.curDevice,f.curDrive)})}))},function(){d(-1);e(-1,b,null)}))})},q=function(b,e,f){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");ExportingDialog=a.loadUI("certexport")({type:null,args:{authNum:e,qrCodeData:f},onConfirm:null,onCancel:function(){r(b,ExportingDialog);d(-1);c&&setTimeout(function(){c(-1)},0);ExportingDialog=null}});ExportingDialog.show();return ExportingDialog},r=function(b,c){canceled=!0;c&&c.dispose();b&&a.nimservice().Stop(b,function(a,c){b=null})};a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_INIT);b=J({eval:!1,intergrity:!1,name:"license",url:a.ESVS.License});null==b&&(b="Fail to load license");a.nimservice().Init(a.ESVS.TransServerIP,a.ESVS.TransServerPort,b,function(b,c,g){0!=b?(a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"),d(b,c),e(b,g,null)):(f=g,n(f,function(b,c,h,k,m,n,p,r){var t=q(f,h,k);a.nimservice().AsyncWaitForReceiver(g,function(b,c,f,h,k,q){0!=b?0==canceled&&(d(b,c),e(b,g,t)):a.ESVS.TransCfmWindowFlag?confirm("["+k+"] "+a.transferLang().IDS_CFM_DEVICE)?l(t,g,m,n,p,r):(d(-1),e(b,g,t)):l(t,g,m,n,p,r)})}))})}},CertTransferV1:function(b,c){function d(b,c){a.ERROR.Code=b;a.ERROR.Message=c;a.errPopup(a.ERROR.Code,a.ERROR.Message)}function e(b,c,d){m.defaultdevice&&(u.Media.defaultdevice=m.defaultdevice);m.list&&(u.Media.list=m.list.slice());a.ESVS.Media=u.Media;d&&d.dispose();c&&268500992!=b&&-1207!=b&&-1208!=b&&a.nimservice().AbnormalFinalize(c,function(a,b){});k&&setTimeout(function(){k(b)},0)}function g(b,c,d){m.defaultdevice&&(u.Media.defaultdevice=m.defaultdevice);m.list&&(u.Media.list=m.list.slice());a.ESVS.Media=u.Media;d&&d.dispose();c&&268500992!=b&&a.nimservice().Finalize(c,function(a,b){});k&&setTimeout(function(){k(b)},0)}function f(b,c,f){ka||(a.ESVS.Media=6==P?u.Media={defaultdevice:"harddisk",list:"harddisk|removable|sectoken|savetoken|mobilephone|browsersign"}:u.Media={defaultdevice:"harddisk",list:"harddisk|removable|sectoken|savetoken|mobilephone"});a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_TRANSFER);a.nimservice().ImportPFXEx(b,1,function(c,f,h,k){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=c?(d(c,f),g(c,b,null)):lb(function(c){a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_SAVE);kb(h,k,c.curDevice,c.curDrive,c.pin,c.password,function(c){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=c.resultCode?(d(c.resultCode,c.resultMessage),e(c.resultCode,b,null)):(a.uiUtil().msgBox(a.transferLang().IDS_SUC_DONE),g(c.resultCode,b,null))})},function(){a.uiUtil().msgBox(a.transferLang().IDS_CANCEL_SAVING);e(-1,b,null)})})}function h(b,c,f){a.nimservice().GetPassword(b,function(c,f,h){0==c?(ka||(a.ESVS.Media=6==P?u.Media={defaultdevice:"harddisk",list:"harddisk|removable|browsersign"}:u.Media={defaultdevice:"harddisk",list:"harddisk|removable"}),jb(-1,-1,-1,h,"",function(c){0!=c.resultCode?(d(c.resultCode,c.resultMessage),e(c.resultCode,b,null)):(a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_TRANSFER),a.nimservice().ExportPFXEx(b,1,c.pfx,h,function(c,e){0!=c?d(c,e):a.uiUtil().msgBox(a.transferLang().IDS_SUC_DONE);g(c,b,null);a.uiUtil().createLoadingBox("hide","us-div-loading-dialog")}))})):(d(c,f),e(c,b,null),a.uiUtil().createLoadingBox("hide","us-div-loading-dialog"))})}if(0==a.isAvailable())return a.uiUtil().msgBox(a.transferLang().IDS_ERROR_DO_NOT_AVAILABLE),!1;var k=c?c:null,m={};m.defaultdevice=a.ESVS.Media.defaultdevice;m.list=a.ESVS.Media.list.slice();c=J({eval:!1,intergrity:!1,name:"license",url:a.ESVS.License});null==c&&(c="Fail to load license");ImportingDialog=a.loadUI("certimport")({type:null,args:{license:c},onConfirm:function(c,g){ImportingDialog.dispose();a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.transferLang().IDS_PROGRESS_CONNECTTOSMART);a.nimservice().ConnectToSmartPhone(g,c,function(c,k,l,m,n){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");0!=c?(d(c,k),e(c,g,null)):b!=m?(d(-2,k),e(c,g,null)):32==b?f(g,l,n):h(g,l,n)})},onCancel:function(){ImportingDialog.dispose();e(-1,null,ImportingDialog);d(-1)}});ImportingDialog.show()},ImportPfxString:function(b,c,d){if(0==a.isAvailable())a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_DO_NOT_AVAILABLE);else{if(!d||""==b||null==b||""==c||null==c)return!1;var e=c,g=n(),f=function(){a.CCPFSH().SetP12OnMemory(b,e,function(b,c,f){if(0==b)b=f.aluc[f.index],a.usWebToolkit.x509Certificate.parser(b.signcert,"Base64"),c=a.usWebToolkit.x509Certificate.getCertificatePoliciesOid(),c=a.certUtil().getIssuerEnName(c),a.CCPFSH().SaveUserCert(c,b,!0,function(a){e="";0!=a&&(g=n(a,"FAIL"))});else{switch(b){case 1E7:0<=c.indexOf("115010")?(a.uiUtil().msgBox(a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD),g=n(115010,a.uiUtil().getErrorMessageLang().IDS_ERROR_NOT_MATTCHED_PWD)):g=n(b,c);break;default:g=n(b,c)}e=""}d(g)})};a.CCPFSH().IsCCPFSHAvailable(function(b){0==b?f():a.CCPFSH().GetCCStorageHandler(a.ESVS.EncAlgo,a.ESVS.HashAlgo,a.ESVS.BSPKI,function(a,b){0==a?f():d(n(a,"FAIL"))})})}},cloudUploadCert:function(b){var c=n();a.CLOUD.getCloudCertsList(function(d){if(0!=d.resultCode)return b(d),!0;var e=a.ESVS.Media.defaultdevice;var g=a.ESVS.Media.list.slice();a.ESVS.Media=u.Media={defaultdevice:"harddisk",list:"harddisk|removable"};var f=a.loadUI("certselect")({type:"DIGITAL_SIGNATURE_P7_EXT_DISABLE_SECTOKEN",args:{dn:null,disablePolicyList:Mb},onConfirm:function(d,k,m,l,n){e&&(u.Media.defaultdevice=e);g&&(u.Media.list=g.slice());a.ESVS.Media=u.Media;var h=a.loadUI("newpin")({args:null,onConfirm:function(d){h.dispose();a.nimservice()&&a.nimservice().ExportCertString(l,n,k,m,m,function(e,f,g){c.resultCode=e;c.resultMessage=f;c.pfx=g;e=crosscert.util.decode64(g);e=crosscert.asn1.fromDer(e);e=crosscert.pkcs12.getCertNKeyFromPKCS12(e,m).getCertAndKeyFromPKCS12(m);f={};try{!e.sign.cert&&e.km.cert?(f.signcert=crosscert.pki.certificateToBase64(e.km.cert),f.signpri=crosscert.pkcs8.encryptedPrivateKeyToBase64(e.km.prikey)):(f.signcert=crosscert.pki.certificateToBase64(e.sign.cert),f.signpri=crosscert.pkcs8.encryptedPrivateKeyToBase64(e.sign.prikey)),"undefined"!==typeof e.km?(f.kmcert=crosscert.pki.certificateToBase64(e.km.cert),f.kmpri=crosscert.pkcs8.encryptedPrivateKeyToBase64(e.km.prikey)):(f.kmcert="",f.kmpri=""),a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CLOUD_UPLOAD),a.CLOUD.uploadCert(f,m,d,function(c){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");b(c)})}catch(z){a.uiUtil().errMsgBox(__lang.IDS_MSGBOX_CERT_IMPORT_ERROR,z.code)}})},onCancel:function(){e&&(u.Media.defaultdevice=e);g&&(u.Media.list=g.slice());a.ESVS.Media=u.Media;f.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg(c);b(c);h.dispose()}});h.show();setTimeout(function(){f.dispose()},10)},onCancel:function(d){e&&(u.Media.defaultdevice=e);g&&(u.Media.list=g.slice());a.ESVS.Media=u.Media;f.dispose(!0);d?c.resultCode=-2:a.uiUtil().getUserCancelErrCodeNMsg(c);b(c)}});f.show()})},cloudDeleteCert:function(b){var c=n();var d=a.ESVS.Media.defaultdevice;var e=a.ESVS.Media.list.slice();a.ESVS.Media=u.Media={defaultdevice:"cloud",list:"cloud"};var g=a.loadUI("certselect")({type:"CERT_SELECT",args:{dn:null},onConfirm:function(c,h,k,m,l,n){d&&(u.Media.defaultdevice=d);e&&(u.Media.list=e.slice());a.ESVS.Media=u.Media;a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CLOUD_DELETE);a.CLOUD.deleteCert(l,function(c){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");b(c)});setTimeout(function(){g.dispose()},10)},onCancel:function(f){d&&(u.Media.defaultdevice=d);e&&(u.Media.list=e.slice());a.ESVS.Media=u.Media;g.dispose(!0);a.uiUtil().getUserCancelErrCodeNMsg(c);b(c)}});g.show()},cloudChangePin:function(b){var c=n();var d=a.ESVS.Media.defaultdevice;var e=a.ESVS.Media.list.slice();a.ESVS.Media=u.Media={defaultdevice:"cloud",list:"cloud"};var g=a.loadUI("certselect")({type:"CERT_SELECT",args:{dn:null},onConfirm:function(f,h,k,m,l,n){d&&(u.Media.defaultdevice=d);e&&(u.Media.list=e.slice());a.ESVS.Media=u.Media;var q=a.loadUI("changepin")({type:"PIN_CLOUD",args:null,onConfirm:function(c,d){q.dispose();a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CLOUD_CHANGE_PIN);a.CLOUD.changePin(l,c,d,function(c){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");b(c)})},onCancel:function(){a.uiUtil().getUserCancelErrCodeNMsg(c);b(c);q.dispose()}});q.show();setTimeout(function(){g.dispose()},10)},onCancel:function(f){d&&(u.Media.defaultdevice=d);e&&(u.Media.list=e.slice());a.ESVS.Media=u.Media;g.dispose(!0);f?c.resultCode=-2:a.uiUtil().getUserCancelErrCodeNMsg(c);b(c)}});g.show()},CloudUnlockCert:function(b){var c=n();var d=a.ESVS.Media.defaultdevice;var e=a.ESVS.Media.list.slice();a.ESVS.Media=u.Media={defaultdevice:"cloud",list:"cloud"};var g=a.loadUI("certselect")({type:"CERT_SELECT",args:{dn:null},onConfirm:function(c,h,k,m,l,n){d&&(u.Media.defaultdevice=d);e&&(u.Media.list=e.slice());a.ESVS.Media=u.Media;a.uiUtil().createLoadingBox("show","us-div-loading-dialog",a.uiUtil().getErrorMessageLang().IDS_CLOUD_UNLOCK);a.CLOUD.unlockCertificate(l,function(c){a.uiUtil().createLoadingBox("hide","us-div-loading-dialog");b(c)});setTimeout(function(){g.dispose()},10)},onCancel:function(f){d&&(u.Media.defaultdevice=d);e&&(u.Media.list=e.slice());a.ESVS.Media=u.Media;g.dispose(!0);f?c.resultCode=-2:a.uiUtil().getUserCancelErrCodeNMsg(c);b(c)}});g.show()},cloudDisConnect:function(b){a.CLOUD.disConnect(function(a){b(a)})},cloudDeleteAccount:function(b){a.CLOUD.deleteAccount(function(a){b(a)})},cloudGetAutoConnectInfo:function(b){a.CLOUD.getAutoConnectInfo(function(a){b(a)})},cloudGetCertUseHistory:function(b){a.CLOUD.getCertificateHistory(function(a){b(a)})},cloudGetUserHistory:function(b){a.CLOUD.getUserHistory(function(a){b(a)})},cloudGetUserConnectionHistory:function(b){a.CLOUD.getConnectionHistory(function(a){b(a)})},cloudDeleteAutoConnect:function(b,c){a.CLOUD.deleteAutoConnect(b,function(a){c(a)})}}}alert("Failed to initialize Unisign Core.")};